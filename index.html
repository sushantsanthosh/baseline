<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baseline — Early Stroke Signal Detection</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&family=Space+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080f; --surface: #0d1220;
  --teal: #00e5c8; --violet: #a855f7; --blue: #3b82f6;
  --green: #22c55e; --yellow: #f59e0b; --red: #ef4444;
  --text: #e8eaf0; --muted: #6b7280;
  --cb: rgba(255,255,255,0.03); --cbord: rgba(255,255,255,0.07);
  --app-fz: 100%;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-weight:300;overflow-x:hidden;line-height:1.6;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:999;opacity:0.4;}

/* ===== BLOBS ===== */
.blob{position:fixed;border-radius:50%;filter:blur(100px);pointer-events:none;z-index:0;animation:drift 20s ease-in-out infinite;}
.blob-1{width:500px;height:500px;background:rgba(0,229,200,0.06);top:-100px;left:-100px;}
.blob-2{width:400px;height:400px;background:rgba(168,85,247,0.07);bottom:200px;right:-100px;animation-delay:-7s;}
.blob-3{width:300px;height:300px;background:rgba(59,130,246,0.05);top:50%;left:40%;animation-delay:-14s;}
@keyframes drift{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(30px,-30px) scale(1.05);}66%{transform:translate(-20px,20px) scale(0.95);}}

/* ===== NAV ===== */
nav{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:1.5rem 4rem;backdrop-filter:blur(20px);background:rgba(6,8,15,0.7);border-bottom:1px solid var(--cbord);}
.nav-logo{font-family:'DM Serif Display',serif;font-size:1.3rem;color:var(--teal);letter-spacing:-0.02em;text-shadow:0 0 20px rgba(0,229,200,0.5);}
.nav-links{display:flex;gap:2.5rem;list-style:none;}
.nav-links a{color:var(--muted);text-decoration:none;font-size:0.875rem;letter-spacing:0.05em;text-transform:uppercase;transition:color 0.3s;}
.nav-links a:hover{color:var(--text);}
.nav-cta{background:transparent;border:1px solid var(--teal);color:var(--teal);padding:0.5rem 1.5rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.875rem;cursor:pointer;transition:all 0.3s;text-shadow:0 0 10px rgba(0,229,200,0.4);box-shadow:0 0 20px rgba(0,229,200,0.1);}
.nav-cta:hover{background:rgba(0,229,200,0.1);box-shadow:0 0 30px rgba(0,229,200,0.25);}

/* ===== SHARED BTNS ===== */
section{position:relative;z-index:1;}
.btn-primary{background:var(--teal);color:var(--bg);border:none;padding:0.85rem 2.5rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:0.95rem;cursor:pointer;transition:all 0.3s;box-shadow:0 0 40px rgba(0,229,200,0.3);}
.btn-primary:hover{box-shadow:0 0 60px rgba(0,229,200,0.5);transform:translateY(-2px);}
.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--cbord);padding:0.85rem 2.5rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.95rem;cursor:pointer;transition:all 0.3s;}
.btn-ghost:hover{border-color:rgba(255,255,255,0.2);background:rgba(255,255,255,0.04);}

/* ===== HERO ===== */
.hero{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:8rem 2rem 6rem;}
.hero-eyebrow{font-family:'Space Mono',monospace;font-size:0.75rem;letter-spacing:0.2em;color:var(--teal);text-transform:uppercase;margin-bottom:2rem;opacity:0;animation:fadeUp 0.8s ease forwards 0.3s;}
.hero h1{font-family:'DM Serif Display',serif;font-size:clamp(3.5rem,8vw,7rem);line-height:1.05;letter-spacing:-0.03em;margin-bottom:1.5rem;opacity:0;animation:fadeUp 0.8s ease forwards 0.5s;}
.hero h1 em{font-style:italic;color:var(--teal);text-shadow:0 0 40px rgba(0,229,200,0.4);}
.hero-sub{font-size:clamp(1.15rem,2vw,1.4rem);color:var(--muted);max-width:560px;line-height:1.8;margin-bottom:3rem;opacity:0;animation:fadeUp 0.8s ease forwards 0.7s;}
.hero-actions{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;opacity:0;animation:fadeUp 0.8s ease forwards 0.9s;}
.waveform{display:flex;align-items:center;justify-content:center;gap:3px;height:80px;}
.bar{width:3px;background:var(--teal);border-radius:2px;opacity:0.6;animation:pulse var(--dur,1.5s) ease-in-out infinite;animation-delay:var(--delay,0s);}
@keyframes pulse{0%,100%{height:var(--min,8px);opacity:0.3;}50%{height:var(--max,40px);opacity:0.9;}}
.viz-label{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--muted);letter-spacing:0.15em;text-align:center;margin-top:1rem;}
.signal-viz{width:100%;max-width:700px;margin:5rem auto 0;opacity:0;animation:fadeUp 1s ease forwards 1.1s;}
.divider{width:1px;height:80px;background:linear-gradient(to bottom,transparent,var(--cbord),transparent);margin:0 auto;}

/* ===== SECTIONS ===== */
.section-pad{padding:7rem 4rem;}
.section-tag{font-family:'Space Mono',monospace;font-size:0.7rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--violet);margin-bottom:1rem;}
.section-title{font-family:'DM Serif Display',serif;font-size:clamp(2rem,4vw,3.5rem);letter-spacing:-0.02em;line-height:1.15;margin-bottom:1.5rem;}
.section-desc{color:var(--muted);max-width:500px;font-size:1.1rem;line-height:1.8;}
.steps-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5px;background:var(--cbord);margin-top:5rem;border:1px solid var(--cbord);border-radius:20px;overflow:hidden;}
.step{background:var(--surface);padding:3rem;transition:background 0.3s;position:relative;overflow:hidden;}
.step::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 0% 0%,var(--sg,transparent) 0%,transparent 60%);opacity:0;transition:opacity 0.4s;}
.step:hover::before{opacity:1;}.step:hover{background:#111827;}
.step:nth-child(1){--sg:rgba(0,229,200,0.07);}.step:nth-child(2){--sg:rgba(168,85,247,0.07);}.step:nth-child(3){--sg:rgba(59,130,246,0.07);}.step:nth-child(4){--sg:rgba(0,229,200,0.07);}
.step-num{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--muted);letter-spacing:0.1em;margin-bottom:1.5rem;}
.step-icon{font-size:2rem;margin-bottom:1.25rem;display:block;}
.step h3{font-family:'DM Serif Display',serif;font-size:1.5rem;margin-bottom:0.75rem;letter-spacing:-0.01em;}
.step p{color:var(--muted);font-size:1.05rem;line-height:1.8;}
.signals-section{padding:7rem 4rem;background:linear-gradient(180deg,transparent,rgba(0,229,200,0.02),transparent);}
.signals-header{display:grid;grid-template-columns:1fr 1fr;gap:4rem;align-items:end;margin-bottom:4rem;}
.signals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;}
.signal-card{background:var(--cb);border:1px solid var(--cbord);border-radius:16px;padding:2rem;transition:all 0.3s;position:relative;overflow:hidden;}
.signal-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--ac,var(--teal)),transparent);transform:scaleX(0);transition:transform 0.4s;}
.signal-card:hover::after{transform:scaleX(1);}.signal-card:hover{border-color:rgba(255,255,255,0.12);transform:translateY(-3px);}
.signal-card:nth-child(2){--ac:var(--violet);}.signal-card:nth-child(3){--ac:var(--blue);}.signal-card:nth-child(4){--ac:var(--violet);}.signal-card:nth-child(5){--ac:var(--blue);}
.signal-emoji{font-size:1.5rem;margin-bottom:1rem;}
.signal-card h4{font-family:'DM Serif Display',serif;font-size:1.1rem;margin-bottom:0.5rem;}
.signal-card p{color:var(--muted);font-size:1rem;line-height:1.7;}
.ethics-section{padding:7rem 4rem;}
.ethics-inner{background:linear-gradient(135deg,rgba(0,229,200,0.04),rgba(168,85,247,0.04));border:1px solid var(--cbord);border-radius:24px;padding:5rem;display:grid;grid-template-columns:1fr 1fr;gap:5rem;align-items:center;}
.ethics-title{font-family:'DM Serif Display',serif;font-size:clamp(2rem,3.5vw,3rem);line-height:1.15;letter-spacing:-0.02em;margin-bottom:1.5rem;}
.ethics-title em{font-style:italic;color:var(--violet);text-shadow:0 0 30px rgba(168,85,247,0.4);}
.ethics-desc{color:var(--muted);line-height:1.8;font-size:1.05rem;}
.ethics-list{display:flex;flex-direction:column;gap:1rem;}
.ethics-item{display:flex;align-items:flex-start;gap:1rem;padding:1.25rem 1.5rem;background:var(--cb);border:1px solid var(--cbord);border-radius:12px;transition:border-color 0.3s;}
.ethics-item:hover{border-color:rgba(255,255,255,0.12);}
.ethics-icon{font-size:1.1rem;flex-shrink:0;margin-top:0.1rem;}
.ethics-item-text{font-size:1rem;color:var(--text);}
.ethics-item-text span{display:block;font-size:0.9rem;color:var(--muted);margin-top:0.2rem;}
.chart-section{padding:7rem 4rem;text-align:center;}
.chart-container{max-width:800px;margin:4rem auto 0;background:var(--surface);border:1px solid var(--cbord);border-radius:24px;padding:3rem;position:relative;overflow:hidden;}
.chart-container::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--teal),transparent);}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:2rem;text-align:left;}
.chart-title{font-family:'DM Serif Display',serif;font-size:1.1rem;}
.chart-period{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--muted);letter-spacing:0.1em;}
.chart-area{height:180px;position:relative;margin-bottom:1.5rem;}
.chart-svg{width:100%;height:100%;overflow:visible;}
.chart-insight{background:rgba(0,229,200,0.05);border:1px solid rgba(0,229,200,0.15);border-radius:10px;padding:1rem 1.5rem;font-size:1rem;color:var(--teal);text-align:left;font-family:'Space Mono',monospace;letter-spacing:0.02em;}
.audience-section{padding:7rem 4rem;}
.audience-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;margin-top:4rem;}
.audience-card{border-radius:20px;padding:2.5rem;position:relative;overflow:hidden;}
.audience-card:nth-child(1){background:linear-gradient(135deg,rgba(0,229,200,0.08),rgba(0,229,200,0.02));border:1px solid rgba(0,229,200,0.15);}
.audience-card:nth-child(2){background:linear-gradient(135deg,rgba(168,85,247,0.08),rgba(168,85,247,0.02));border:1px solid rgba(168,85,247,0.15);}
.audience-card:nth-child(3){background:linear-gradient(135deg,rgba(59,130,246,0.08),rgba(59,130,246,0.02));border:1px solid rgba(59,130,246,0.15);}
.audience-big{font-family:'DM Serif Display',serif;font-size:3rem;line-height:1;margin-bottom:0.5rem;}
.audience-card:nth-child(1) .audience-big{color:var(--teal);}.audience-card:nth-child(2) .audience-big{color:var(--violet);}.audience-card:nth-child(3) .audience-big{color:var(--blue);}
.audience-card h4{font-size:1.1rem;font-weight:500;margin-bottom:0.75rem;}
.audience-card p{color:var(--muted);font-size:1rem;line-height:1.8;}
.cta-section{padding:7rem 4rem;text-align:center;}
.cta-inner{max-width:700px;margin:0 auto;}
.cta-inner h2{font-family:'DM Serif Display',serif;font-size:clamp(2.5rem,5vw,4.5rem);letter-spacing:-0.03em;line-height:1.1;margin-bottom:1.5rem;}
.cta-inner h2 em{font-style:italic;color:var(--teal);text-shadow:0 0 40px rgba(0,229,200,0.4);}
.cta-inner p{color:var(--muted);max-width:450px;margin:0 auto 3rem;line-height:1.8;font-size:1.1rem;}
footer{padding:3rem 4rem;border-top:1px solid var(--cbord);display:flex;align-items:center;justify-content:space-between;}
.footer-logo{font-family:'DM Serif Display',serif;color:var(--muted);font-size:1rem;}
.footer-note{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--muted);letter-spacing:0.1em;max-width:400px;text-align:right;line-height:1.6;}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:translateY(0);}}
.reveal{opacity:0;transform:translateY(30px);transition:opacity 0.7s ease,transform 0.7s ease;}
.reveal.visible{opacity:1;transform:none;}

/* ===== FAST APP ===== */
#fast-app{position:fixed;inset:0;z-index:500;background:var(--bg);overflow-y:auto;overflow-x:hidden;display:none;}
#fast-app.open{display:block;animation:appIn 0.5s cubic-bezier(0.16,1,0.3,1) forwards;}
@keyframes appIn{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:none;}}
@keyframes appOut{from{opacity:1;transform:none;}to{opacity:0;transform:translateY(20px);}}

.app-nav{position:sticky;top:0;z-index:200;display:flex;align-items:center;justify-content:space-between;padding:1rem 2.5rem;background:rgba(6,8,15,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--cbord);}
.app-nav-logo{font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--teal);text-shadow:0 0 20px rgba(0,229,200,0.4);}
.app-nav-sub{font-family:'Space Mono',monospace;font-size:0.6rem;color:var(--muted);letter-spacing:0.05em;}
.app-nav-right{display:flex;align-items:center;gap:0.75rem;}
.app-nav-hist{background:none;border:1px solid var(--cbord);color:var(--muted);padding:0.32rem 0.9rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.78rem;cursor:pointer;transition:all 0.2s;}
.app-nav-hist:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}
.app-badge{font-family:'Space Mono',monospace;font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);background:var(--cb);border:1px solid var(--cbord);padding:0.28rem 0.7rem;border-radius:100px;}
.app-back{display:flex;align-items:center;gap:0.4rem;color:var(--muted);font-size:0.82rem;cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;transition:color 0.2s;}
.app-back:hover{color:var(--text);}

.app-screen{display:none;min-height:calc(100vh - 60px);}
.app-screen.active{display:flex;}

/* --- HOME screen --- */
#screen-home{flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:4rem 2rem;gap:0;}
.fast-pill{display:inline-flex;align-items:center;gap:0.5rem;font-family:'Space Mono',monospace;font-size:0.67rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--teal);background:rgba(0,229,200,0.07);border:1px solid rgba(0,229,200,0.2);padding:0.38rem 1rem;border-radius:100px;margin-bottom:1.75rem;}
.fast-pill-dot{width:6px;height:6px;background:var(--teal);border-radius:50%;animation:blink 1.5s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.25;}}
.fast-title{font-family:'DM Serif Display',serif;font-size:clamp(2.8rem,7vw,5.5rem);letter-spacing:-0.03em;line-height:1.08;margin-bottom:1.25rem;}
.fast-title em{font-style:italic;color:var(--teal);text-shadow:0 0 50px rgba(0,229,200,0.35);}
.fast-sub{color:var(--muted);max-width:520px;font-size:1.1rem;line-height:1.8;margin-bottom:2.5rem;}
.fast-start-btn{display:flex;align-items:center;gap:0.75rem;background:var(--teal);color:var(--bg);border:none;padding:1rem 2.75rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:1rem;cursor:pointer;transition:all 0.3s;box-shadow:0 0 50px rgba(0,229,200,0.35);margin-bottom:1.5rem;}
.fast-start-btn:hover{box-shadow:0 0 70px rgba(0,229,200,0.55);transform:translateY(-2px);}
.fast-disclaimer{font-family:'Space Mono',monospace;font-size:0.75rem;letter-spacing:0.04em;color:var(--muted);max-width:480px;line-height:1.7;padding:0.9rem 1.4rem;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.15);border-radius:10px;margin-bottom:2.5rem;}
.fast-disclaimer strong{color:rgba(239,68,68,0.8);}
.what-is-fast{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;max-width:780px;width:100%;}
.fsc{background:var(--cb);border:1px solid var(--cbord);border-radius:14px;padding:1.4rem;text-align:left;transition:border-color 0.3s;}
.fsc:hover{border-color:rgba(255,255,255,0.12);}
.fsc-num{font-family:'Space Mono',monospace;font-size:0.63rem;color:var(--muted);letter-spacing:0.1em;margin-bottom:0.7rem;}
.fsc-icon{font-size:1.5rem;margin-bottom:0.5rem;display:block;}
.fsc-title{font-size:1rem;font-weight:500;margin-bottom:0.3rem;}
.fsc-desc{font-size:0.88rem;color:var(--muted);line-height:1.6;}

/* --- RECORD screen --- */
#screen-record{flex-direction:column;align-items:center;padding:2rem;gap:1.5rem;}
.record-layout{display:grid;grid-template-columns:1fr 300px;gap:1.75rem;width:100%;max-width:1400px;}
.camera-wrap{position:relative;border-radius:18px;overflow:hidden;background:#000;aspect-ratio:4/3;border:1px solid var(--cbord);}
.camera-wrap video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
.cam-overlay{position:absolute;inset:0;pointer-events:none;}
.face-guide{position:absolute;top:50%;left:50%;transform:translate(-50%,-55%);width:24%;aspect-ratio:3/4;border:2px solid rgba(0,229,200,0.45);border-radius:50% 50% 45% 45%;}
.fgc{position:absolute;width:13px;height:13px;border-color:var(--teal);border-style:solid;}
.fgc.tl{top:-1px;left:-1px;border-width:2px 0 0 2px;border-radius:3px 0 0 0;}
.fgc.tr{top:-1px;right:-1px;border-width:2px 2px 0 0;border-radius:0 3px 0 0;}
.fgc.bl{bottom:-1px;left:-1px;border-width:0 0 2px 2px;border-radius:0 0 0 3px;}
.fgc.br{bottom:-1px;right:-1px;border-width:0 2px 2px 0;border-radius:0 0 3px 0;}
.prompt-banner{position:absolute;top:1rem;left:50%;transform:translateX(-50%);background:rgba(6,8,15,0.85);backdrop-filter:blur(10px);border:1px solid var(--cbord);border-radius:100px;padding:0.45rem 1.2rem;font-family:'Space Mono',monospace;font-size:0.73rem;letter-spacing:0.07em;white-space:nowrap;transition:all 0.4s;}
.prompt-banner.smile{color:var(--teal);border-color:rgba(0,229,200,0.3);}
.prompt-banner.arms{color:var(--violet);border-color:rgba(168,85,247,0.3);}
.prompt-banner.speak{color:var(--blue);border-color:rgba(59,130,246,0.3);}
.prompt-banner.pause{color:var(--muted);border-color:rgba(107,114,128,0.3);animation:none;}
.rec-ind{position:absolute;top:1rem;right:1rem;display:flex;align-items:center;gap:0.4rem;font-family:'Space Mono',monospace;font-size:0.63rem;letter-spacing:0.1em;color:var(--red);opacity:0;transition:opacity 0.3s;}
.rec-ind.on{opacity:1;}
.rec-dot{width:7px;height:7px;background:var(--red);border-radius:50%;animation:blink 1s ease-in-out infinite;}
.cam-tip{position:absolute;bottom:1rem;left:50%;transform:translateX(-50%);font-family:'Space Mono',monospace;font-size:0.63rem;letter-spacing:0.07em;color:var(--muted);background:rgba(6,8,15,0.8);padding:0.32rem 0.85rem;border-radius:100px;white-space:nowrap;}

.rec-panel{display:flex;flex-direction:column;gap:1.15rem;}
.panel-box{background:var(--surface);border:1px solid var(--cbord);border-radius:15px;padding:1.4rem;}
.pb-label{font-family:'Space Mono',monospace;font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:1rem;}
.tp-tasks{display:flex;flex-direction:column;gap:0.55rem;}
.tp-task{display:flex;align-items:center;gap:0.7rem;padding:0.75rem 1rem;border-radius:9px;border:1px solid transparent;transition:all 0.3s;font-size:1rem;}
.tp-task.pending{color:var(--muted);}
.tp-task.active{background:rgba(0,229,200,0.06);border-color:rgba(0,229,200,0.2);color:var(--text);}
.tp-task.done{color:var(--muted);text-decoration:line-through;}
.tp-icon{font-size:1.15rem;width:24px;text-align:center;}
.tp-info{flex:1;}
.tp-name{font-weight:500;font-size:0.96rem;}
.tp-dur{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--muted);}
.tp-chk{font-size:1rem;}

.timer-inner{text-align:center;}
.timer-svg{width:100px;height:100px;margin:0 auto 0.6rem;display:block;}
.tr-bg{fill:none;stroke:rgba(255,255,255,0.05);stroke-width:6;}
.tr-fill{fill:none;stroke:var(--teal);stroke-width:6;stroke-linecap:round;stroke-dasharray:251.3;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear,stroke 0.5s;}
.timer-num{font-family:'DM Serif Display',serif;font-size:1.9rem;fill:var(--text);}
.timer-lbl{font-family:'Space Mono',monospace;font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);}

.bm-bar-wrap{height:5px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;margin:0.45rem 0;}
.bm-bar{height:100%;width:60%;background:linear-gradient(90deg,var(--teal),var(--blue));border-radius:3px;transition:width 0.5s;}
.bm-status{font-size:0.85rem;color:var(--teal);}

.rec-controls{display:flex;flex-direction:column;gap:0.65rem;}
.btn-rec-go{background:var(--teal);color:var(--bg);border:none;padding:0.95rem;border-radius:11px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:1rem;cursor:pointer;transition:all 0.3s;box-shadow:0 0 30px rgba(0,229,200,0.25);}
.btn-rec-go:hover{box-shadow:0 0 50px rgba(0,229,200,0.45);transform:translateY(-1px);}
.btn-rec-go:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
.btn-restart{background:transparent;border:1px solid var(--cbord);color:var(--muted);padding:0.7rem;border-radius:11px;font-family:'DM Sans',sans-serif;font-size:0.9rem;cursor:pointer;transition:all 0.2s;}
.btn-restart:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}

/* --- PROCESSING screen --- */
#screen-processing{flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:4rem 2rem;}
.proc-orb{width:110px;height:110px;border-radius:50%;margin:0 auto 2.5rem;background:radial-gradient(circle,rgba(0,229,200,0.3),rgba(0,229,200,0.04));border:1px solid rgba(0,229,200,0.3);box-shadow:0 0 60px rgba(0,229,200,0.2);animation:orbP 2s ease-in-out infinite;display:flex;align-items:center;justify-content:center;font-size:2.5rem;}
@keyframes orbP{0%,100%{box-shadow:0 0 40px rgba(0,229,200,0.2);transform:scale(1);}50%{box-shadow:0 0 80px rgba(0,229,200,0.4);transform:scale(1.05);}}
.proc-title{font-family:'DM Serif Display',serif;font-size:clamp(2rem,4vw,3rem);letter-spacing:-0.02em;margin-bottom:0.6rem;}
.proc-sub{color:var(--muted);font-size:1rem;margin-bottom:2.5rem;}
.proc-checks{display:flex;flex-direction:column;gap:0.8rem;max-width:420px;width:100%;}
.pc{display:flex;align-items:center;gap:0.9rem;padding:1rem 1.4rem;background:var(--cb);border:1px solid var(--cbord);border-radius:12px;font-size:1rem;text-align:left;transition:all 0.5s;}
.pc.running{border-color:rgba(0,229,200,0.25);background:rgba(0,229,200,0.04);}
.pc.done{border-color:rgba(34,197,94,0.2);}
.pc-icon{font-size:1.3rem;width:26px;text-align:center;}
.pc-name{font-size:0.95rem;font-weight:500;}
.pc-met{font-family:'Space Mono',monospace;font-size:0.72rem;color:var(--muted);margin-top:0.15rem;}
.spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,0.1);border-top-color:var(--teal);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}

/* --- RESULTS screen --- */
#screen-results{flex-direction:column;align-items:center;padding:2.5rem 2rem;gap:1.75rem;}
.results-wrap{width:100%;max-width:920px;}
.status-banner{border-radius:18px;padding:2.25rem 2.75rem;margin-bottom:1.75rem;display:flex;align-items:center;justify-content:space-between;gap:1.5rem;flex-wrap:wrap;}
.status-banner.green{background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(34,197,94,0.03));border:1px solid rgba(34,197,94,0.25);}
.status-banner.yellow{background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(245,158,11,0.03));border:1px solid rgba(245,158,11,0.25);}
.status-banner.red{background:linear-gradient(135deg,rgba(239,68,68,0.12),rgba(239,68,68,0.03));border:1px solid rgba(239,68,68,0.3);}
.sb-left{display:flex;align-items:center;gap:1.25rem;}
.sb-orb{width:58px;height:58px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0;}
.status-banner.green .sb-orb{background:rgba(34,197,94,0.15);box-shadow:0 0 30px rgba(34,197,94,0.2);}
.status-banner.yellow .sb-orb{background:rgba(245,158,11,0.15);box-shadow:0 0 30px rgba(245,158,11,0.2);}
.status-banner.red .sb-orb{background:rgba(239,68,68,0.15);box-shadow:0 0 30px rgba(239,68,68,0.2);}
.sb-info h2{font-family:'DM Serif Display',serif;font-size:1.65rem;letter-spacing:-0.02em;margin-bottom:0.2rem;}
.status-banner.green .sb-info h2{color:var(--green);}
.status-banner.yellow .sb-info h2{color:var(--yellow);}
.status-banner.red .sb-info h2{color:var(--red);}
.sb-info p{color:var(--muted);font-size:1rem;max-width:380px;line-height:1.6;}
.sb-score-wrap{text-align:center;}
.sb-score-lbl{font-family:'Space Mono',monospace;font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:0.2rem;}
.sb-score{font-family:'DM Serif Display',serif;font-size:2.4rem;line-height:1;}
.status-banner.green .sb-score{color:var(--green);}
.status-banner.yellow .sb-score{color:var(--yellow);}
.status-banner.red .sb-score{color:var(--red);}

.metric-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:1.15rem;margin-bottom:1.75rem;}
.mc{background:var(--surface);border:1px solid var(--cbord);border-radius:16px;padding:1.6rem;position:relative;overflow:hidden;}
.mc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--mcc,var(--teal)),transparent);}
.mc.face{--mcc:var(--teal);}.mc.arms{--mcc:var(--violet);}.mc.speech{--mcc:var(--blue);}
.mc-hd{display:flex;align-items:center;gap:0.7rem;margin-bottom:1.1rem;}
.mc-ico{font-size:1.25rem;}
.mc-ttl{font-family:'DM Serif Display',serif;font-size:1.05rem;letter-spacing:-0.01em;}
.mc-badge{margin-left:auto;font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:0.08em;padding:0.18rem 0.55rem;border-radius:100px;}
.mc-badge.ok{background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.2);}
.mc-badge.warn{background:rgba(245,158,11,0.1);color:var(--yellow);border:1px solid rgba(245,158,11,0.2);}
.mc-badge.alert{background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2);}
.mc-metric-lbl{font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:0.2rem;}
.mc-val{font-family:'DM Serif Display',serif;font-size:1.55rem;letter-spacing:-0.02em;line-height:1;}
.mc-unit{font-size:0.72rem;color:var(--muted);font-family:'DM Sans',sans-serif;margin-left:0.2rem;}
.mc-unit-warn{font-size:0.82rem;color:var(--muted);font-style:italic;margin-left:0;}
.mc-chart{height:70px;margin:0.85rem 0;position:relative;}
.mc-chart svg{width:100%;height:100%;overflow:visible;}
@keyframes chartDraw{from{stroke-dashoffset:var(--chart-len,800);}to{stroke-dashoffset:0;}}
@keyframes chartFadeIn{from{opacity:0;}to{opacity:1;}}
.mc-chart-line{stroke-dasharray:var(--chart-len,800);stroke-dashoffset:var(--chart-len,800);animation:chartDraw 1.2s cubic-bezier(0.4,0,0.2,1) forwards;}
.mc-chart-fill{opacity:0;animation:chartFadeIn 0.6s ease forwards 0.8s;}
.mc-chart-dot{opacity:0;animation:chartFadeIn 0.4s ease forwards var(--dot-delay,1s);}
.mc-explain{font-size:0.9rem;color:var(--muted);line-height:1.65;padding-top:0.7rem;border-top:1px solid var(--cbord);}
.mc-explain strong{color:var(--text);font-weight:500;}

.previews-row{display:grid;grid-template-columns:1fr 1fr;gap:1.15rem;margin-bottom:1.75rem;}
.preview-card{background:var(--surface);border:1px solid var(--cbord);border-radius:15px;padding:1.4rem;}
.preview-title{font-family:'Space Mono',monospace;font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:0.9rem;}
.preview-canvas{position:relative;width:100%;aspect-ratio:16/9;background:#080c17;border-radius:9px;overflow:hidden;}
.preview-canvas canvas{position:absolute;inset:0;width:100%;height:100%;}

.action-panel{border-radius:16px;padding:1.75rem 2.25rem;display:flex;align-items:center;justify-content:space-between;gap:1.5rem;flex-wrap:wrap;}
.action-panel.green{background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.15);}
.action-panel.yellow{background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.2);}
.action-panel.red{background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.25);}
.act-text h4{font-family:'DM Serif Display',serif;font-size:1.2rem;margin-bottom:0.35rem;}
.act-text p{color:var(--muted);font-size:0.95rem;line-height:1.7;max-width:440px;}
.act-btns{display:flex;gap:0.7rem;flex-wrap:wrap;}
.act-btn-p{padding:0.65rem 1.5rem;border-radius:100px;border:none;font-family:'DM Sans',sans-serif;font-weight:500;font-size:0.9rem;cursor:pointer;transition:all 0.3s;}
.action-panel.green .act-btn-p{background:var(--green);color:#000;}
.action-panel.yellow .act-btn-p{background:var(--yellow);color:#000;}
.action-panel.red .act-btn-p{background:var(--red);color:#fff;}
.act-btn-s{padding:0.65rem 1.5rem;border-radius:100px;background:transparent;border:1px solid var(--cbord);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:0.9rem;cursor:pointer;transition:all 0.2s;}
.act-btn-s:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}

/* --- HISTORY screen --- */
#screen-history{flex-direction:column;align-items:center;padding:2.5rem 2rem 6rem;gap:1.75rem;}
.history-wrap{width:100%;max-width:840px;}
.hist-hd-title{font-family:'DM Serif Display',serif;font-size:1.9rem;letter-spacing:-0.02em;margin-bottom:0.4rem;}
.hist-hd-sub{color:var(--muted);font-size:1rem;}
.hcc{background:var(--surface);border:1px solid var(--cbord);border-radius:16px;padding:1.75rem;margin-bottom:1.4rem;position:relative;overflow:hidden;}
.hcc::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--teal),transparent);}
.hcc-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;}
.hcc-title{font-family:'DM Serif Display',serif;font-size:1.05rem;}
.hcc-period{font-family:'Space Mono',monospace;font-size:0.63rem;color:var(--muted);letter-spacing:0.1em;}
.hcc-area{height:180px;}
.hcc-area svg{width:100%;height:100%;overflow:visible;}
.hmc-area{height:100px;}
/* Chart dot pulse on hover */
.chart-dot-glow{filter:drop-shadow(0 0 4px currentColor);transition:r 0.2s,filter 0.2s;}
.hist-entries{display:flex;flex-direction:column;gap:0.7rem;}
.he{display:flex;align-items:center;gap:1.1rem;padding:0.95rem 1.4rem;background:var(--cb);border:1px solid var(--cbord);border-radius:13px;transition:border-color 0.2s;cursor:pointer;}
.he:hover{border-color:rgba(255,255,255,0.12);}
.he-date{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--muted);min-width:80px;}
.he-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.he-dot.green{background:var(--green);box-shadow:0 0 8px rgba(34,197,94,0.5);}
.he-dot.yellow{background:var(--yellow);box-shadow:0 0 8px rgba(245,158,11,0.5);}
.he-dot.red{background:var(--red);box-shadow:0 0 8px rgba(239,68,68,0.5);}
.he-scores{display:flex;gap:1.4rem;flex:1;}
.he-sc{text-align:center;}
.he-sc-lbl{font-family:'Space Mono',monospace;font-size:0.57rem;letter-spacing:0.07em;text-transform:uppercase;color:var(--muted);}
.he-sc-v{font-family:'DM Serif Display',serif;font-size:1.05rem;}
.he-lbl{font-size:0.78rem;font-weight:500;margin-left:auto;}
.he-lbl.green{color:var(--green);}.he-lbl.yellow{color:var(--yellow);}.he-lbl.red{color:var(--red);}
.hist-empty{text-align:center;padding:3.5rem;color:var(--muted);}
.hist-empty h3{font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:0.4rem;color:var(--text);}

/* ===== BASELINE STYLES ===== */
.baseline-gate{display:flex;flex-direction:column;align-items:center;text-align:center;gap:0;}
.baseline-needed-card{background:linear-gradient(135deg,rgba(0,229,200,0.06),rgba(168,85,247,0.04));border:1px solid rgba(0,229,200,0.18);border-radius:20px;padding:2.5rem 3rem;max-width:560px;width:100%;margin-bottom:2rem;}
.baseline-needed-card h3{font-family:'DM Serif Display',serif;font-size:1.6rem;letter-spacing:-0.02em;margin-bottom:0.6rem;}
.baseline-needed-card p{color:var(--muted);font-size:0.875rem;line-height:1.75;}
.baseline-set-card{background:rgba(0,229,200,0.04);border:1px solid rgba(0,229,200,0.2);border-radius:16px;padding:1.5rem 2rem;max-width:560px;width:100%;margin-bottom:2rem;display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;}
.bsc-icon{font-size:2rem;flex-shrink:0;}
.bsc-info{flex:1;}
.bsc-title{font-family:'Space Mono',monospace;font-size:0.65rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--teal);margin-bottom:0.3rem;}
.bsc-date{font-size:0.8rem;color:var(--muted);margin-bottom:0.75rem;}
.bsc-scores{display:flex;gap:1.25rem;}
.bsc-score{text-align:center;}
.bsc-score-lbl{font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);}
.bsc-score-v{font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--teal);}
.bsc-rerecord{background:none;border:1px solid var(--cbord);color:var(--muted);padding:0.3rem 0.85rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.75rem;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.bsc-rerecord:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}
.fast-check-locked{display:flex;align-items:center;gap:0.6rem;color:var(--muted);font-size:0.8rem;font-family:'Space Mono',monospace;letter-spacing:0.06em;padding:0.75rem 1.5rem;border:1px solid var(--cbord);border-radius:100px;cursor:not-allowed;margin-bottom:1.5rem;}

/* Baseline result banner */
.status-banner.baseline{background:linear-gradient(135deg,rgba(0,229,200,0.1),rgba(0,229,200,0.03));border:1px solid rgba(0,229,200,0.3);}
.status-banner.baseline .sb-info h2{color:var(--teal);}
.status-banner.baseline .sb-score{color:var(--teal);}
.status-banner.baseline .sb-orb{background:rgba(0,229,200,0.15);box-shadow:0 0 30px rgba(0,229,200,0.2);}

/* Delta chips on metric cards */
.delta-row{display:flex;align-items:center;gap:0.6rem;margin-top:0.6rem;padding-top:0.6rem;border-top:1px solid var(--cbord);flex-wrap:wrap;}
.delta-lbl{font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);}
.delta-chip{display:inline-flex;align-items:center;gap:0.25rem;font-family:'Space Mono',monospace;font-size:0.68rem;padding:0.15rem 0.55rem;border-radius:100px;font-weight:500;}
.delta-chip.up{background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2);}
.delta-chip.down{background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.2);}
.delta-chip.flat{background:rgba(255,255,255,0.04);color:var(--muted);border:1px solid var(--cbord);}
.delta-baseline-val{font-size:0.7rem;color:var(--muted);}

/* History baseline pin */
.he.baseline-entry{border-color:rgba(0,229,200,0.25);background:rgba(0,229,200,0.03);}
.he-baseline-tag{font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--teal);background:rgba(0,229,200,0.08);border:1px solid rgba(0,229,200,0.2);padding:0.18rem 0.55rem;border-radius:100px;white-space:nowrap;}

/* Record screen baseline mode banner */
.rec-mode-banner{text-align:center;padding:0.6rem 1.5rem;background:rgba(0,229,200,0.06);border:1px solid rgba(0,229,200,0.2);border-radius:10px;font-family:'Space Mono',monospace;font-size:0.68rem;letter-spacing:0.1em;color:var(--teal);margin-bottom:1rem;}

/* Countdown overlay on camera */
.countdown-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(6,8,15,0.55);backdrop-filter:blur(2px);z-index:10;pointer-events:none;opacity:0;transition:opacity 0.2s;}
.countdown-overlay.visible{opacity:1;}
.countdown-num{font-family:'DM Serif Display',serif;font-size:9rem;color:#fff;text-shadow:0 0 60px rgba(0,229,200,0.8),0 0 20px rgba(0,229,200,0.5);line-height:1;animation:cntPop 0.35s cubic-bezier(0.175,0.885,0.32,1.275) forwards;}
@keyframes cntPop{from{transform:scale(0.4);opacity:0;}to{transform:scale(1);opacity:1;}}

/* ── RESULTS ENTRANCE ANIMATIONS ── */
@keyframes cardSlideUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:none;}}
@keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
@keyframes orbPulseResult{0%,100%{transform:scale(1);box-shadow:0 0 20px var(--orb-glow,rgba(34,197,94,0.2));}50%{transform:scale(1.06);box-shadow:0 0 40px var(--orb-glow,rgba(34,197,94,0.4));}}
.mc{animation:cardSlideUp 0.5s cubic-bezier(0.4,0,0.2,1) both;}
.mc:nth-child(1){animation-delay:0.05s;}
.mc:nth-child(2){animation-delay:0.12s;}
.mc:nth-child(3){animation-delay:0.19s;}
.status-banner.green{--orb-glow:rgba(34,197,94,0.35);}
.status-banner.yellow{--orb-glow:rgba(245,158,11,0.35);}
.status-banner.red{--orb-glow:rgba(239,68,68,0.35);}
.sb-orb{animation:orbPulseResult 2.5s ease-in-out infinite;}

/* ── HISTORY ENTRY STAGGER ── */
@keyframes heSlideIn{from{opacity:0;transform:translateX(-12px);}to{opacity:1;transform:none;}}

/* ── PROCESSING ORB SHIMMER ── */
.proc-orb::after{content:'';position:absolute;inset:-2px;border-radius:50%;background:conic-gradient(from 0deg,transparent 60%,rgba(0,229,200,0.4) 100%);animation:spin 3s linear infinite;z-index:-1;}
.proc-orb{position:relative;}
.sq-panel{background:var(--surface);border:1px solid var(--cbord);border-radius:15px;padding:1.25rem 1.4rem;margin-top:0.75rem;}
.sq-panel-lbl{font-family:'Space Mono',monospace;font-size:0.68rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted);margin-bottom:0.85rem;}
.sq-rows{display:flex;flex-direction:column;gap:0.55rem;}
.sq-row{display:flex;align-items:center;gap:0.65rem;font-size:0.92rem;}
.sq-icon{width:20px;text-align:center;font-size:0.95rem;flex-shrink:0;}
.sq-label{flex:1;font-size:0.88rem;color:var(--text);}
.sq-status{font-family:'Space Mono',monospace;font-size:0.68rem;padding:0.15rem 0.5rem;border-radius:100px;white-space:nowrap;}
.sq-status.good{background:rgba(34,197,94,0.12);color:var(--green);border:1px solid rgba(34,197,94,0.2);}
.sq-status.warn{background:rgba(245,158,11,0.12);color:var(--yellow);border:1px solid rgba(245,158,11,0.2);}
.sq-status.bad{background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2);}
.sq-tip{font-family:'Space Mono',monospace;font-size:0.64rem;color:var(--muted);margin-top:0.25rem;line-height:1.5;padding-left:1.7rem;}

/* Quality Gate Decision Overlay */
.qg-overlay{position:fixed;inset:0;z-index:600;background:rgba(6,8,15,0.88);backdrop-filter:blur(18px);display:flex;align-items:center;justify-content:center;padding:2rem;animation:fadeUp 0.35s ease;}
.qg-box{background:var(--surface);border:1px solid var(--cbord);border-radius:22px;padding:2.5rem 3rem;max-width:460px;width:100%;text-align:center;position:relative;}
.qg-box::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--ac,var(--teal)),transparent);}
.qg-icon{font-size:2.8rem;margin-bottom:1.25rem;}
.qg-title{font-family:'DM Serif Display',serif;font-size:1.65rem;letter-spacing:-0.02em;margin-bottom:0.5rem;}
.qg-desc{color:var(--muted);font-size:0.85rem;line-height:1.7;margin-bottom:1.5rem;}
.qg-score-row{display:flex;justify-content:center;gap:1.5rem;margin-bottom:1.75rem;padding:1rem 1.5rem;background:var(--cb);border:1px solid var(--cbord);border-radius:12px;}
.qg-score-item{text-align:center;}
.qg-score-lbl{font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);margin-bottom:0.2rem;}
.qg-score-v{font-family:'DM Serif Display',serif;font-size:1.2rem;}
.qg-score-v.good{color:var(--green);}.qg-score-v.warn{color:var(--yellow);}.qg-score-v.bad{color:var(--red);}
.qg-btns{display:flex;flex-direction:column;gap:0.65rem;}
.qg-proceed{background:var(--teal);color:var(--bg);border:none;padding:0.75rem 2rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:0.875rem;cursor:pointer;transition:all 0.3s;}
.qg-proceed:hover{box-shadow:0 0 30px rgba(0,229,200,0.35);}
.qg-proceed.yellow{background:var(--yellow);}
.qg-retake{background:transparent;border:1px solid var(--cbord);color:var(--muted);padding:0.75rem 2rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.875rem;cursor:pointer;transition:all 0.2s;}
.qg-retake:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}
.qg-ethos{font-family:'Space Mono',monospace;font-size:0.6rem;color:var(--muted);letter-spacing:0.06em;margin-top:1.25rem;line-height:1.6;padding:0.75rem 1rem;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--cbord);}

/* ===== BASELINE CONFIDENCE METER ===== */
.bc-pill{display:inline-flex;align-items:center;gap:0.45rem;font-family:'Space Mono',monospace;font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;padding:0.28rem 0.75rem 0.28rem 0.45rem;border-radius:100px;cursor:default;position:relative;transition:all 0.3s;}
.bc-pill.low{background:rgba(245,158,11,0.1);color:var(--yellow);border:1px solid rgba(245,158,11,0.25);}
.bc-pill.medium{background:rgba(59,130,246,0.1);color:#60a5fa;border:1px solid rgba(59,130,246,0.25);}
.bc-pill.high{background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.25);}
.bc-pill.verified{background:rgba(0,229,200,0.12);color:var(--teal);border:1px solid rgba(0,229,200,0.35);}

/* Confidence ring — inline arc replaces dot */
.bc-ring-svg{display:block;flex-shrink:0;overflow:visible;}
.bc-ring-track{fill:none;stroke:rgba(255,255,255,0.08);stroke-width:3;}
.bc-ring-fill{fill:none;stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset 1.1s cubic-bezier(0.4,0,0.2,1);}
.bc-ring-tip{transition:all 1.1s cubic-bezier(0.4,0,0.2,1);}
.bc-pill.low    .bc-ring-fill{stroke:var(--yellow);}
.bc-pill.medium .bc-ring-fill{stroke:#60a5fa;}
.bc-pill.high   .bc-ring-fill{stroke:var(--green);}
.bc-pill.verified .bc-ring-fill{stroke:var(--teal);}
.bc-pill.low    .bc-ring-tip{fill:var(--yellow);filter:drop-shadow(0 0 3px rgba(245,158,11,0.9));}
.bc-pill.medium .bc-ring-tip{fill:#60a5fa;filter:drop-shadow(0 0 3px rgba(96,165,250,0.9));}
.bc-pill.high   .bc-ring-tip{fill:var(--green);filter:drop-shadow(0 0 3px rgba(34,197,94,0.9));}
.bc-pill.verified .bc-ring-tip{fill:var(--teal);filter:drop-shadow(0 0 4px rgba(0,229,200,1));}

/* Confidence breakdown dropdown */
.bc-breakdown{position:absolute;top:calc(100% + 8px);right:0;width:260px;background:var(--surface);border:1px solid var(--cbord);border-radius:14px;padding:1.1rem 1.25rem;z-index:60;pointer-events:none;opacity:0;transform:translateY(-4px);transition:opacity 0.2s,transform 0.2s;}
.bc-pill:hover .bc-breakdown,.bc-pill:focus .bc-breakdown{opacity:1;transform:none;pointer-events:auto;}
.bcd-title{font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:0.75rem;}
.bcd-row{display:flex;justify-content:space-between;align-items:center;font-size:0.82rem;padding:0.3rem 0;}
.bcd-row-lbl{color:var(--muted);}
.bcd-row-val{font-family:'Space Mono',monospace;font-size:0.75rem;color:var(--text);}
.bcd-bar{height:3px;background:rgba(255,255,255,0.06);border-radius:2px;margin:0.65rem 0;overflow:hidden;}
.bcd-bar-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--blue));border-radius:2px;transition:width 1s ease;}
.bcd-nextstep{font-size:0.78rem;color:var(--teal);line-height:1.5;padding-top:0.5rem;border-top:1px solid var(--cbord);}

/* Trend escalation banner */
.trend-banner{display:none;align-items:flex-start;gap:0.85rem;padding:0.9rem 1.25rem;border-radius:12px;margin-bottom:1.25rem;}
.trend-banner.strong{background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.2);}
.trend-banner.soft{background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.2);}
.tb-icon{font-size:1.15rem;flex-shrink:0;margin-top:0.05rem;}
.tb-msg{font-size:0.88rem;line-height:1.6;color:var(--text);}
.trend-banner.strong .tb-msg strong{color:var(--red);}
.trend-banner.soft .tb-msg strong{color:var(--yellow);}

/* Export button */
.act-btn-export{padding:0.65rem 1.5rem;border-radius:100px;background:transparent;border:1px solid rgba(0,229,200,0.3);color:var(--teal);font-family:'DM Sans',sans-serif;font-size:0.9rem;cursor:pointer;transition:all 0.2s;}
.act-btn-export:hover{background:rgba(0,229,200,0.07);border-color:rgba(0,229,200,0.5);}
.bc-tooltip{position:absolute;bottom:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--cbord);border-radius:10px;padding:0.75rem 1rem;width:220px;font-size:0.72rem;color:var(--muted);line-height:1.5;pointer-events:none;opacity:0;transition:opacity 0.2s;z-index:50;text-transform:none;letter-spacing:0;}
.bc-pill:hover .bc-tooltip{opacity:1;}
.bc-msg{font-family:'Space Mono',monospace;font-size:0.67rem;color:var(--muted);letter-spacing:0.04em;margin-top:0.4rem;line-height:1.5;}

/* Confidence banner on results */
.conf-banner{display:flex;align-items:center;justify-content:space-between;padding:0.85rem 1.4rem;background:var(--cb);border:1px solid var(--cbord);border-radius:12px;margin-bottom:1.25rem;flex-wrap:wrap;gap:0.75rem;}
.conf-banner-left{display:flex;align-items:center;gap:0.75rem;}
.conf-banner-lbl{font-family:'Space Mono',monospace;font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);}
.conf-banner-msg{font-size:0.8rem;color:var(--text);}

/* History metric charts */
.hist-metric-charts{display:grid;grid-template-columns:repeat(3,1fr);gap:1.15rem;margin-bottom:1.4rem;}
.hmc-card{background:var(--surface);border:1px solid var(--cbord);border-radius:14px;padding:1.25rem;position:relative;overflow:hidden;}
.hmc-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--hmcc,var(--teal)),transparent);}
.hmc-card.face{--hmcc:var(--teal);}.hmc-card.arms{--hmcc:var(--violet);}.hmc-card.speech{--hmcc:var(--blue);}
.hmc-hd{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;}
.hmc-ico{font-size:1rem;}
.hmc-ttl{font-family:'DM Serif Display',serif;font-size:0.9rem;flex:1;}
.hmc-unit{font-family:'Space Mono',monospace;font-size:0.58rem;color:var(--muted);letter-spacing:0.06em;}
.hmc-area{height:80px;}

/* Replay modal score cards */
.replay-score-card{display:flex;align-items:center;gap:0.85rem;padding:1rem 1.25rem;background:var(--cb);border:1px solid var(--cbord);border-radius:12px;}
.replay-score-ico{font-size:1.2rem;}
.replay-score-lbl{font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);margin-bottom:0.15rem;}
.replay-score-val{font-family:'DM Serif Display',serif;font-size:1.15rem;}
.replay-badge{font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.06em;padding:0.18rem 0.55rem;border-radius:100px;white-space:nowrap;}
.replay-badge.ok{background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.2);}
.replay-badge.warn{background:rgba(245,158,11,0.1);color:var(--yellow);border:1px solid rgba(245,158,11,0.2);}
.replay-badge.alert{background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2);}

/* ── VIDEO PLAYER CONTROLS ── */
.vp-controls{display:flex;align-items:center;gap:0.9rem;padding:0.75rem 1rem;background:rgba(255,255,255,0.03);border:1px solid var(--cbord);border-radius:12px;margin-bottom:1.25rem;}
.vp-play-btn{flex-shrink:0;width:34px;height:34px;background:rgba(0,229,200,0.1);border:1px solid rgba(0,229,200,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.18s;color:var(--teal);}
.vp-play-btn:hover{background:rgba(0,229,200,0.2);box-shadow:0 0 16px rgba(0,229,200,0.25);}
.vp-time{font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--muted);white-space:nowrap;min-width:72px;}
.vp-scrub-wrap{flex:1;position:relative;height:20px;display:flex;align-items:center;cursor:pointer;}
.vp-scrub-track{position:absolute;left:0;right:0;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;}
.vp-scrub-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--teal),var(--blue));border-radius:2px;transition:width 0.1s linear;}
.vp-scrub-thumb{position:absolute;top:50%;width:14px;height:14px;background:var(--teal);border-radius:50%;transform:translate(-50%,-50%);left:0%;box-shadow:0 0 8px rgba(0,229,200,0.6);transition:left 0.1s linear;pointer-events:none;}
.vp-scrub-wrap:hover .vp-scrub-thumb{width:16px;height:16px;box-shadow:0 0 14px rgba(0,229,200,0.8);}
.vp-scrub-wrap:active .vp-scrub-fill{transition:none;}
.vp-scrub-wrap:active .vp-scrub-thumb{transition:none;}

@media(max-width:900px){
  .hist-metric-charts{grid-template-columns:1fr;}
  #replay-grid{grid-template-columns:1fr!important;}
  nav{padding:1.5rem 2rem;}.nav-links{display:none;}
  .section-pad,.signals-section,.ethics-section,.chart-section,.audience-section,.cta-section{padding:5rem 1.5rem;}
  .steps-grid,.signals-header,.ethics-inner,.audience-grid{grid-template-columns:1fr;}
  .signals-grid{grid-template-columns:1fr 1fr;}
  .ethics-inner{padding:3rem 2rem;gap:2.5rem;}
  footer{flex-direction:column;gap:1.5rem;text-align:center;}.footer-note{text-align:center;}
  .record-layout,.metric-cards,.previews-row,.what-is-fast{grid-template-columns:1fr;}
  .status-banner,.action-panel{flex-direction:column;align-items:flex-start;}
  .he-scores{gap:0.75rem;}
  .app-nav{padding:0.9rem 1.25rem;}
}

/* ===== HOW IT WORKS OVERLAY ===== */
#hiw-overlay{font-family:'DM Sans',sans-serif;}
.hiw-nav{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:1.1rem 2.5rem;background:rgba(6,8,15,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--cbord);}
.hiw-nav-logo{font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--teal);text-shadow:0 0 20px rgba(0,229,200,0.4);transition:opacity 0.2s;}
.hiw-nav-logo:hover{opacity:0.75;}
.hiw-nav-sub{font-family:'Space Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.06em;margin-left:0.5rem;}
.hiw-back{background:none;border:1px solid var(--cbord);color:var(--muted);padding:0.4rem 1.1rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.85rem;cursor:pointer;transition:all 0.2s;}
.hiw-back:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}
.hiw-body{max-width:900px;margin:0 auto;padding:4rem 2rem 6rem;}
.hiw-hero{text-align:center;margin-bottom:5rem;}
.hiw-tag{font-family:'Space Mono',monospace;font-size:0.7rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--teal);margin-bottom:1rem;}
.hiw-title{font-family:'DM Serif Display',serif;font-size:clamp(2.5rem,5vw,4rem);letter-spacing:-0.03em;line-height:1.1;margin-bottom:1.25rem;}
.hiw-title em{font-style:italic;color:var(--teal);text-shadow:0 0 40px rgba(0,229,200,0.35);}
.hiw-sub{color:var(--muted);font-size:1.1rem;line-height:1.8;max-width:600px;margin:0 auto;}
.hiw-section{margin-bottom:4.5rem;}
.hiw-section-tag{font-family:'Space Mono',monospace;font-size:0.68rem;letter-spacing:0.16em;text-transform:uppercase;color:var(--violet);margin-bottom:0.75rem;}
.hiw-section-title{font-family:'DM Serif Display',serif;font-size:1.9rem;letter-spacing:-0.02em;margin-bottom:0.75rem;}
.hiw-section-desc{color:var(--muted);font-size:1.05rem;line-height:1.8;margin-bottom:2rem;max-width:700px;}
.hiw-steps{display:flex;flex-direction:column;gap:1px;background:var(--cbord);border-radius:16px;overflow:hidden;}
.hiw-step{background:var(--surface);padding:1.75rem 2rem;display:grid;grid-template-columns:48px 1fr;gap:1.5rem;align-items:flex-start;transition:background 0.2s;}
.hiw-step:hover{background:#111827;}
.hiw-step-num{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:0.85rem;font-weight:700;flex-shrink:0;}
.hiw-step-num.teal{background:rgba(0,229,200,0.12);color:var(--teal);border:1px solid rgba(0,229,200,0.25);}
.hiw-step-num.violet{background:rgba(168,85,247,0.12);color:var(--violet);border:1px solid rgba(168,85,247,0.25);}
.hiw-step-num.blue{background:rgba(59,130,246,0.12);color:var(--blue);border:1px solid rgba(59,130,246,0.25);}
.hiw-step-info h4{font-family:'DM Serif Display',serif;font-size:1.2rem;margin-bottom:0.4rem;}
.hiw-step-info p{color:var(--muted);font-size:1rem;line-height:1.75;}
.hiw-step-info .hiw-step-note{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--teal);letter-spacing:0.06em;margin-top:0.5rem;opacity:0.8;}
.hiw-signal-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.hiw-signal{background:var(--surface);border:1px solid var(--cbord);border-radius:14px;padding:1.5rem;}
.hiw-signal-icon{font-size:1.6rem;margin-bottom:0.75rem;}
.hiw-signal h4{font-family:'DM Serif Display',serif;font-size:1.1rem;margin-bottom:0.4rem;}
.hiw-signal p{color:var(--muted);font-size:0.96rem;line-height:1.7;}
.hiw-signal .hiw-signal-metric{font-family:'Space Mono',monospace;font-size:0.68rem;color:var(--muted);margin-top:0.6rem;padding-top:0.6rem;border-top:1px solid var(--cbord);letter-spacing:0.05em;}
.hiw-faq{display:flex;flex-direction:column;gap:0.75rem;}
.hiw-faq-item{background:var(--surface);border:1px solid var(--cbord);border-radius:13px;overflow:hidden;}
.hiw-faq-q{padding:1.1rem 1.5rem;font-weight:500;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:background 0.2s;}
.hiw-faq-q:hover{background:rgba(255,255,255,0.02);}
.hiw-faq-q span{font-family:'Space Mono',monospace;font-size:0.85rem;color:var(--muted);}
.hiw-faq-a{padding:0 1.5rem 1.1rem;color:var(--muted);font-size:0.98rem;line-height:1.75;display:none;}
.hiw-faq-item.open .hiw-faq-a{display:block;}
.hiw-faq-item.open .hiw-faq-q{background:rgba(0,229,200,0.04);}
.hiw-faq-item.open .hiw-faq-q span{color:var(--teal);}
.hiw-cta{text-align:center;padding:3.5rem 2rem;background:linear-gradient(135deg,rgba(0,229,200,0.05),rgba(168,85,247,0.04));border:1px solid var(--cbord);border-radius:20px;}
.hiw-cta h3{font-family:'DM Serif Display',serif;font-size:2rem;letter-spacing:-0.02em;margin-bottom:0.75rem;}
.hiw-cta p{color:var(--muted);font-size:1.05rem;margin-bottom:2rem;line-height:1.7;}
@media(max-width:640px){.hiw-signal-grid{grid-template-columns:1fr;}.hiw-body{padding:2rem 1.25rem 4rem;}}

/* ===== FEATURE 4: MONITORING STREAK ===== */
.streak-card{background:var(--surface);border:1px solid var(--cbord);border-radius:14px;padding:1.1rem 1.4rem;display:flex;align-items:center;gap:1.1rem;margin-bottom:1.4rem;position:relative;overflow:hidden;}
.streak-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--teal),transparent);}
.streak-flame{font-size:1.6rem;flex-shrink:0;}
.streak-info{flex:1;}
.streak-count{font-family:'DM Serif Display',serif;font-size:1.4rem;letter-spacing:-0.02em;line-height:1;margin-bottom:0.15rem;}
.streak-count span{font-size:0.85rem;color:var(--muted);font-family:'DM Sans',sans-serif;letter-spacing:0;margin-left:0.3rem;}
.streak-sub{font-size:0.8rem;color:var(--muted);line-height:1.4;}
.streak-dots{display:flex;gap:5px;margin-top:0.6rem;}
.streak-dot{width:8px;height:8px;border-radius:50%;background:var(--cbord);}
.streak-dot.green{background:var(--green);box-shadow:0 0 5px rgba(34,197,94,0.5);}
.streak-dot.yellow{background:var(--yellow);box-shadow:0 0 5px rgba(245,158,11,0.4);}
.streak-dot.red{background:var(--red);box-shadow:0 0 5px rgba(239,68,68,0.4);}
.streak-dot.missed{background:rgba(107,114,128,0.3);border:1px solid rgba(107,114,128,0.2);}
.streak-cadence{font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);padding:0.22rem 0.65rem;border-radius:100px;border:1px solid var(--cbord);white-space:nowrap;flex-shrink:0;}
.streak-cadence.on-track{color:var(--teal);border-color:rgba(0,229,200,0.25);background:rgba(0,229,200,0.06);}

/* ===== FEATURE 6: SIGNAL FINGERPRINT RADAR ===== */
.fingerprint-card{background:var(--surface);border:1px solid var(--cbord);border-radius:16px;padding:1.6rem;position:relative;overflow:hidden;margin-bottom:1.75rem;}
.fingerprint-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--violet),transparent);}
.fp-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;}
.fp-title{font-family:'DM Serif Display',serif;font-size:1.05rem;letter-spacing:-0.01em;}
.fp-tag{font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--violet);background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);padding:0.2rem 0.6rem;border-radius:100px;}
.fp-body{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;align-items:center;}
.fp-svg-wrap{display:flex;justify-content:center;}
.fp-legend{display:flex;flex-direction:column;gap:0.7rem;}
.fp-legend-item{display:flex;align-items:center;gap:0.6rem;font-size:0.82rem;}
.fp-legend-swatch{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.fp-legend-lbl{color:var(--muted);}
.fp-legend-val{font-family:'Space Mono',monospace;font-size:0.72rem;color:var(--text);margin-left:auto;}
.fp-note{font-family:'Space Mono',monospace;font-size:0.62rem;color:var(--muted);letter-spacing:0.04em;margin-top:1rem;line-height:1.5;padding-top:0.75rem;border-top:1px solid var(--cbord);}


/* ── SPEECH STRIP (below camera during speak task) ── */
.speech-strip{
  display:none;width:100%;
  background:var(--surface);
  border:1px solid rgba(59,130,246,0.3);
  border-radius:16px;
  padding:1.1rem 1.3rem 1rem;
  margin-top:0.85rem;
  position:relative;overflow:hidden;
}
.speech-strip::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--blue),transparent);
}
.speech-strip.active{display:block;}
.ss-top{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:0.75rem;
}
.ss-label{
  font-family:'Space Mono',monospace;font-size:0.58rem;
  letter-spacing:0.14em;text-transform:uppercase;color:var(--blue);
  display:flex;align-items:center;gap:0.4rem;
}
.ss-live-dot{
  width:6px;height:6px;border-radius:50%;background:var(--red);
  animation:blink 1s ease-in-out infinite;flex-shrink:0;
}
.ss-wpm-badge{
  display:flex;align-items:baseline;gap:0.3rem;
  background:rgba(59,130,246,0.1);
  border:1px solid rgba(59,130,246,0.25);
  border-radius:100px;padding:0.25rem 0.75rem;
}
.ss-wpm-live{
  font-family:'DM Serif Display',serif;font-size:1.4rem;
  letter-spacing:-0.02em;color:var(--text);line-height:1;
}
.ss-wpm-unit{
  font-family:'Space Mono',monospace;font-size:0.6rem;
  color:var(--muted);
}
.ss-passage{
  font-size:0.92rem;line-height:1.8;color:var(--muted);
  margin-bottom:0.85rem;
  padding:0.75rem 1rem;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--cbord);
  border-radius:10px;
}
.ss-word{transition:color 0.12s,font-weight 0.12s;}
.ss-word.spoken{color:var(--blue);font-weight:500;}
.ss-word.current{
  color:#fff;font-weight:500;
  text-shadow:0 0 12px rgba(59,130,246,0.6);
}
.ss-buckets-section{border-top:1px solid rgba(255,255,255,0.05);padding-top:0.7rem;}
.ss-buckets-lbl{
  font-family:'Space Mono',monospace;font-size:0.55rem;
  letter-spacing:0.12em;text-transform:uppercase;
  color:var(--muted);margin-bottom:0.45rem;
}
.ss-buckets{
  display:flex;gap:3px;align-items:flex-end;height:32px;
}
.ss-bucket-bar{
  flex:0 0 10px;
  background:rgba(59,130,246,0.5);
  border-radius:3px 3px 0 0;
  min-height:3px;
  transition:height 0.2s;
  box-shadow:0 0 4px rgba(59,130,246,0.2);
}
.ss-bucket-bar.spike{
  background:rgba(239,68,68,0.75);
  box-shadow:0 0 6px rgba(239,68,68,0.35);
}

/* ── SPEECH RESULTS STATS (in metric card) ── */
.speech-stats{display:flex;flex-direction:column;gap:0;}
.speech-stat-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:0.42rem 0;border-bottom:1px solid rgba(255,255,255,0.04);
}
.speech-stat-row:last-child{border-bottom:none;}
.speech-stat-lbl{color:var(--muted);font-size:0.87rem;}
.speech-stat-val{font-family:'Space Mono',monospace;font-size:0.87rem;font-weight:600;}
.speech-stat-val.good{color:var(--teal);}
.speech-stat-val.warn{color:var(--yellow);}
.speech-stat-val.bad{color:var(--red);}
.speech-stat-val.neutral{color:var(--text);}
.ss-res-lbl{
  font-family:'Space Mono',monospace;font-size:0.55rem;
  letter-spacing:0.12em;text-transform:uppercase;
  color:var(--muted);margin-bottom:0.35rem;
}
.ss-res-buckets{
  display:flex;gap:3px;align-items:flex-end;height:32px;
  margin-top:0.6rem;padding-top:0.6rem;
  border-top:1px solid rgba(255,255,255,0.04);
}
.ss-res-bucket-bar{
  flex:1;background:rgba(59,130,246,0.5);
  border-radius:2px 2px 0 0;min-height:3px;
}
.ss-res-bucket-bar.spike{background:rgba(239,68,68,0.75);}

/* ===== SETTINGS OVERLAY ===== */
.st-row{display:flex;align-items:center;justify-content:space-between;padding:0.9rem 0;border-bottom:1px solid var(--cbord);}
.st-row-info{flex:1;padding-right:1.25rem;}
.st-row-lbl{font-size:0.9rem;font-weight:500;margin-bottom:0.15rem;}
.st-row-sub{font-size:0.78rem;color:var(--muted);line-height:1.5;}
.st-toggle{position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;}
.st-toggle input{opacity:0;width:0;height:0;position:absolute;}
.st-slider{position:absolute;cursor:pointer;inset:0;background:rgba(255,255,255,0.08);border:1px solid var(--cbord);border-radius:12px;transition:all 0.25s;}
.st-slider::before{content:'';position:absolute;width:18px;height:18px;left:2px;top:2px;background:var(--muted);border-radius:50%;transition:all 0.25s;}
.st-toggle input:checked + .st-slider{background:rgba(0,229,200,0.18);border-color:rgba(0,229,200,0.4);}
.st-toggle input:checked + .st-slider::before{background:var(--teal);transform:translateX(20px);box-shadow:0 0 8px rgba(0,229,200,0.5);}
.scheme-chip{display:inline-flex;align-items:center;gap:0.45rem;padding:0.4rem 0.85rem;border-radius:100px;border:1px solid var(--cbord);background:var(--cb);font-size:0.8rem;cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif;color:var(--text);}
.scheme-chip:hover{border-color:rgba(255,255,255,0.2);}
.scheme-chip.active{border-color:var(--teal);background:rgba(0,229,200,0.1);color:var(--teal);}
.accent-dot{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.2s;box-sizing:border-box;display:inline-block;}
.accent-dot:hover{transform:scale(1.18);}
.accent-dot.active{border-color:#fff;box-shadow:0 0 0 2px rgba(255,255,255,0.3);}
input[type=range]{-webkit-appearance:none;appearance:none;height:4px;border-radius:2px;background:rgba(255,255,255,0.1);outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--teal);cursor:pointer;box-shadow:0 0 8px rgba(0,229,200,0.4);}
</style>
</head>
<body>

<!-- ═══════════════════ LANDING PAGE ═══════════════════ -->
<div class="blob blob-1"></div>
<div class="blob blob-2"></div>
<div class="blob blob-3"></div>

<nav>
  <a class="nav-logo" href="#" onclick="closeApp();closeHowItWorks();closeReplayModal();window.scrollTo({top:0,behavior:'smooth'});return false;" style="text-decoration:none;cursor:pointer;">Baseline</a>
  <ul class="nav-links">
    <li><a href="#how">How It Works</a></li>
    <li><a href="#signals">Signals</a></li>
    <li><a href="#ethics">Ethics</a></li>
    <li><a href="#why">Why It Matters</a></li>
  </ul>
  <button class="nav-cta" onclick="openApp()">Early Access</button>
</nav>

<section class="hero">
  <p class="hero-eyebrow">🧠 Early Stroke Detection · FAST Screening</p>
  <h1>Catch the signs<br>before they<br><em>escalate.</em></h1>
  <p class="hero-sub">Baseline uses your camera and microphone to run the FAST neurological screening — analyzing facial symmetry, arm stability, and speech clarity to surface early warning signals of stroke at any age.</p>
  <div class="hero-actions">
    <button class="btn-primary" onclick="openApp()">Start Free Check-In</button>
    <button class="btn-ghost" onclick="openHowItWorks()">See How It Works</button>
  </div>
  <div class="signal-viz">
    <div class="waveform" id="waveform"></div>
    <p class="viz-label">— Video · Pose · Speech signal analysis —</p>
  </div>
</section>

<div class="divider"></div>

<section class="section-pad" id="how">
  <div style="max-width:1100px;margin:0 auto">
    <p class="section-tag reveal">Process</p>
    <h2 class="section-title reveal">Three tasks,<br>one clear picture.</h2>
    <p class="section-desc reveal">No doctors. No paperwork. A 30-second video check-in that screens for the classic FAST stroke indicators — Face, Arms, Speech, Time — using your camera and microphone.</p>
    <div class="steps-grid reveal">
      <div class="step"><div class="step-num">01</div><span class="step-icon">📹</span><h3>Video Check-In</h3><p>Record a 30-second clip in your browser — no app needed. Your camera captures facial symmetry and arm stability while your microphone captures speech patterns.</p></div>
      <div class="step"><div class="step-num">02</div><span class="step-icon">🔬</span><h3>Multi-Signal Analysis</h3><p>AI analyzes facial landmark symmetry, arm drift over time using pose detection, and speech pace and clarity — the same three axes physicians use in FAST assessment.</p></div>
      <div class="step"><div class="step-num">03</div><span class="step-icon">📊</span><h3>Your Personal Baseline</h3><p>Compared only to yourself. A naturally asymmetric face isn't flagged. Changes are measured against your recorded baseline — not population averages.</p></div>
      <div class="step"><div class="step-num">04</div><span class="step-icon">⚡</span><h3>Immediate Awareness</h3><p>If signals deviate from your baseline, Anchor surfaces the pattern clearly and immediately — with plain language, no scores, and a direct nudge to seek care if needed.</p></div>
    </div>
  </div>
</section>

<section class="signals-section" id="signals">
  <div style="max-width:1100px;margin:0 auto">
    <div class="signals-header">
      <div><p class="section-tag reveal">What We Measure</p><h2 class="section-title reveal" style="margin-bottom:0">The signals a stroke leaves<br>before it's obvious.</h2></div>
      <p class="section-desc reveal">Each signal is drawn from the FAST protocol used by emergency medicine. Anchor measures all three simultaneously — and compares them against your personal baseline, not a population average.</p>
    </div>
    <div class="signals-grid">
      <div class="signal-card reveal"><div class="signal-emoji">😐</div><h4>Facial Symmetry</h4><p>Mouth corner and eye alignment measured across frames. Sudden asymmetry — especially one-sided drooping — is one of the earliest observable signs of stroke.</p></div>
      <div class="signal-card reveal"><div class="signal-emoji">🦾</div><h4>Arm Drift & Stability</h4><p>Wrist height tracked relative to shoulders over 10 seconds using pose detection. Unilateral drift or sudden drop indicates potential motor weakness on one side.</p></div>
      <div class="signal-card reveal"><div class="signal-emoji">🗣️</div><h4>Speech Clarity</h4><p>Words per minute, pause ratio, and fluency measured as you speak a simple phrase. Slurring and hesitation appear in speech patterns before they're noticeable to the speaker.</p></div>
      <div class="signal-card reveal"><div class="signal-emoji">📐</div><h4>Personal Baseline</h4><p>Your results are compared to your own recorded baseline — not a statistical average. A naturally asymmetric face won't trigger a false alarm.</p></div>
      <div class="signal-card reveal"><div class="signal-emoji">📈</div><h4>Trend Tracking</h4><p>Each check-in is stored locally and compared over time. Subtle changes that emerge across sessions can surface patterns a single snapshot would miss.</p></div>
      <div class="signal-card reveal"><div class="signal-emoji">🎯</div><h4>Signal Quality Gate</h4><p>Every recording is evaluated for lighting, framing, body visibility, and audio clarity. Low-quality signals are blocked — we only report when the data is trustworthy.</p></div>
    </div>
  </div>
</section>

<section class="chart-section">
  <div style="max-width:900px;margin:0 auto">
    <p class="section-tag reveal">Visualization</p>
    <h2 class="section-title reveal">Patterns, not diagnoses.</h2>
    <p class="section-desc reveal" style="margin:0 auto">Your dashboard shows gentle trends. No scores. No alarms. Just information, in your hands.</p>
    <div class="chart-container reveal">
      <div class="chart-header"><div class="chart-title">Facial Asymmetry Index — Past 14 Days</div><div class="chart-period">FEB 2026</div></div>
      <div class="chart-area">
        <svg class="chart-svg" viewBox="0 0 740 180" preserveAspectRatio="none">
          <defs><linearGradient id="lg" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#00e5c8" stop-opacity="0.3"/><stop offset="100%" stop-color="#00e5c8" stop-opacity="0"/></linearGradient></defs>
          <line x1="0" y1="45" x2="740" y2="45" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>
          <line x1="0" y1="90" x2="740" y2="90" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>
          <line x1="0" y1="135" x2="740" y2="135" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>
          <path d="M0,80 C55,75 110,60 160,65 C210,70 260,85 310,90 C360,95 390,100 440,108 C490,115 530,120 580,118 C620,116 660,112 700,110 L700,180 L0,180 Z" fill="url(#lg)"/>
          <line x1="0" y1="68" x2="740" y2="68" stroke="rgba(0,229,200,0.2)" stroke-width="1" stroke-dasharray="5,5"/>
          <text x="710" y="63" fill="rgba(0,229,200,0.5)" font-size="10" font-family="Space Mono">baseline</text>
          <path d="M0,80 C55,75 110,60 160,65 C210,70 260,85 310,90 C360,95 390,100 440,108 C490,115 530,120 580,118 C620,116 660,112 700,110" fill="none" stroke="#00e5c8" stroke-width="2.5" stroke-linecap="round"/>
          <circle cx="0" cy="80" r="4" fill="#00e5c8"/><circle cx="160" cy="65" r="4" fill="#00e5c8"/><circle cx="310" cy="90" r="4" fill="#00e5c8"/>
          <circle cx="440" cy="108" r="5" fill="#00e5c8" filter="drop-shadow(0 0 6px #00e5c8)"/>
          <circle cx="580" cy="118" r="4" fill="#00e5c8"/><circle cx="700" cy="110" r="4" fill="#00e5c8"/>
          <text x="0" y="175" fill="#6b7280" font-size="11" font-family="Space Mono">Feb 5</text>
          <text x="145" y="175" fill="#6b7280" font-size="11" font-family="Space Mono">Feb 8</text>
          <text x="295" y="175" fill="#6b7280" font-size="11" font-family="Space Mono">Feb 11</text>
          <text x="425" y="175" fill="#6b7280" font-size="11" font-family="Space Mono">Feb 14</text>
          <text x="565" y="175" fill="#6b7280" font-size="11" font-family="Space Mono">Feb 17</text>
          <text x="685" y="175" fill="#6b7280" font-size="11" font-family="Space Mono">Today</text>
        </svg>
      </div>
      <div class="chart-insight">✦ &nbsp;"Facial asymmetry index is stable and within your personal baseline this week. No changes from your norm."</div>
    </div>
  </div>
</section>

<section class="ethics-section" id="ethics">
  <div style="max-width:1100px;margin:0 auto">
    <div class="ethics-inner reveal">
      <div>
        <p class="section-tag">Ethics First</p>
        <h2 class="ethics-title">Built with<br><em>radical</em><br>responsibility.</h2>
        <p class="ethics-desc">Baseline is not a medical device and cannot diagnose a stroke. It's an awareness tool designed to help people notice changes in their own signals over time — and act faster when it matters. Your data never leaves your device.</p>
      </div>
      <div class="ethics-list">
        <div class="ethics-item"><div class="ethics-icon">🔒</div><div class="ethics-item-text">No diagnosis, ever<span>Anchor reflects patterns from your baseline. It never diagnoses, labels, or replaces medical evaluation.</span></div></div>
        <div class="ethics-item"><div class="ethics-icon">🚫</div><div class="ethics-item-text">Zero data sharing<span>All recordings and results are processed locally. Nothing is sent to servers, insurers, or third parties.</span></div></div>
        <div class="ethics-item"><div class="ethics-icon">👤</div><div class="ethics-item-text">Compared only to yourself<span>Your baseline is yours. You're never measured against population averages — because stroke signs look different on everyone.</span></div></div>
        <div class="ethics-item"><div class="ethics-icon">⚡</div><div class="ethics-item-text">Designed for speed, not perfectionism<span>If signals are concerning, we say so clearly and immediately — not after 10 more check-ins.</span></div></div>
        <div class="ethics-item"><div class="ethics-icon">🔍</div><div class="ethics-item-text">Full transparency<span>Every signal explained. Every threshold documented. You always know exactly what triggered an alert and why.</span></div></div>
      </div>
    </div>
  </div>
</section>

<section class="audience-section" id="why">
  <div style="max-width:1100px;margin:0 auto">
    <p class="section-tag reveal">Why It Matters</p>
    <h2 class="section-title reveal">Every minute matters.<br>Most strokes go undetected<br>for too long.</h2>
    <div class="audience-grid">
      <div class="audience-card reveal"><div class="audience-big">80%</div><h4>Are preventable or treatable</h4><p>Stroke is the leading cause of long-term disability worldwide — yet up to 80% of strokes can be prevented or minimized when warning signs are caught and acted on early.</p></div>
      <div class="audience-card reveal"><div class="audience-big">F·A·S·T</div><h4>The standard detection protocol</h4><p>Face drooping, Arm weakness, Speech difficulty, Time to call. FAST is the global screening framework — Baseline runs all three signal checks in only 30 seconds (≈35 with pauses), from any device with a camera.</p></div>
      <div class="audience-card reveal"><div class="audience-big">All ages</div><h4>Stroke doesn't only affect the elderly</h4><p>Stroke incidence in adults under 50 is rising. Regular baseline check-ins allow anyone — at any age — to know their normal and spot deviations before they become emergencies.</p></div>
    </div>
  </div>
</section>

<section class="cta-section">
  <div class="cta-inner">
    <p class="section-tag reveal">Try It Now</p>
    <h2 class="reveal">Be the first to<br>hear your own <em>signal.</em></h2>
    <p class="reveal">Run the FAST neurological screening demo — Only a 30-second video check-in that analyzes facial symmetry, arm drift, and speech clarity live in your browser.</p>
    <div class="hero-actions reveal">
      <button class="btn-primary" onclick="openApp()">Start FAST Check →</button>
      <button class="btn-ghost">Learn More</button>
    </div>
  </div>
</section>

<footer>
  <div class="footer-logo">Baseline</div>
  <p class="footer-note">Not a medical device. Not a diagnostic tool.<br>An early-warning mirror for stroke signals — for everyone.</p>
</footer>


<!-- ═══════════════════ FAST CHECK APP ═══════════════════ -->
<div id="fast-app">

  <div class="app-nav">
    <div class="app-nav-logo" onclick="stopPreviewLoop();showScreen('home');" style="cursor:pointer;">Baseline <span class="app-nav-sub">/ FAST Check</span></div>
    <div class="app-nav-right">
      <button class="app-nav-hist" onclick="goHistory()">📈 History</button>
      <button class="app-nav-hist" onclick="goSettings()">⚙️ Settings</button>
      <span id="nav-bc-pill" class="bc-pill low" tabindex="0">
        <svg class="bc-ring-svg" width="20" height="20" viewBox="0 0 20 20">
          <circle class="bc-ring-track" cx="10" cy="10" r="7"/>
          <circle id="nav-conf-ring" class="bc-ring-fill" cx="10" cy="10" r="7" stroke-dasharray="43.98" stroke-dashoffset="43.98" transform="rotate(-90 10 10)"/>
          <circle id="nav-conf-tip" class="bc-ring-tip" cx="10" cy="3" r="1.8" opacity="0"/>
        </svg>
        <span id="nav-bc-text">Calibrating</span>
        <span class="bc-breakdown">
          <div class="bcd-title">Confidence Drivers</div>
          <div class="bcd-row"><span class="bcd-row-lbl">Check-ins</span><span class="bcd-checkins bcd-row-val">0 / 8</span></div>
          <div class="bcd-row"><span class="bcd-row-lbl">Avg quality</span><span class="bcd-quality bcd-row-val">—</span></div>
          <div class="bcd-bar"><div class="bcd-bar-fill" style="width:0%"></div></div>
          <div class="bcd-nextstep">Complete 3 more check-ins to reach Developing.</div>
        </span>
      </span>
      <span class="app-badge">Beta Demo</span>
      <button class="app-back" onclick="closeApp()">← Back</button>
    </div>
  </div>

  <!-- ══ SCREEN: HOME ══ -->
  <div class="app-screen active" id="screen-home">
    <!-- Content injected by updateHomeScreen() -->
  </div>

  <!-- ══ SCREEN: RECORD ══ -->
  <div class="app-screen" id="screen-record">
    <div class="record-layout">
      <div>
        <div class="camera-wrap">
          <video id="cam-video" autoplay playsinline muted></video>
          <div class="cam-overlay">
            <div class="face-guide">
              <div class="fgc tl"></div><div class="fgc tr"></div>
              <div class="fgc bl"></div><div class="fgc br"></div>
            </div>
            <!-- Placeholder shown before camera starts -->
            <div id="cam-placeholder" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(6,8,15,0.92);gap:0.75rem;">
              <div style="font-size:2rem;animation:blink 1.2s ease-in-out infinite;">📷</div>
              <div style="font-family:'Space Mono',monospace;font-size:0.72rem;letter-spacing:0.1em;color:var(--muted);text-align:center;">Starting camera preview…</div>
            </div>
            <div class="countdown-overlay" id="countdown-overlay">
              <div class="countdown-num" id="countdown-num">3</div>
            </div>
            <div class="prompt-banner smile" id="prompt-banner">😐 &nbsp;NEUTRAL FACE — keep still</div>
            <!-- Speech passage overlay — shown during speak task -->
            <div id="speech-passage-overlay" style="display:none;position:absolute;inset:0;background:rgba(6,8,15,0.82);backdrop-filter:blur(6px);z-index:8;align-items:center;justify-content:center;padding:1.5rem 1.25rem;">
              <p id="speech-passage-text" style="font-family:'DM Sans',sans-serif;font-size:clamp(1rem,2.6vw,1.25rem);color:#fff;line-height:1.8;text-align:center;max-width:460px;font-weight:400;"></p>
            </div>
            <div class="rec-ind" id="rec-ind"><span class="rec-dot"></span> REC</div>
            <div class="cam-tip" id="cam-tip">Keep your face centered · Shoulders visible</div>
          </div>
        </div>
        <!-- Speech strip — shown below camera during speak task -->
        <div class="speech-strip" id="speech-strip">
          <div class="ss-top">
            <span class="ss-label"><span class="ss-live-dot"></span>Speech &middot; Live</span>
            <div class="ss-wpm-badge">
              <span class="ss-wpm-live" id="ss-wpm-live">&#x2014;</span>
              <span class="ss-wpm-unit">wpm</span>
            </div>
          </div>
          <div class="ss-passage" id="ss-passage-words"></div>
          <div class="ss-buckets-section">
            <div class="ss-buckets-lbl">WPM rhythm &middot; 1s buckets</div>
            <div class="ss-buckets" id="ss-buckets"></div>
          </div>
        </div>
      </div>
      <div class="rec-panel">
        <div id="rec-mode-banner" class="rec-mode-banner" style="display:none">📐 Baseline Recording</div>
        <div class="panel-box">
          <div class="pb-label">Task Sequence</div>
          <div class="tp-tasks">
            <div class="tp-task active" id="tp-smile"><div class="tp-icon">😐</div><div class="tp-info"><div class="tp-name">Neutral Face</div><div class="tp-dur">5 seconds</div></div><div class="tp-chk" id="chk-smile">○</div></div>
            <div class="tp-task pending" id="tp-arms"><div class="tp-icon">🙌</div><div class="tp-info"><div class="tp-name">Raise Both Arms</div><div class="tp-dur">10 seconds</div></div><div class="tp-chk" id="chk-arms">○</div></div>
            <div class="tp-task pending" id="tp-speak"><div class="tp-icon">🗣️</div><div class="tp-info"><div class="tp-name">Read the Passage</div><div class="tp-dur">20 seconds</div></div><div class="tp-chk" id="chk-speak">○</div></div>
          </div>
        </div>
        <div class="panel-box">
          <div class="timer-inner">
            <svg class="timer-svg" viewBox="0 0 90 90">
              <circle class="tr-bg" cx="45" cy="45" r="40"/>
              <circle class="tr-fill" id="timer-ring" cx="45" cy="45" r="40" transform="rotate(-90 45 45)"/>
              <text class="timer-num" x="45" y="52" text-anchor="middle" id="timer-num">—</text>
            </svg>
            <div class="timer-lbl" id="timer-lbl">Ready to begin</div>
          </div>
        </div>
        <div class="sq-panel">
          <div class="sq-panel-lbl">Signal Quality</div>
          <div class="sq-rows">
            <div>
              <div class="sq-row">
                <div class="sq-icon">💡</div>
                <div class="sq-label">Lighting</div>
                <div class="sq-status good" id="sq-lighting">✅ Good</div>
              </div>
              <div class="sq-tip" id="sq-lighting-tip"></div>
            </div>
            <div>
              <div class="sq-row">
                <div class="sq-icon">👤</div>
                <div class="sq-label">Face Framing</div>
                <div class="sq-status good" id="sq-face">✅ Good</div>
              </div>
              <div class="sq-tip" id="sq-face-tip"></div>
            </div>
            <div>
              <div class="sq-row">
                <div class="sq-icon">🦴</div>
                <div class="sq-label">Body Visibility</div>
                <div class="sq-status warn" id="sq-body">⚠️ Needs adjustment</div>
              </div>
              <div class="sq-tip" id="sq-body-tip">Step back so both shoulders and arms are visible.</div>
            </div>
            <div>
              <div class="sq-row">
                <div class="sq-icon">🎙️</div>
                <div class="sq-label">Audio Clarity</div>
                <div class="sq-status good" id="sq-audio">✅ Good</div>
              </div>
              <div class="sq-tip" id="sq-audio-tip"></div>
            </div>
          </div>
        </div>
        <div class="rec-controls">
          <button class="btn-rec-go" id="btn-go" onclick="startRec()">▶ &nbsp;Start Recording</button>
          <button class="btn-restart" onclick="resetRec()">↺ &nbsp;Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ══ SCREEN: PROCESSING ══ -->
  <div class="app-screen" id="screen-processing">
    <div class="proc-orb">🧠</div>
    <h2 class="proc-title">Analyzing your check-in…</h2>
    <p class="proc-sub">Running three signal analyses. Just a moment.</p>
    <div class="proc-checks">
      <div class="pc" id="pc-face">
        <div class="pc-icon">😐</div>
        <div style="flex:1"><div class="pc-name">Facial Symmetry</div><div class="pc-met" id="pc-face-met">Measuring mouth corner alignment…</div></div>
        <div id="pc-face-st"><span class="spinner"></span></div>
      </div>
      <div class="pc" id="pc-arms">
        <div class="pc-icon">🙌</div>
        <div style="flex:1"><div class="pc-name">Arm Drift Analysis</div><div class="pc-met" id="pc-arms-met">Tracking wrist position over time…</div></div>
        <div id="pc-arms-st"><span class="spinner"></span></div>
      </div>
      <div class="pc" id="pc-speech">
        <div class="pc-icon">🗣️</div>
        <div style="flex:1"><div class="pc-name">Speech Clarity</div><div class="pc-met" id="pc-speech-met">Analyzing pace and pause ratio…</div></div>
        <div id="pc-speech-st"><span class="spinner"></span></div>
      </div>
    </div>
  </div>

  <!-- ══ SCREEN: RESULTS ══ -->
  <div class="app-screen" id="screen-results">
    <div class="results-wrap">
      <div class="conf-banner" id="conf-banner">
        <div class="conf-banner-left">
          <span id="results-bc-pill" class="bc-pill low" tabindex="0">
            <svg class="bc-ring-svg" width="20" height="20" viewBox="0 0 20 20">
              <circle class="bc-ring-track" cx="10" cy="10" r="7"/>
              <circle id="results-conf-ring" class="bc-ring-fill" cx="10" cy="10" r="7" stroke-dasharray="43.98" stroke-dashoffset="43.98" transform="rotate(-90 10 10)"/>
              <circle id="results-conf-tip" class="bc-ring-tip" cx="10" cy="3" r="1.8" opacity="0"/>
            </svg>
            <span id="results-bc-text">Calibrating</span>
            <span class="bc-breakdown">
              <div class="bcd-title">Confidence Drivers</div>
              <div class="bcd-row"><span class="bcd-row-lbl">Check-ins</span><span class="bcd-checkins bcd-row-val">0 / 8</span></div>
              <div class="bcd-row"><span class="bcd-row-lbl">Avg quality</span><span class="bcd-quality bcd-row-val">—</span></div>
              <div class="bcd-bar"><div class="bcd-bar-fill" style="width:0%"></div></div>
              <div class="bcd-nextstep">Complete more check-ins to improve confidence.</div>
            </span>
          </span>
          <span class="conf-banner-msg" id="conf-banner-msg">We need more check-ins to understand your baseline.</span>
        </div>
      </div>

      <div id="trend-banner" class="trend-banner" style="display:none;"></div>

      <div class="status-banner green" id="sb">
        <div class="sb-left">
          <div class="sb-orb" id="sb-orb">✅</div>
          <div class="sb-info">
            <h2 id="sb-title">All Clear</h2>
            <p id="sb-desc">No significant asymmetry or irregularity detected across all three FAST signals.</p>
          </div>
        </div>
        <div class="sb-score-wrap">
          <div class="sb-score-lbl">Risk Index</div>
          <div class="sb-score" id="sb-score">0.4</div>
        </div>
      </div>

      <div class="metric-cards">
        <div class="mc face">
          <div class="mc-hd"><div class="mc-ico">😐</div><div class="mc-ttl">Facial Symmetry</div><div class="mc-badge ok" id="face-badge">NORMAL</div></div>
          <div class="mc-metric-lbl">Asymmetry Index</div>
          <div class="mc-val" id="face-val">0.04<span class="mc-unit">/ 0.08 threshold</span></div>
          <div class="mc-chart"><svg viewBox="0 0 200 60" preserveAspectRatio="none">
            <defs>
              <linearGradient id="face-grad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#00e5c8" stop-opacity="0.3"/><stop offset="100%" stop-color="#00e5c8" stop-opacity="0"/></linearGradient>
            </defs>
            <line x1="0" y1="52" x2="200" y2="52" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
            <line x1="0" y1="22" x2="200" y2="22" stroke="rgba(0,229,200,0.2)" stroke-width="1" stroke-dasharray="4,4"/>
            <text x="194" y="19" fill="rgba(0,229,200,0.45)" font-size="7" font-family="Space Mono" text-anchor="end">threshold</text>
            <path id="face-fill" class="mc-chart-fill" fill="url(#face-grad)" d=""/>
            <path id="face-line" class="mc-chart-line" fill="none" stroke="#00e5c8" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M0,38 40,36 80,39 120,37 160,38 200,37"/>
            <circle id="face-dot" cx="200" cy="37" r="4" fill="#00e5c8" class="mc-chart-dot chart-dot-glow" style="--dot-delay:1.1s;color:#00e5c8"/>
          </svg></div>
          <div class="mc-explain"><strong>What it means:</strong> Mouth corner and eye position difference across frames while holding a neutral expression. Values below 0.08 are within typical variation for a resting face.</div>
          <div class="delta-row" id="face-delta-row" style="display:none"><span class="delta-lbl">vs baseline</span><span class="delta-chip flat" id="face-delta-chip">—</span><span class="delta-baseline-val" id="face-baseline-val"></span></div>
        </div>
        <div class="mc arms">
          <div class="mc-hd"><div class="mc-ico">🙌</div><div class="mc-ttl">Arm Stability</div><div class="mc-badge ok" id="arms-badge">NORMAL</div></div>
          <div class="mc-metric-lbl">Right Arm Drift</div>
          <div class="mc-val" id="arms-val">2.1<span class="mc-unit">% over 5s</span></div>
          <div class="mc-chart"><svg viewBox="0 0 200 60" preserveAspectRatio="none">
            <defs>
              <linearGradient id="arms-grad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#a855f7" stop-opacity="0.3"/><stop offset="100%" stop-color="#a855f7" stop-opacity="0"/></linearGradient>
            </defs>
            <line x1="0" y1="52" x2="200" y2="52" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
            <line x1="0" y1="22" x2="200" y2="22" stroke="rgba(168,85,247,0.2)" stroke-width="1" stroke-dasharray="4,4"/>
            <text x="194" y="19" fill="rgba(168,85,247,0.45)" font-size="7" font-family="Space Mono" text-anchor="end">threshold</text>
            <path id="arms-fill" class="mc-chart-fill" fill="url(#arms-grad)" d=""/>
            <path id="arms-line" class="mc-chart-line" fill="none" stroke="#a855f7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M0,24 40,25 80,26 120,26 160,27 200,27"/>
            <circle id="arms-dot" cx="200" cy="27" r="4" fill="#a855f7" class="mc-chart-dot chart-dot-glow" style="--dot-delay:1.1s;color:#a855f7"/>
          </svg></div>
          <div class="mc-explain"><strong>What it means:</strong> Wrist height relative to shoulder over 10 seconds. Gradual drift beyond 8% may indicate one-sided weakness worth monitoring.</div>
          <div class="delta-row" id="arms-delta-row" style="display:none"><span class="delta-lbl">vs baseline</span><span class="delta-chip flat" id="arms-delta-chip">—</span><span class="delta-baseline-val" id="arms-baseline-val"></span></div>
        </div>
        <div class="mc speech">
          <div class="mc-hd"><div class="mc-ico">🗣️</div><div class="mc-ttl">Speech Clarity</div><div class="mc-badge ok" id="speech-badge">NORMAL</div></div>
          <div class="mc-metric-lbl">Pause Ratio</div>
          <div class="mc-val" id="speech-val">0.18<span class="mc-unit">silence ratio</span></div>
          <div class="mc-chart"><svg viewBox="0 0 200 60" preserveAspectRatio="none">
            <defs>
              <linearGradient id="speech-grad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/></linearGradient>
            </defs>
            <line x1="0" y1="52" x2="200" y2="52" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
            <line x1="0" y1="28" x2="200" y2="28" stroke="rgba(59,130,246,0.2)" stroke-width="1" stroke-dasharray="4,4"/>
            <text x="194" y="25" fill="rgba(59,130,246,0.45)" font-size="7" font-family="Space Mono" text-anchor="end">threshold</text>
            <path id="speech-fill" class="mc-chart-fill" fill="url(#speech-grad)" d=""/>
            <path id="speech-line" class="mc-chart-line" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M0,32 50,30 90,34 130,31 170,33 200,32"/>
            <circle id="speech-dot" cx="200" cy="32" r="4" fill="#3b82f6" class="mc-chart-dot chart-dot-glow" style="--dot-delay:1.1s;color:#3b82f6"/>
          </svg></div>
          <div class="mc-explain" id="speech-extra">
            <div class="speech-stats">
              <div class="speech-stat-row"><span class="speech-stat-lbl">Overall WPM</span><span class="speech-stat-val neutral" id="wpm-txt">—</span></div>
              <div class="speech-stat-row"><span class="speech-stat-lbl">Pause Ratio</span><span class="speech-stat-val neutral" id="pause-txt">—</span></div>
              <div class="speech-stat-row"><span class="speech-stat-lbl">Rhythm Spike</span><span class="speech-stat-val neutral" id="spike-txt">—</span></div>
              <div class="speech-stat-row"><span class="speech-stat-lbl">Jitter</span><span class="speech-stat-val neutral" id="jitter-txt">—</span></div>
              <div class="speech-stat-row"><span class="speech-stat-lbl">Shimmer</span><span class="speech-stat-val neutral" id="shimmer-txt">—</span></div>
              <div class="speech-stat-row"><span class="speech-stat-lbl">Words Detected</span><span class="speech-stat-val neutral" id="words-txt">—</span></div>
              <div class="speech-stat-row"><span class="speech-stat-lbl">Coverage</span><span class="speech-stat-val neutral" id="coverage-txt">—</span></div>
            </div>
            <div class="ss-res-lbl" style="margin-top:0.7rem;">WPM rhythm (1s buckets)</div>
            <div class="ss-res-buckets" id="ss-res-buckets"></div>
          </div>
          <div class="delta-row" id="speech-delta-row" style="display:none"><span class="delta-lbl">vs baseline</span><span class="delta-chip flat" id="speech-delta-chip">—</span><span class="delta-baseline-val" id="speech-baseline-val"></span></div>
        </div>
      </div>

      <!-- FEATURE 6: Signal Fingerprint -->
      <div class="fingerprint-card" id="fingerprint-card" style="display:none;">
        <div class="fp-hd">
          <div class="fp-title">Signal Fingerprint</div>
          <div class="fp-tag">vs Baseline</div>
        </div>
        <div class="fp-body">
          <div class="fp-svg-wrap">
            <svg id="fp-svg" width="180" height="180" viewBox="0 0 180 180">
              <defs>
                <filter id="fp-glow"><feGaussianBlur stdDeviation="2.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
              </defs>
              <circle cx="90" cy="90" r="72" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>
              <circle cx="90" cy="90" r="48" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>
              <circle cx="90" cy="90" r="24" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>
              <line x1="90" y1="90" x2="90" y2="18" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>
              <line x1="90" y1="90" x2="27.6" y2="126" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>
              <line x1="90" y1="90" x2="152.4" y2="126" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>
              <text x="90" y="11" text-anchor="middle" font-family="Space Mono" font-size="7.5" fill="rgba(0,229,200,0.8)" letter-spacing="0.05em">FACE</text>
              <text x="16" y="136" text-anchor="middle" font-family="Space Mono" font-size="7.5" fill="rgba(168,85,247,0.8)" letter-spacing="0.05em">ARMS</text>
              <text x="164" y="136" text-anchor="middle" font-family="Space Mono" font-size="7.5" fill="rgba(59,130,246,0.8)" letter-spacing="0.05em">SPEECH</text>
              <polygon id="fp-baseline-poly" points="90,18 27.6,126 152.4,126" fill="rgba(255,255,255,0.025)" stroke="rgba(255,255,255,0.18)" stroke-width="1.5" stroke-dasharray="4,3"/>
              <polygon id="fp-current-poly" points="90,18 27.6,126 152.4,126" fill="rgba(0,229,200,0.07)" stroke="rgba(0,229,200,0.75)" stroke-width="2" stroke-linejoin="round" style="transition:points 0.8s ease;"/>
              <circle id="fp-dot-face" cx="90" cy="18" r="4" fill="#00e5c8" filter="url(#fp-glow)"/>
              <circle id="fp-dot-arms" cx="27.6" cy="126" r="4" fill="#a855f7" filter="url(#fp-glow)"/>
              <circle id="fp-dot-speech" cx="152.4" cy="126" r="4" fill="#3b82f6" filter="url(#fp-glow)"/>
            </svg>
          </div>
          <div class="fp-legend">
            <div class="fp-legend-item">
              <div class="fp-legend-swatch" style="background:#00e5c8;box-shadow:0 0 6px rgba(0,229,200,0.6);"></div>
              <span class="fp-legend-lbl">Face</span>
              <span class="fp-legend-val" id="fp-face-val">—</span>
            </div>
            <div class="fp-legend-item">
              <div class="fp-legend-swatch" style="background:#a855f7;box-shadow:0 0 6px rgba(168,85,247,0.6);"></div>
              <span class="fp-legend-lbl">Arms</span>
              <span class="fp-legend-val" id="fp-arms-val">—</span>
            </div>
            <div class="fp-legend-item">
              <div class="fp-legend-swatch" style="background:#3b82f6;box-shadow:0 0 6px rgba(59,130,246,0.6);"></div>
              <span class="fp-legend-lbl">Speech</span>
              <span class="fp-legend-val" id="fp-speech-val">—</span>
            </div>
            <div style="margin-top:0.6rem;padding-top:0.6rem;border-top:1px solid var(--cbord);">
              <div class="fp-legend-item" style="opacity:0.45;">
                <div class="fp-legend-swatch" style="width:14px;height:3px;border-radius:0;background:transparent;border-top:2px dashed rgba(255,255,255,0.4);margin-top:3px;"></div>
                <span class="fp-legend-lbl" style="font-size:0.75rem;">Baseline shape</span>
              </div>
            </div>
          </div>
        </div>
        <div class="fp-note" id="fp-note">Each axis shows signal intensity relative to its alert threshold. The outer ring = 100% of threshold. A shape matching the dashed baseline means no change detected today.</div>
      </div>

      <!-- Drift card removed -->
      <div class="drift-card" id="drift-card" style="display:none;">
        <div class="drift-hd">
          <div class="drift-title">Baseline Drift Intelligence</div>
          <span class="drift-status-pill stable" id="drift-status-pill">Calibrating</span>
        </div>
        <div class="drift-domains">
          <div class="drift-domain">
            <div class="drift-domain-lbl">Face</div>
            <div class="drift-domain-z" id="drift-z-face">—</div>
            <div class="drift-domain-trend" id="drift-trend-face"><span class="drift-trend-flat">—</span></div>
          </div>
          <div class="drift-domain">
            <div class="drift-domain-lbl">Arms</div>
            <div class="drift-domain-z" id="drift-z-arms">—</div>
            <div class="drift-domain-trend" id="drift-trend-arms"><span class="drift-trend-flat">—</span></div>
          </div>
          <div class="drift-domain">
            <div class="drift-domain-lbl">Speech</div>
            <div class="drift-domain-z" id="drift-z-speech">—</div>
            <div class="drift-domain-trend" id="drift-trend-speech"><span class="drift-trend-flat">—</span></div>
          </div>
        </div>
        <div class="drift-timeline-wrap">
          <div class="drift-timeline-lbl">Drift score — last 10 sessions</div>
          <svg class="drift-timeline-svg" id="drift-timeline-svg" viewBox="0 0 460 60" preserveAspectRatio="none"></svg>
        </div>
        <div class="drift-explain" id="drift-explain">Complete check-ins to see personalised drift analysis.</div>
      </div>

      <div class="previews-row">
        <div class="preview-card">
          <div class="preview-title">Face Landmark Preview</div>
          <div class="preview-canvas">
            <canvas id="face-preview-canvas" style="width:100%;height:100%;display:block;background:#080c17;"></canvas>
          </div>
        </div>
        <div class="preview-card">
          <div class="preview-title">Pose Keypoints Preview</div>
          <div class="preview-canvas">
            <canvas id="pose-preview-canvas" style="width:100%;height:100%;display:block;background:#080c17;"></canvas>
          </div>
        </div>
      </div>

      <div class="action-panel green" id="action-panel">
        <div class="act-text">
          <h4 id="act-title">No warning signals detected.</h4>
          <p id="act-desc">All three FAST indicators are within typical range. Consider tracking these patterns over time to establish your personal baseline. If you ever notice sudden changes, seek care immediately.</p>
        </div>
        <div class="act-btns">
          <button class="act-btn-p" onclick="saveAndHistory()">Save & View History</button>
          <button class="act-btn-s" onclick="goRecord()">Retake</button>
          <button class="act-btn-export" onclick="generateSummary('green',0,0,0,0,0,0,0)">📋 Summary</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ══ SCREEN: HISTORY ══ -->
  <div class="app-screen" id="screen-history">
    <div class="history-wrap">
      <div style="margin-bottom:1.75rem;display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
        <div>
          <h2 class="hist-hd-title">Your Check-In History</h2>
          <p class="hist-hd-sub">Stored locally on your device only. Track patterns over time — not individual moments.</p>
        </div>
        <span id="hist-bc-pill" class="bc-pill low" style="margin-top:0.25rem;" tabindex="0">
          <svg class="bc-ring-svg" width="20" height="20" viewBox="0 0 20 20">
            <circle class="bc-ring-track" cx="10" cy="10" r="7"/>
            <circle id="hist-conf-ring" class="bc-ring-fill" cx="10" cy="10" r="7" stroke-dasharray="43.98" stroke-dashoffset="43.98" transform="rotate(-90 10 10)"/>
            <circle id="hist-conf-tip" class="bc-ring-tip" cx="10" cy="3" r="1.8" opacity="0"/>
          </svg>
          <span id="hist-bc-text">Calibrating</span>
          <span class="bc-breakdown">
            <div class="bcd-title">Confidence Drivers</div>
            <div class="bcd-row"><span class="bcd-row-lbl">Check-ins</span><span class="bcd-checkins bcd-row-val">0 / 8</span></div>
            <div class="bcd-row"><span class="bcd-row-lbl">Avg quality</span><span class="bcd-quality bcd-row-val">—</span></div>
            <div class="bcd-bar"><div class="bcd-bar-fill" style="width:0%"></div></div>
            <div class="bcd-nextstep">Complete more check-ins to improve confidence.</div>
          </span>
        </span>
      </div>
      <!-- Action buttons -->
      <div style="margin-bottom:1.4rem;display:flex;gap:0.9rem;flex-wrap:wrap;">
        <button class="btn-primary" onclick="stopPreviewLoop();showScreen('home')" style="font-size:0.875rem;padding:0.7rem 1.9rem;">+ New Check-In</button>
        <button class="btn-ghost" onclick="generateHistSummary()" style="font-size:0.875rem;padding:0.7rem 1.9rem;">📋 Generate Summary</button>
        <button class="btn-ghost" onclick="clearHist()" style="font-size:0.875rem;padding:0.7rem 1.9rem;">Clear History</button>
        <button class="btn-ghost" onclick="clearBaseline()" id="btn-clear-baseline" style="font-size:0.875rem;padding:0.7rem 1.9rem;display:none;">Reset Baseline</button>
        <button id="btn-demo-populate" onclick="populateDemoHistory()" title="Demo: populate sample history" style="font-size:0.875rem;padding:0.7rem 1.2rem;background:none;border:1px solid rgba(255,255,255,0.05);color:rgba(255,255,255,0.1);border-radius:100px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.3s;" onmouseover="this.style.borderColor='rgba(0,229,200,0.35)';this.style.color='rgba(0,229,200,0.5)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.05)';this.style.color='rgba(255,255,255,0.1)';">◈</button>
      </div>
      <!-- FEATURE 4: Monitoring Streak -->
      <div class="streak-card" id="streak-card">
        <div class="streak-flame" id="streak-flame">🔥</div>
        <div class="streak-info">
          <div class="streak-count"><span id="streak-num">0</span><span>day streak</span></div>
          <div class="streak-sub" id="streak-sub">Start your first check-in to begin tracking.</div>
          <div class="streak-dots" id="streak-dots"></div>
        </div>
        <div class="streak-cadence" id="streak-cadence">No data</div>
      </div>

      <div class="hcc">
        <div class="hcc-hd"><div class="hcc-title">Risk Index — Recent Trend</div><div class="hcc-period" id="hist-period">No data yet</div></div>
        <div class="hcc-area">
          <svg id="hist-svg" viewBox="0 0 820 180" preserveAspectRatio="none">
            <defs>
              <linearGradient id="hg" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#00e5c8" stop-opacity="0.25"/><stop offset="100%" stop-color="#00e5c8" stop-opacity="0"/></linearGradient>
            </defs>
            <line x1="0" y1="60" x2="820" y2="60" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>
            <line x1="0" y1="120" x2="820" y2="120" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>
            <line id="hist-baseline-line" x1="0" y1="80" x2="820" y2="80" stroke="rgba(0,229,200,0.2)" stroke-width="1" stroke-dasharray="6,5" display="none"/>
            <text id="hist-baseline-lbl" x="810" y="76" fill="rgba(0,229,200,0.5)" font-size="11" font-family="Space Mono" text-anchor="end" display="none">baseline</text>
            <path id="hist-fill" fill="url(#hg)" d=""/>
            <path id="hist-line" fill="none" stroke="#00e5c8" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d=""/>
            <g id="hist-dots"></g>
            <text id="hist-empty" x="10" y="170" fill="#6b7280" font-size="12" font-family="Space Mono">Complete your first check-in to see trends here.</text>
          </svg>
        </div>
      </div>

      <!-- Per-metric mini charts -->
      <div class="hist-metric-charts" id="hist-metric-charts" style="display:none;">
        <div class="hmc-card face">
          <div class="hmc-hd"><div class="hmc-ico">😐</div><div class="hmc-ttl">Facial Asymmetry</div><div class="hmc-unit">index</div></div>
          <div class="hmc-area"><svg id="hmc-face-svg" viewBox="0 0 400 100" preserveAspectRatio="none" style="width:100%;height:100%;overflow:visible;">
            <defs><linearGradient id="hmc-fg" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#00e5c8" stop-opacity="0.3"/><stop offset="100%" stop-color="#00e5c8" stop-opacity="0"/></linearGradient></defs>
            <line x1="0" y1="88" x2="400" y2="88" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
            <line id="hmc-face-bline" x1="0" y1="50" x2="400" y2="50" stroke="rgba(0,229,200,0.2)" stroke-width="1" stroke-dasharray="5,4" display="none"/>
            <text id="hmc-face-blbl" x="395" y="46" fill="rgba(0,229,200,0.45)" font-size="8" font-family="Space Mono" text-anchor="end" display="none">baseline</text>
            <path id="hmc-face-fill" fill="url(#hmc-fg)" d=""/><path id="hmc-face-line" fill="none" stroke="#00e5c8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d=""/>
            <g id="hmc-face-dots"></g>
          </svg></div>
        </div>
        <div class="hmc-card arms">
          <div class="hmc-hd"><div class="hmc-ico">🙌</div><div class="hmc-ttl">Arm Drift</div><div class="hmc-unit">% over 5s</div></div>
          <div class="hmc-area"><svg id="hmc-arms-svg" viewBox="0 0 400 100" preserveAspectRatio="none" style="width:100%;height:100%;overflow:visible;">
            <defs><linearGradient id="hmc-ag" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#a855f7" stop-opacity="0.3"/><stop offset="100%" stop-color="#a855f7" stop-opacity="0"/></linearGradient></defs>
            <line x1="0" y1="88" x2="400" y2="88" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
            <line id="hmc-arms-bline" x1="0" y1="50" x2="400" y2="50" stroke="rgba(168,85,247,0.2)" stroke-width="1" stroke-dasharray="5,4" display="none"/>
            <text id="hmc-arms-blbl" x="395" y="46" fill="rgba(168,85,247,0.45)" font-size="8" font-family="Space Mono" text-anchor="end" display="none">baseline</text>
            <path id="hmc-arms-fill" fill="url(#hmc-ag)" d=""/><path id="hmc-arms-line" fill="none" stroke="#a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d=""/>
            <g id="hmc-arms-dots"></g>
          </svg></div>
        </div>
        <div class="hmc-card speech">
          <div class="hmc-hd"><div class="hmc-ico">🗣️</div><div class="hmc-ttl">Speech Pause Ratio</div><div class="hmc-unit">silence ratio</div></div>
          <div class="hmc-area"><svg id="hmc-speech-svg" viewBox="0 0 400 100" preserveAspectRatio="none" style="width:100%;height:100%;overflow:visible;">
            <defs><linearGradient id="hmc-sg" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/></linearGradient></defs>
            <line x1="0" y1="88" x2="400" y2="88" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
            <line id="hmc-speech-bline" x1="0" y1="50" x2="400" y2="50" stroke="rgba(59,130,246,0.2)" stroke-width="1" stroke-dasharray="5,4" display="none"/>
            <text id="hmc-speech-blbl" x="395" y="46" fill="rgba(59,130,246,0.45)" font-size="8" font-family="Space Mono" text-anchor="end" display="none">baseline</text>
            <path id="hmc-speech-fill" fill="url(#hmc-sg)" d=""/><path id="hmc-speech-line" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d=""/>
            <g id="hmc-speech-dots"></g>
          </svg></div>
        </div>
      </div>

<div class="hist-entries" id="hist-entries">
        <div class="hist-empty"><h3>No check-ins yet</h3><p>Complete your first FAST check-in to start tracking.</p></div>
      </div>
    </div>
  </div>

  <!-- ══ VIDEO REPLAY MODAL ══ -->
  <div id="video-replay-modal" style="display:none;position:fixed;inset:0;z-index:700;background:rgba(6,8,15,0.96);backdrop-filter:blur(20px);overflow-y:auto;">
    <div style="max-width:1300px;margin:0 auto;padding:2rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;">
        <div>
          <div style="font-family:'Space Mono',monospace;font-size:0.62rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--muted);margin-bottom:0.3rem;">Recording Replay</div>
          <h2 style="font-family:'DM Serif Display',serif;font-size:1.6rem;letter-spacing:-0.02em;" id="replay-title">Check-In</h2>
        </div>
        <button onclick="closeReplayModal()" style="background:none;border:1px solid var(--cbord);color:var(--muted);padding:0.4rem 1.1rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.85rem;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">✕ Close</button>
      </div>

      <div style="margin-bottom:1.25rem;">
        <!-- Full-width video — larger for better viewing -->
        <div style="position:relative;border-radius:20px;overflow:hidden;background:#000;aspect-ratio:16/9;border:1px solid var(--cbord);margin-bottom:0.75rem;min-height:360px;box-shadow:0 8px 40px rgba(0,0,0,0.5);">
          <video id="replay-video" style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1);" playsinline></video>
          <canvas id="replay-pose-canvas" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;transform:scaleX(-1);"></canvas>
          <canvas id="replay-face-canvas" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;transform:scaleX(-1);"></canvas>
          <!-- Play button overlay -->
          <div id="replay-play-btn" onclick="replayTogglePlay()" style="display:none;position:absolute;inset:0;align-items:center;justify-content:center;cursor:pointer;background:rgba(6,8,15,0.35);transition:background 0.2s;" onmouseover="this.style.background='rgba(6,8,15,0.5)'" onmouseout="this.style.background='rgba(6,8,15,0.35)'">
            <div style="width:72px;height:72px;background:rgba(0,229,200,0.15);border:2px solid rgba(0,229,200,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 40px rgba(0,229,200,0.3);">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" style="margin-left:4px;"><polygon points="6,4 20,12 6,20" fill="#00e5c8"/></svg>
            </div>
          </div>
          <div id="replay-no-video" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(6,8,15,0.9);">
            <div style="font-size:2rem;margin-bottom:0.75rem;">🎬</div>
            <div style="font-family:'Space Mono',monospace;font-size:0.68rem;letter-spacing:0.1em;color:var(--muted);text-align:center;padding:0 1rem;">Video not available<br>for this recording.<br>Only new check-ins are saved.</div>
          </div>
          <div id="replay-overlay-label" style="display:none;position:absolute;top:0.75rem;left:0.75rem;font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;color:var(--teal);background:rgba(6,8,15,0.8);padding:0.25rem 0.6rem;border-radius:100px;border:1px solid rgba(0,229,200,0.2);">📐 Overlay</div>
        </div>

        <!-- Video progress bar + controls -->
        <div class="vp-controls" id="vp-controls" style="display:none;">
          <button class="vp-play-btn" id="vp-play-btn" onclick="replayTogglePlay()" title="Play / Pause">
            <svg id="vp-play-icon" width="14" height="14" viewBox="0 0 24 24" fill="none"><polygon points="6,4 20,12 6,20" fill="currentColor"/></svg>
          </button>
          <span class="vp-time" id="vp-time">0:00 / 0:00</span>
          <div class="vp-scrub-wrap" id="vp-scrub-wrap">
            <div class="vp-scrub-track">
              <div class="vp-scrub-fill" id="vp-scrub-fill"></div>
            </div>
            <div class="vp-scrub-thumb" id="vp-scrub-thumb"></div>
          </div>
        </div>
        <!-- Scores row -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:0.75rem;align-items:stretch;" id="replay-grid">
          <div class="replay-score-card" id="replay-score-face">
            <div class="replay-score-ico">😐</div>
            <div style="flex:1"><div class="replay-score-lbl">Face</div><div class="replay-score-val" id="replay-face-val">—</div></div>
            <div class="replay-badge" id="replay-face-badge">—</div>
          </div>
          <div class="replay-score-card" id="replay-score-arms">
            <div class="replay-score-ico">🙌</div>
            <div style="flex:1"><div class="replay-score-lbl">Arms</div><div class="replay-score-val" id="replay-arms-val">—</div></div>
            <div class="replay-badge" id="replay-arms-badge">—</div>
          </div>
          <div class="replay-score-card" id="replay-score-speech">
            <div class="replay-score-ico">🗣️</div>
            <div style="flex:1"><div class="replay-score-lbl">Speech</div><div class="replay-score-val" id="replay-speech-val">—</div></div>
            <div class="replay-badge" id="replay-speech-badge">—</div>
          </div>
          <div style="padding:0.85rem 1rem;background:var(--cb);border:1px solid var(--cbord);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.2rem;">
            <div style="font-family:'Space Mono',monospace;font-size:0.55rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);">Risk Index</div>
            <div style="font-family:'DM Serif Display',serif;font-size:1.6rem;" id="replay-total-val">—</div>
          </div>
          <div id="replay-overlay-toggle-wrap">
            <div style="display:flex;flex-direction:column;gap:0.6rem;padding:1rem 1.25rem;background:var(--cb);border:1px solid var(--cbord);border-radius:14px;min-width:160px;">
              <div style="font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);text-align:center;margin-bottom:0.15rem;">Overlay</div>
              <div id="replay-overlay-no-video-note" style="display:none;font-family:'DM Sans',sans-serif;font-size:0.72rem;color:var(--muted);text-align:center;line-height:1.4;padding:0.2rem 0;">No video —<br>overlays unavailable</div>
              <!-- Pose toggle -->
              <div style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem;">
                <span style="font-family:'DM Sans',sans-serif;font-size:0.82rem;color:var(--text);">🦴 Pose</span>
                <label id="replay-pose-toggle-label" style="position:relative;display:inline-block;width:38px;height:22px;cursor:pointer;">
                  <input type="checkbox" id="replay-pose-toggle-cb" onchange="handleOverlayToggle('pose',this.checked)" style="opacity:0;width:0;height:0;">
                  <span id="replay-pose-toggle-track" style="position:absolute;inset:0;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:11px;transition:all 0.25s;"></span>
                  <span id="replay-pose-toggle-thumb" style="position:absolute;top:3px;left:3px;width:16px;height:16px;background:var(--muted);border-radius:50%;transition:all 0.25s;"></span>
                </label>
              </div>
              <!-- Face toggle -->
              <div style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem;">
                <span style="font-family:'DM Sans',sans-serif;font-size:0.82rem;color:var(--text);">😐 Face</span>
                <label id="replay-face-toggle-label" style="position:relative;display:inline-block;width:38px;height:22px;cursor:pointer;">
                  <input type="checkbox" id="replay-face-toggle-cb" onchange="handleOverlayToggle('face',this.checked)" style="opacity:0;width:0;height:0;">
                  <span id="replay-face-toggle-track" style="position:absolute;inset:0;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:11px;transition:all 0.25s;"></span>
                  <span id="replay-face-toggle-thumb" style="position:absolute;top:3px;left:3px;width:16px;height:16px;background:var(--muted);border-radius:50%;transition:all 0.25s;"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="replay-note" style="font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.06em;text-align:center;padding:0.75rem 1rem;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--cbord);">
        Video recordings are stored in memory for this session only and are not uploaded or saved to disk.
      </div>
    </div>
  </div>

<!-- Quality Gate Overlay -->
<div id="qg-overlay" class="qg-overlay" style="display:none;">
  <div class="qg-box" id="qg-box">
    <div class="qg-icon" id="qg-icon">✅</div>
    <h3 class="qg-title" id="qg-title">Signal Quality OK</h3>
    <p class="qg-desc" id="qg-desc">All four signal channels look good. Running analysis now.</p>
    <div class="qg-score-row" id="qg-score-row">
      <div class="qg-score-item"><div class="qg-score-lbl">Lighting</div><div class="qg-score-v good" id="qg-s-light">Good</div></div>
      <div class="qg-score-item"><div class="qg-score-lbl">Framing</div><div class="qg-score-v good" id="qg-s-face">Good</div></div>
      <div class="qg-score-item"><div class="qg-score-lbl">Body</div><div class="qg-score-v good" id="qg-s-body">Good</div></div>
      <div class="qg-score-item"><div class="qg-score-lbl">Audio</div><div class="qg-score-v good" id="qg-s-audio">Good</div></div>
    </div>
    <div class="qg-btns" id="qg-btns">
      <button class="qg-proceed" id="qg-btn-proceed" onclick="proceedFromGate()">Analyze Now →</button>
    </div>
    <div class="qg-ethos">"We block low-quality signals to avoid misleading you. Accuracy matters more than speed."</div>
  </div>
</div>

</div><!-- #fast-app -->

<!-- ── SETTINGS SCREEN ── -->
<!-- NOTE: This is outside fast-app intentionally — it's a full-page overlay like HIW -->
<div id="settings-overlay" style="display:none;position:fixed;inset:0;z-index:510;background:var(--bg);overflow-y:auto;">
  <div style="position:sticky;top:0;z-index:200;display:flex;align-items:center;justify-content:space-between;padding:1rem 2.5rem;background:rgba(6,8,15,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--cbord);">
    <div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--teal);">Baseline <span style="font-family:'Space Mono',monospace;font-size:0.6rem;color:var(--muted);letter-spacing:0.05em;">/ Settings</span></div>
    <button onclick="closeSettings()" style="background:none;border:1px solid var(--cbord);color:var(--muted);padding:0.32rem 0.9rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.78rem;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">← Back</button>
  </div>

  <div style="max-width:680px;margin:0 auto;padding:2.5rem 2rem 5rem;display:flex;flex-direction:column;gap:1.5rem;">

    <!-- APPEARANCE -->
    <div style="background:var(--surface);border:1px solid var(--cbord);border-radius:16px;padding:1.75rem;">
      <div style="font-family:'DM Serif Display',serif;font-size:1.15rem;margin-bottom:0.35rem;">Appearance</div>
      <div style="color:var(--muted);font-size:0.875rem;margin-bottom:1.5rem;">Customize the look and feel of the app.</div>

      <!-- Accent color -->
      <div style="margin-bottom:0.5rem;">
        <div style="font-size:0.9rem;font-weight:500;margin-bottom:0.25rem;">Theme</div>
        <div style="font-size:0.8rem;color:var(--muted);margin-bottom:0.85rem;">Switch between dark and light mode.</div>
        <div style="display:flex;align-items:center;gap:1rem;">
          <span style="font-size:0.85rem;color:var(--muted);" id="theme-dark-label">🌙 Dark</span>
          <label style="position:relative;display:inline-block;width:50px;height:28px;cursor:pointer;" title="Toggle dark/light mode">
            <input type="checkbox" id="tog-theme" onchange="applyThemeToggle(this.checked)" style="opacity:0;width:0;height:0;">
            <span id="theme-toggle-track" style="position:absolute;inset:0;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:14px;transition:all 0.3s;"></span>
            <span id="theme-toggle-thumb" style="position:absolute;top:4px;left:4px;width:20px;height:20px;background:var(--muted);border-radius:50%;transition:all 0.3s;display:flex;align-items:center;justify-content:center;font-size:11px;"></span>
          </label>
          <span style="font-size:0.85rem;color:var(--muted);" id="theme-light-label">☀️ Light</span>
        </div>
      </div>

      <!-- Accent color ends, nothing more in Appearance -->
    </div>

    <!-- ACCESSIBILITY -->
    <div style="background:var(--surface);border:1px solid var(--cbord);border-radius:16px;padding:1.75rem;">
      <div style="font-family:'DM Serif Display',serif;font-size:1.15rem;margin-bottom:0.35rem;">Accessibility</div>
      <div style="color:var(--muted);font-size:0.875rem;margin-bottom:1.5rem;">Improve usability and reduce visual stress.</div>

      <div class="st-row">
        <div class="st-row-info"><div class="st-row-lbl">Reduce Motion</div><div class="st-row-sub">Disables non-essential animations. Helpful for motion sensitivity.</div></div>
        <label class="st-toggle"><input type="checkbox" id="tog-motion" onchange="applyReduceMotion(this.checked)"><span class="st-slider"></span></label>
      </div>
      <div class="st-row">
        <div class="st-row-info"><div class="st-row-lbl">High Contrast</div><div class="st-row-sub">Increases border and text contrast for bright environments.</div></div>
        <label class="st-toggle"><input type="checkbox" id="tog-contrast" onchange="applyHighContrast(this.checked)"><span class="st-slider"></span></label>
      </div>
      <div class="st-row">
        <div class="st-row-info"><div class="st-row-lbl">Dyslexia-Friendly Font</div><div class="st-row-sub">Switches body text to OpenDyslexic for improved readability.</div></div>
        <label class="st-toggle"><input type="checkbox" id="tog-dyslexia" onchange="applyDyslexiaFont(this.checked)"><span class="st-slider"></span></label>
      </div>
      <div class="st-row" style="border-bottom:none;padding-bottom:0;">
        <div class="st-row-info"><div class="st-row-lbl">Larger Touch Targets</div><div class="st-row-sub">Makes buttons bigger and easier to tap on touchscreens.</div></div>
        <label class="st-toggle"><input type="checkbox" id="tog-touch" onchange="applyLargeTouchTargets(this.checked)"><span class="st-slider"></span></label>
      </div>
    </div>

    <!-- NOTIFICATIONS -->
    <div style="background:var(--surface);border:1px solid var(--cbord);border-radius:16px;padding:1.75rem;">
      <div style="font-family:'DM Serif Display',serif;font-size:1.15rem;margin-bottom:0.35rem;">Check-In Reminders</div>
      <div style="color:var(--muted);font-size:0.875rem;margin-bottom:1.5rem;">Receive device notifications reminding you to do a FAST check-in. Notifications are sent from this browser and require permission.</div>

      <!-- Enable toggle -->
      <div class="st-row">
        <div class="st-row-info"><div class="st-row-lbl">Enable reminders</div><div class="st-row-sub" id="notif-perm-status">Grant notification permission to use this feature.</div></div>
        <label class="st-toggle"><input type="checkbox" id="tog-notif" onchange="handleNotifToggle(this.checked)"><span class="st-slider"></span></label>
      </div>
      <!-- Demo button -->
      <div style="padding:0.75rem 0 0.25rem;">
        <button onclick="sendDemoNotif()" style="display:inline-flex;align-items:center;gap:0.5rem;background:var(--cb);border:1px solid var(--cbord);color:var(--muted);padding:0.4rem 1rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.78rem;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.color='var(--text)';this.style.borderColor='rgba(255,255,255,0.2)'" onmouseout="this.style.color='var(--muted)';this.style.borderColor='var(--cbord)'">🔔 Send a test notification</button>
      </div>

      <!-- Options (shown only when enabled) -->
      <div id="notif-options" style="display:none;padding-top:1rem;">
        <!-- Count -->
        <div style="margin-bottom:1.25rem;">
          <div style="font-size:0.9rem;font-weight:500;margin-bottom:0.2rem;">Reminders per day: <span id="notif-count-lbl" style="color:var(--teal);font-family:'Space Mono',monospace;">3</span></div>
          <div style="font-size:0.8rem;color:var(--muted);margin-bottom:0.6rem;">How many check-in prompts to send throughout the day.</div>
          <input type="range" id="notif-count" min="1" max="10" value="3" oninput="updateNotifPreview()" style="width:100%;-webkit-appearance:none;appearance:none;height:4px;border-radius:2px;background:rgba(255,255,255,0.1);outline:none;cursor:pointer;">
        </div>
        <!-- Time window -->
        <div style="margin-bottom:1.25rem;padding-top:1.25rem;border-top:1px solid var(--cbord);">
          <div style="font-size:0.9rem;font-weight:500;margin-bottom:0.2rem;">Active window</div>
          <div style="font-size:0.8rem;color:var(--muted);margin-bottom:0.6rem;">Notifications will only be sent within this time range.</div>
          <div style="display:flex;gap:1rem;flex-wrap:wrap;">
            <div style="display:flex;flex-direction:column;gap:0.3rem;flex:1;min-width:120px;">
              <label style="font-family:'Space Mono',monospace;font-size:0.63rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);">From</label>
              <input type="time" id="notif-start" value="08:00" oninput="updateNotifPreview()" style="background:var(--cb);border:1px solid var(--cbord);border-radius:8px;color:var(--text);font-family:'Space Mono',monospace;font-size:0.85rem;padding:0.5rem 0.75rem;cursor:pointer;outline:none;width:100%;">
            </div>
            <div style="display:flex;flex-direction:column;gap:0.3rem;flex:1;min-width:120px;">
              <label style="font-family:'Space Mono',monospace;font-size:0.63rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);">To</label>
              <input type="time" id="notif-end" value="21:00" oninput="updateNotifPreview()" style="background:var(--cb);border:1px solid var(--cbord);border-radius:8px;color:var(--text);font-family:'Space Mono',monospace;font-size:0.85rem;padding:0.5rem 0.75rem;cursor:pointer;outline:none;width:100%;">
            </div>
          </div>
        </div>
        <!-- Preview -->
        <div id="notif-preview" style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;background:rgba(0,229,200,0.05);border:1px solid rgba(0,229,200,0.15);border-radius:10px;font-family:'Space Mono',monospace;font-size:0.78rem;color:var(--teal);line-height:1.5;">
          ⏰ &nbsp;3 reminders · 08:00 – 21:00 · ~4h 20m apart
        </div>
      </div>
    </div>

  </div>
</div>



<!-- ═══════════════════ HOW IT WORKS OVERLAY ═══════════════════ -->
<div id="hiw-overlay" style="display:none;position:fixed;inset:0;z-index:600;background:var(--bg);overflow-y:auto;">

  <div class="hiw-nav">
    <div style="display:flex;align-items:baseline;gap:0.4rem;">
      <span class="hiw-nav-logo" onclick="closeHowItWorks()" style="cursor:pointer;">Baseline</span>
      <span class="hiw-nav-sub">/ How It Works</span>
    </div>
    <button class="hiw-back" onclick="closeHowItWorks()">← Back</button>
  </div>

  <div class="hiw-body">

    <div class="hiw-hero">
      <div class="hiw-tag">How It Works</div>
      <h1 class="hiw-title">Only 30 seconds<br>Three signals.<br><em>Your</em> baseline.</h1>
      <p class="hiw-sub">Baseline runs the FAST neurological screening protocol — used by emergency physicians worldwide — using nothing but your camera and microphone. Here's exactly what happens when you hit Record.</p>
    </div>

    <!-- THE THREE TASKS -->
    <div class="hiw-section">
      <div class="hiw-section-tag">The Check-In</div>
      <h2 class="hiw-section-title">Three tasks, run back to back.</h2>
      <p class="hiw-section-desc">The entire check-in takes about 30 seconds — up to 35 with pauses. Each task targets one axis of the FAST protocol: Face, Arms, Speech. Nothing is stored on any server — all processing happens in your browser.</p>
      <div class="hiw-steps">
        <div class="hiw-step">
          <div class="hiw-step-num teal">01</div>
          <div class="hiw-step-info">
            <h4>😐 &nbsp;Neutral Face — 5 seconds</h4>
            <p>Hold a relaxed, neutral expression while looking at the camera. MediaPipe FaceLandmarker tracks 478 facial landmarks in real time, measuring the vertical and horizontal positions of your mouth corners, eye corners, and brow symmetry. The left/right delta is your facial asymmetry index.</p>
            <div class="hiw-step-note">→ What we measure: mouth corner Δy, eye corner Δy, overall symmetry score</div>
          </div>
        </div>
        <div class="hiw-step">
          <div class="hiw-step-num violet">02</div>
          <div class="hiw-step-info">
            <h4>🙌 &nbsp;Raise Both Arms — 10 seconds</h4>
            <p>Extend both arms out to shoulder height and hold them steady. MediaPipe PoseLandmarker tracks your left and right wrist landmarks across every frame. We measure the height difference between the two wrists over time — a sustained drop on one side indicates arm drift, a classic stroke warning sign.</p>
            <div class="hiw-step-note">→ What we measure: left/right wrist Δy over 5s, maximum drift percentage</div>
          </div>
        </div>
        <div class="hiw-step">
          <div class="hiw-step-num blue">03</div>
          <div class="hiw-step-info">
            <h4>🗣️ &nbsp;Read the Passage — 20 seconds</h4>
            <p>A short passage appears on screen. Read it aloud at your natural pace — don't rush. The Web Speech API transcribes in real time and we track words per minute every 3 seconds. Sudden spikes or dips — deviating more than 40% from your median pace — are flagged as clinically significant, since stroke-related speech difficulty often manifests as uneven, halting rhythm rather than uniformly slow speech.</p>
            <div class="hiw-step-note">→ What we measure: overall WPM, per-3s WPM buckets, spike/dip detection, pause ratio vs baseline</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SIGNAL ANALYSIS -->
    <div class="hiw-section">
      <div class="hiw-section-tag">Signal Analysis</div>
      <h2 class="hiw-section-title">What the signals actually mean.</h2>
      <p class="hiw-section-desc">Each signal is derived from the same FAST criteria used by paramedics and emergency physicians. The difference: we compare against <em>your personal baseline</em>, not a population average.</p>
      <div class="hiw-signal-grid">
        <div class="hiw-signal">
          <div class="hiw-signal-icon">😐</div>
          <h4>Facial Asymmetry Index</h4>
          <p>Measures how different the left and right sides of your face are. A naturally asymmetric face has a stable baseline — we flag deviations from that personal norm, not absolute asymmetry.</p>
          <div class="hiw-signal-metric">THRESHOLD · &gt;0.08 deviation from baseline triggers a flag</div>
        </div>
        <div class="hiw-signal">
          <div class="hiw-signal-icon">🦾</div>
          <h4>Arm Drift Percentage</h4>
          <p>The percentage drop in wrist height on the weaker side over the 5-second hold. A sudden 8%+ drop on one side, compared to your baseline range, is a potential motor weakness signal.</p>
          <div class="hiw-signal-metric">THRESHOLD · &gt;8% drift vs baseline triggers a flag</div>
        </div>
        <div class="hiw-signal">
          <div class="hiw-signal-icon">〰️</div>
          <h4>Pause Ratio</h4>
          <p>The fraction of the recording window that is silence. Higher pause ratio can indicate hesitation or difficulty formulating words — a cognitive symptom that precedes audible slurring in some stroke presentations.</p>
          <div class="hiw-signal-metric">THRESHOLD · &gt;0.35 silence ratio vs baseline triggers a flag</div>
        </div>
        <div class="hiw-signal">
          <div class="hiw-signal-icon">⏱️</div>
          <h4>Words Per Minute</h4>
          <p>Measured live during the phrase task using the Web Speech API. A sudden drop in speaking rate — especially combined with elevated pause ratio — strengthens the speech clarity signal.</p>
          <div class="hiw-signal-metric">COMPARED · measured live, tracked against your baseline WPM</div>
        </div>
      </div>
    </div>

    <!-- THE BASELINE -->
    <div class="hiw-section">
      <div class="hiw-section-tag">Your Baseline</div>
      <h2 class="hiw-section-title">Compared only to yourself.</h2>
      <p class="hiw-section-desc">Before your first FAST Check, you record a baseline on a day you feel well. That recording becomes your personal reference — every future check-in is measured as a delta from your own values, not against population statistics.</p>
      <div class="hiw-steps">
        <div class="hiw-step">
          <div class="hiw-step-num teal">📐</div>
          <div class="hiw-step-info">
            <h4>Why a personal baseline?</h4>
            <p>Natural asymmetry is common. Many people have a slightly lower mouth corner, a dominant arm, or a naturally slow speaking pace. Without a personal baseline, these traits would trigger false alarms. With one, we only flag when <em>your specific signals</em> shift from <em>your specific normal</em>.</p>
          </div>
        </div>
        <div class="hiw-step">
          <div class="hiw-step-num violet">📈</div>
          <div class="hiw-step-info">
            <h4>How confidence builds over time</h4>
            <p>The Baseline Confidence Meter shows how reliable your trend analysis is. Early check-ins are labelled <span style="color:var(--yellow)">Low Confidence</span> — results are shown but alerts are withheld. After 7+ quality check-ins, the system reaches <span style="color:var(--green)">High Confidence</span> and can issue stronger signals.</p>
          </div>
        </div>
        <div class="hiw-step">
          <div class="hiw-step-num blue">🔒</div>
          <div class="hiw-step-info">
            <h4>Where is your data stored?</h4>
            <p>Everything is stored in your browser's localStorage — it never leaves your device. No account required. No servers. Your baseline, history, and quality scores exist only in your browser. Clearing your browser data or using a private window will erase it.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- QUALITY GATE -->
    <div class="hiw-section">
      <div class="hiw-section-tag">Signal Quality</div>
      <h2 class="hiw-section-title">We block bad data before it misleads you.</h2>
      <p class="hiw-section-desc">Before showing you results, every recording passes through a four-channel Signal Quality Gate. If the recording isn't trustworthy enough, we say so — and offer a retake rather than a misleading result.</p>
      <div class="hiw-steps">
        <div class="hiw-step">
          <div class="hiw-step-num teal">💡</div>
          <div class="hiw-step-info">
            <h4>Lighting</h4>
            <p>Measured from live camera frames using canvas pixel analysis. Average luminance must be above 80 for a borderline pass, and above 110 for a confident pass. Face landmark accuracy degrades sharply in low light — we catch this before it corrupts your result.</p>
          </div>
        </div>
        <div class="hiw-step">
          <div class="hiw-step-num violet">👤</div>
          <div class="hiw-step-info">
            <h4>Face Framing</h4>
            <p>We check that the upper-center region of the frame (where your face should be) is adequately bright and centered. If you're too far back, side-on, or poorly lit in the face region, framing fails before recording begins.</p>
          </div>
        </div>
        <div class="hiw-step">
          <div class="hiw-step-num blue">🦴</div>
          <div class="hiw-step-info">
            <h4>Body Visibility</h4>
            <p>MediaPipe PoseLandmarker tracks whether both shoulders and both wrists are visible and within the frame with ≥55% detection confidence. The score is smoothed over a 24-frame rolling window to avoid jitter.</p>
          </div>
        </div>
        <div class="hiw-step">
          <div class="hiw-step-num teal">🎙️</div>
          <div class="hiw-step-info">
            <h4>Audio Clarity</h4>
            <p>Audio quality is currently assessed as a proxy signal. Full microphone level monitoring via the Web Audio API is on the roadmap — for now, this channel is simulated to give a composite quality score alongside the three real channels.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- FAQ -->
    <div class="hiw-section">
      <div class="hiw-section-tag">FAQ</div>
      <h2 class="hiw-section-title">Common questions.</h2>
      <div class="hiw-faq">
        <div class="hiw-faq-item">
          <div class="hiw-faq-q" onclick="this.parentElement.classList.toggle('open')">Is this a medical device? <span>+</span></div>
          <div class="hiw-faq-a">No. Anchor is an informational awareness tool, not a medical device. It cannot diagnose stroke or any other condition. It is designed to help you notice changes in your own signals over time and act faster if something seems wrong. If you have any sudden neurological symptoms, call emergency services immediately — do not wait for a check-in.</div>
        </div>
        <div class="hiw-faq-item">
          <div class="hiw-faq-q" onclick="this.parentElement.classList.toggle('open')">Does it work for all ages? <span>+</span></div>
          <div class="hiw-faq-a">Yes. The FAST protocol is used across all adult age groups. Stroke incidence in people under 50 is rising, and regular baseline monitoring is useful at any age. The personal baseline approach means the system adapts to your individual norms regardless of age.</div>
        </div>
        <div class="hiw-faq-item">
          <div class="hiw-faq-q" onclick="this.parentElement.classList.toggle('open')">How accurate is the face landmark detection? <span>+</span></div>
          <div class="hiw-faq-a">Anchor uses MediaPipe FaceLandmarker with the full face_landmarker model, which tracks 478 facial landmarks. Accuracy is high in good lighting with the face properly centered in frame — which is why the Signal Quality Gate checks both before allowing a recording to proceed.</div>
        </div>
        <div class="hiw-faq-item">
          <div class="hiw-faq-q" onclick="this.parentElement.classList.toggle('open')">What if I wear glasses or have a beard? <span>+</span></div>
          <div class="hiw-faq-a">MediaPipe's face detection handles most common occlusions well. Glasses have minimal impact on landmark accuracy. Dense beards may slightly affect lower-face landmark precision — but since we're measuring symmetry as a delta from your own baseline (which was also recorded with your beard), the comparative result remains valid.</div>
        </div>
        <div class="hiw-faq-item">
          <div class="hiw-faq-q" onclick="this.parentElement.classList.toggle('open')">Does it work on mobile? <span>+</span></div>
          <div class="hiw-faq-a">Anchor works on modern mobile browsers that support getUserMedia, Web Speech API, and WebAssembly. The MediaPipe models run on-device. Performance is best on recent hardware — the pose and face models are computationally intensive, so older phones may experience slower frame rates in the preview panels.</div>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="hiw-cta">
      <h3>Ready to record your baseline?</h3>
      <p>It takes only 30 seconds (≈35 with pauses) and runs entirely in your browser. No account, no app, no data leaves your device.</p>
      <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
        <button class="btn-primary" onclick="closeHowItWorks();openApp()">Start Free Check-In →</button>
        <button class="hiw-back" onclick="closeHowItWorks()" style="padding:0.85rem 2.5rem;">← Back to Home</button>
      </div>
    </div>

  </div>
</div>



<script type="module">
  import { FilesetResolver, PoseLandmarker, FaceLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";
  window.__mpFileset = FilesetResolver;
  window.__mpPoseLandmarker = PoseLandmarker;
  window.__mpFaceLandmarker = FaceLandmarker;
</script>

<script>
/* ── LANDING WAVEFORM ── */
const wf=document.getElementById('waveform');
for(let i=0;i<90;i++){const b=document.createElement('div');b.className='bar';b.style.cssText=`--min:${4+Math.random()*10}px;--max:${20+Math.random()*50}px;--dur:${1+Math.random()*2}s;--delay:${Math.random()*-3}s;`;if(Math.random()>0.75)b.style.background='#a855f7';if(Math.random()>0.9)b.style.background='#3b82f6';wf.appendChild(b);}

/* ── SCROLL REVEAL ── */
const revObs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting){setTimeout(()=>e.target.classList.add('visible'),80);revObs.unobserve(e.target);}});},{threshold:0.12});
document.querySelectorAll('.reveal').forEach(e=>revObs.observe(e));
document.querySelectorAll('.signals-grid .signal-card,.audience-grid .audience-card').forEach((el,i)=>el.style.transitionDelay=`${i*0.1}s`);

/* ── HOW IT WORKS ── */
const HIW=document.getElementById('hiw-overlay');
function openHowItWorks(){HIW.style.display='block';HIW.style.animation='appIn 0.4s cubic-bezier(0.16,1,0.3,1) forwards';document.body.style.overflow='hidden';HIW.scrollTop=0;}
function closeHowItWorks(){HIW.style.animation='appOut 0.35s ease forwards';setTimeout(()=>{HIW.style.display='none';HIW.style.animation='';document.body.style.overflow='';},330);}

/* ── APP OPEN/CLOSE ── */
const APP=document.getElementById('fast-app');
function openApp(){updateHomeScreen();updateConfidenceUI();APP.classList.add('open');document.body.style.overflow='hidden';}
function closeApp(){
  // Release camera on close
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
  stopSQ();
  APP.style.animation='appOut 0.4s ease forwards';
  setTimeout(()=>{APP.classList.remove('open');APP.style.animation='';document.body.style.overflow='';},380);
}

/* ── SCREEN NAV ── */
function showScreen(id){document.querySelectorAll('.app-screen').forEach(s=>s.classList.remove('active'));document.getElementById('screen-'+id).classList.add('active');APP.scrollTop=0;}
function goHistory(){renderHistory();showScreen('history');}

/* ── BASELINE STATE ── */
let baseline=null;
try{baseline=JSON.parse(localStorage.getItem('sc_baseline')||'null');}catch(e){}
let isBaselineMode=false;

/* ── HOME SCREEN (dynamic) ── */
function updateHomeScreen(){
  const screen=document.getElementById('screen-home');
  const hasBaseline=!!baseline;
  const DISCLAIMER=`<div class="fast-disclaimer"><strong>⚠ Not medical advice.</strong> This tool is for informational awareness only. If you experience sudden facial drooping, arm weakness, or speech difficulty — call emergency services immediately.</div>`;
  const STEPS=`<div class="what-is-fast">
    <div class="fsc"><div class="fsc-num">Step 01 / 03</div><span class="fsc-icon">😐</span><div class="fsc-title">Neutral Face</div><div class="fsc-desc">Hold a relaxed, neutral expression for 3s. We measure left/right facial symmetry.</div></div>
    <div class="fsc"><div class="fsc-num">Step 02 / 03</div><span class="fsc-icon">🙌</span><div class="fsc-title">Raise Both Arms</div><div class="fsc-desc">Hold arms out level for 10s. We detect drift, asymmetry, and downward drop over time.</div></div>
    <div class="fsc"><div class="fsc-num">Step 03 / 03</div><span class="fsc-icon">🗣️</span><div class="fsc-title">Read the Passage</div><div class="fsc-desc">Read the displayed passage aloud for 20s. We measure words per minute, pause ratio, and detect sudden pace changes.</div></div>
  </div>`;

  if(!hasBaseline){
    screen.innerHTML=`
      <div class="fast-pill"><span class="fast-pill-dot"></span>FAST Neurological Screening</div>
      <h1 class="fast-title">Start with your<br><em>Baseline.</em></h1>
      <p class="fast-sub" style="margin-bottom:2rem;">Before your first FAST Check, you need to record a personal baseline — your normal. Every future check is measured against <em>you</em>, not a population average.</p>
      <div class="baseline-needed-card">
        <h3>📐 &nbsp;Record Your Baseline</h3>
        <p style="margin-top:0.75rem;">Your baseline captures your face, arms, and speech on a day when you feel well. It takes only 30 seconds — the same as a regular check-in — and it's what makes every result personal and accurate.</p>
        <button class="fast-start-btn" onclick="goBaseline()" style="margin:1.5rem auto 0;display:flex;">
          <span>📐</span> Record My Baseline
        </button>
      </div>
      <div class="fast-check-locked">🔒 &nbsp;FAST Check — unlocked after baseline</div>
      ${DISCLAIMER}
      ${STEPS}`;
  } else {
    const b=baseline;
    screen.innerHTML=`
      <div class="fast-pill"><span class="fast-pill-dot"></span>FAST Neurological Screening</div>
      <h1 class="fast-title">Only 30 seconds<br><em>Honest signals.</em></h1>
      <p class="fast-sub">Compared against your personal baseline from ${b.date}. Results reflect changes from <em>your</em> normal — not population averages.</p>
      <button class="fast-start-btn" onclick="goFastCheck()">
        <span>▶</span> Start FAST Check
      </button>
      <div class="baseline-set-card">
        <div class="bsc-icon">📐</div>
        <div class="bsc-info">
          <div class="bsc-title">Your Baseline</div>
          <div class="bsc-date">Recorded ${b.date}</div>
          <div class="bsc-scores">
            <div class="bsc-score"><div class="bsc-score-lbl">Face</div><div class="bsc-score-v">${b.fa}</div></div>
            <div class="bsc-score"><div class="bsc-score-lbl">Arms</div><div class="bsc-score-v">${b.ad != null ? b.ad + ' / 100' : 'n/a'}</div></div>
            <div class="bsc-score"><div class="bsc-score-lbl">Pause</div><div class="bsc-score-v">${b.pr}</div></div>
            <div class="bsc-score"><div class="bsc-score-lbl">WPM</div><div class="bsc-score-v">${b.wpm}</div></div>
          </div>
        </div>
        <button class="bsc-rerecord" onclick="goBaseline()">↺ Re-record</button>
      </div>
      ${DISCLAIMER}
      ${STEPS}`;
  }
}

function goBaseline(){
  isBaselineMode=true;
  showScreen('record');
  resetRec();
  const banner=document.getElementById('rec-mode-banner');
  if(banner){banner.textContent='📐 Baseline Recording — record on a day you feel your normal self';banner.style.display='block';}
  initCamPreview();
}

function goFastCheck(){
  isBaselineMode=false;
  showScreen('record');
  resetRec();
  const banner=document.getElementById('rec-mode-banner');
  if(banner){banner.textContent='';banner.style.display='none';}
  initCamPreview();
}

/* ── CAMERA ── */
let stream=null;

async function initCamPreview(){
  // Start camera silently for preview — no recording yet
  try{
    if(stream)stream.getTracks().forEach(t=>t.stop());
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:true});
    const vid=document.getElementById('cam-video');
    vid.srcObject=stream;
    vid.onloadedmetadata=()=>{
      const ph=document.getElementById('cam-placeholder');
      if(ph)ph.style.display='none';
    };
    animateSQ();
  }catch(e){
    // Camera denied — show a softer message in placeholder
    const ph=document.getElementById('cam-placeholder');
    if(ph)ph.innerHTML='<div style="font-size:1.5rem;">🚫</div><div style="font-family:\'Space Mono\',monospace;font-size:0.68rem;letter-spacing:0.08em;color:var(--muted);text-align:center;padding:0 1rem;">Camera access required.<br>Please allow permissions.</div>';
  }
}

async function initCam(){
  // Camera may already be live from preview — reuse if so
  if(stream){return;}
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:true});
    const vid=document.getElementById('cam-video');
    vid.srcObject=stream;
    vid.onloadedmetadata=()=>{
      const ph=document.getElementById('cam-placeholder');
      if(ph)ph.style.display='none';
    };
    animateSQ();
  }catch(e){alert('Camera access is required. Please allow camera and microphone permissions.');}
}
/* ── SIGNAL QUALITY GATE ── */
let sqScores={lighting:0.88,face:0.84,body:0.5,audio:0.88};
let sqTimer=null;
let _qualityScore=0.75;

// ── REAL BODY VISIBILITY (Pose) ──
let poseLandmarker=null;
let poseReady=false;
let poseBusy=false;
let bodyPassHistory=[];
const BODY_WINDOW=24;
const LM={LEFT_SHOULDER:11,RIGHT_SHOULDER:12,LEFT_ELBOW:13,RIGHT_ELBOW:14,LEFT_WRIST:15,RIGHT_WRIST:16};
const BODY_VIS_THRESH=0.55;
const BODY_INFRAME_PAD=0.02;

const SQ_CFG={
  lighting:{id:'sq-lighting',tipId:'sq-lighting-tip',labels:['💡 Lighting','Lighting'],tip:'Too dark — move closer to a light source or face a window.'},
  face:{id:'sq-face',tipId:'sq-face-tip',labels:['👤 Face Framing','Face Framing'],tip:'Keep your face centered and well-lit in the upper portion of the frame.'},
  body:{id:'sq-body',tipId:'sq-body-tip',labels:['🦴 Body Visibility','Body Visibility'],tip:'Step back so both shoulders and arms are visible.'},
  audio:{id:'sq-audio',tipId:'sq-audio-tip',labels:['🎙️ Audio Clarity','Audio Clarity'],tip:'Move closer to your microphone and reduce background noise.'}
};

function sqStatusText(score){
  if(score>=0.75)return{cls:'good',text:'✅ Good'};
  if(score>=0.55)return{cls:'warn',text:'⚠️ Needs adjustment'};
  return{cls:'bad',text:'❌ Insufficient'};
}

function updateSqUI(){
  Object.keys(SQ_CFG).forEach(k=>{
    const cfg=SQ_CFG[k];const sc=sqScores[k];
    const {cls,text}=sqStatusText(sc);
    const el=document.getElementById(cfg.id);if(!el)return;
    el.className='sq-status '+cls;el.textContent=text;
    const tipEl=document.getElementById(cfg.tipId);if(!tipEl)return;
    if(k==='body'&&sc<0.75){
      tipEl.textContent='Step back so BOTH shoulders + BOTH wrists are visible. Keep elbows/wrists on-screen.';
    } else {
      tipEl.textContent=sc<0.75?cfg.tip:'';
    }
  });
}

async function initPose(){
  if(poseReady||poseLandmarker)return;
  try{
    const FilesetResolver=window.__mpFileset;
    const PoseLandmarker=window.__mpPoseLandmarker;
    if(!FilesetResolver||!PoseLandmarker)return;
    const vision=await FilesetResolver.forVisionTasks(
      'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm'
    );
    poseLandmarker=await PoseLandmarker.createFromOptions(vision,{
      baseOptions:{
        modelAssetPath:'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker_full.task',
        delegate:'GPU'
      },
      runningMode:'VIDEO',
      numPoses:1
    });
    poseReady=true;
  }catch(e){
    console.warn('Pose init failed:',e);
    poseReady=false;poseLandmarker=null;
  }
}

// ── FACE LANDMARKER ──
let faceLandmarker=null;
let faceReady=false;
let faceBusy=false;
let _lastFaceLandmarks=null;
let _lastPoseLandmarks=null;
let _smoothedPoseLandmarks=null; // EMA-smoothed pose for display
let _smoothedPoseBBox=null;      // EMA-smoothed bounding box — keeps viewport stable
const POSE_SMOOTH_ALPHA=0.04;    // landmark smoothing — lowered further for stronger jitter suppression on arms
const POSE_BBOX_ALPHA=0.04;      // bbox smoothing — very slow to prevent viewport jumping

// ── Rolling median filter for wrist positions (applied AFTER EMA) ──
// Keeps a sliding window and returns the median to reject single-frame outliers
const ARM_MEDIAN_WINDOW=5;
let _armMedianBufL=[];  // circular buffer for left wrist {x,y}
let _armMedianBufR=[];  // circular buffer for right wrist {x,y}
function medianOfArr(arr){const s=[...arr].sort((a,b)=>a-b);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;}
function pushMedianBuf(buf,val){buf.push(val);if(buf.length>ARM_MEDIAN_WINDOW)buf.shift();}
function getMedian2D(buf){
  if(!buf.length)return null;
  return{x:medianOfArr(buf.map(p=>p.x)),y:medianOfArr(buf.map(p=>p.y))};
}
function resetArmMedianBufs(){_armMedianBufL=[];_armMedianBufR=[];}

function smoothPoseLandmarks(raw){
  if(!raw||!raw.length)return raw;
  if(!_smoothedPoseLandmarks||_smoothedPoseLandmarks[0].length!==raw[0].length){
    _smoothedPoseLandmarks=raw.map(person=>person.map(lm=>({...lm})));
    return _smoothedPoseLandmarks;
  }
  _smoothedPoseLandmarks=raw.map((person,pi)=>person.map((lm,li)=>{
    const prev=_smoothedPoseLandmarks[pi]&&_smoothedPoseLandmarks[pi][li];
    if(!prev)return{...lm};
    return{
      x:prev.x+(lm.x-prev.x)*POSE_SMOOTH_ALPHA,
      y:prev.y+(lm.y-prev.y)*POSE_SMOOTH_ALPHA,
      z:prev.z+(lm.z-prev.z)*POSE_SMOOTH_ALPHA,
      visibility:prev.visibility+(((lm.visibility||0)-(prev.visibility||0))*POSE_SMOOTH_ALPHA)
    };
  }));
  return _smoothedPoseLandmarks;
}

function smoothPoseBBox(minX,maxX,minY,maxY){
  if(!_smoothedPoseBBox){
    _smoothedPoseBBox={minX,maxX,minY,maxY};
    return _smoothedPoseBBox;
  }
  _smoothedPoseBBox={
    minX:_smoothedPoseBBox.minX+( minX-_smoothedPoseBBox.minX)*POSE_BBOX_ALPHA,
    maxX:_smoothedPoseBBox.maxX+( maxX-_smoothedPoseBBox.maxX)*POSE_BBOX_ALPHA,
    minY:_smoothedPoseBBox.minY+( minY-_smoothedPoseBBox.minY)*POSE_BBOX_ALPHA,
    maxY:_smoothedPoseBBox.maxY+( maxY-_smoothedPoseBBox.maxY)*POSE_BBOX_ALPHA,
  };
  return _smoothedPoseBBox;
}
let _previewRafId=null;
let _previewLoopCleanup=null;

async function initFace(){
  if(faceReady||faceLandmarker)return;
  try{
    const FilesetResolver=window.__mpFileset;
    const FaceLandmarker=window.__mpFaceLandmarker;
    if(!FilesetResolver||!FaceLandmarker)return;
    const vision=await FilesetResolver.forVisionTasks(
      'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm'
    );
    faceLandmarker=await FaceLandmarker.createFromOptions(vision,{
      baseOptions:{
        modelAssetPath:'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task'
      },
      runningMode:'VIDEO',
      numFaces:1,
      minFaceDetectionConfidence:0.7,
      minFacePresenceConfidence:0.7,
      minTrackingConfidence:0.7
    });
    faceReady=true;
  }catch(e){
    console.warn('Face init failed:',e);
    faceReady=false;faceLandmarker=null;
  }
}

// Face mesh connectivity (subset for a clean overlay)
const FACE_MESH_CONTOURS=[
  // Lips outer
  [61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146,61],
  // Left eye
  [263,249,390,373,374,380,381,382,362,263],
  // Right eye
  [33,7,163,144,145,153,154,155,133,33],
  // Left eyebrow
  [276,283,282,295,285,300,293,334,296,336],
  // Right eyebrow
  [46,53,52,65,55,70,63,105,66,107],
  // Nose bridge
  [168,6,197,195,5],
  // Nose tip
  [1,2,98,97]
];

// POSE skeleton connections
const POSE_CONNECTIONS=[
  [11,12],[11,13],[13,15],[12,14],[14,16],
  [11,23],[12,24],[23,24],
  [23,25],[25,27],[24,26],[26,28]
];

function drawFacePreview(canvas,vid,landmarks){
  const dpr=window.devicePixelRatio||1;
  const W=canvas.width/dpr, H=canvas.height/dpr;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#080c17';
  ctx.fillRect(0,0,W,H);

  if(!landmarks||!landmarks.length){
    ctx.fillStyle='rgba(107,114,128,0.45)';
    ctx.font=`${Math.round(W*0.04)}px Space Mono`;
    ctx.textAlign='center';
    ctx.fillText('Waiting for face…',W/2,H/2);
    return;
  }

  const lms=landmarks[0];

  // ── Sanity check: eyes above nose above mouth ──
  const _eyeMidY=((lms[33]?.y||0)+(lms[263]?.y||0))/2;
  const _noseY=lms[1]?.y||0;
  const _mouthMidY=((lms[61]?.y||0)+(lms[291]?.y||0))/2;
  if(_eyeMidY > _noseY + 0.01 || _noseY > _mouthMidY + 0.01){
    ctx.fillStyle='rgba(107,114,128,0.45)';
    ctx.font=`${Math.round(W*0.04)}px Space Mono`;
    ctx.textAlign='center';
    ctx.fillText('Adjusting…',W/2,H/2);
    return;
  }

  let minX=1,maxX=0,minY=1,maxY=0;
  lms.forEach(lm=>{minX=Math.min(minX,lm.x);maxX=Math.max(maxX,lm.x);minY=Math.min(minY,lm.y);maxY=Math.max(maxY,lm.y);});
  const padX=0.06,padY=0.06;
  minX=Math.max(0,minX-padX);maxX=Math.min(1,maxX+padX);
  minY=Math.max(0,minY-padY);maxY=Math.min(1,maxY+padY);
  const bw=maxX-minX||0.5, bh=maxY-minY||0.5;

  // Scale to fill canvas, preserving aspect ratio
  const scaleX=W/bw, scaleY=H/bh;
  const scale=Math.min(scaleX,scaleY);
  const offX=(W-bw*scale)/2, offY=(H-bh*scale)/2;

  const px=(nx)=>offX+(nx-minX)*scale;
  const py=(ny)=>offY+(ny-minY)*scale;

  ctx.save();
  // Mirror to match the mirrored video
  ctx.translate(W,0);ctx.scale(-1,1);
  const mpx=(nx)=>W-(px(nx));

  // Draw mesh contours
  ctx.strokeStyle='rgba(0,229,200,0.4)';
  ctx.lineWidth=1.2;
  FACE_MESH_CONTOURS.forEach(path=>{
    if(!path.length)return;
    ctx.beginPath();
    path.forEach((idx,i)=>{
      const lm=lms[idx];if(!lm)return;
      i===0?ctx.moveTo(mpx(lm.x),py(lm.y)):ctx.lineTo(mpx(lm.x),py(lm.y));
    });
    ctx.stroke();
  });

  // All landmark dots
  ctx.fillStyle='rgba(0,229,200,0.55)';
  lms.forEach(lm=>{
    ctx.beginPath();ctx.arc(mpx(lm.x),py(lm.y),1.4,0,Math.PI*2);ctx.fill();
  });

  // Highlight key landmarks
  const keyPts=[0,1,4,13,14,33,61,133,159,263,291,362];
  ctx.fillStyle='rgba(0,229,200,1)';
  keyPts.forEach(idx=>{
    const lm=lms[idx];if(!lm)return;
    ctx.beginPath();ctx.arc(mpx(lm.x),py(lm.y),3,0,Math.PI*2);ctx.fill();
  });

  // Symmetry center line through nose tip
  const nose=lms[1];
  if(nose){
    ctx.strokeStyle='rgba(0,229,200,0.18)';
    ctx.setLineDash([3,3]);ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(mpx(nose.x),0);ctx.lineTo(mpx(nose.x),H);ctx.stroke();
    ctx.setLineDash([]);
  }

  // Mouth corners asymmetry line
  const ml=lms[61],mr=lms[291];
  if(ml&&mr){
    const asymPx=Math.abs(ml.y-mr.y)*scale;
    ctx.strokeStyle=asymPx>4?'rgba(245,158,11,0.9)':'rgba(34,197,94,0.8)';
    ctx.lineWidth=1.5;ctx.setLineDash([2,2]);
    ctx.beginPath();ctx.moveTo(mpx(ml.x),py(ml.y));ctx.lineTo(mpx(mr.x),py(mr.y));ctx.stroke();
    ctx.setLineDash([]);
    ctx.restore();
    // Label (not mirrored)
    const col=asymPx>4?'rgba(245,158,11,0.9)':'rgba(34,197,94,0.8)';
    ctx.fillStyle=col;
    ctx.font=`${Math.round(W*0.036)}px Space Mono`;ctx.textAlign='left';
    ctx.fillText('Δy '+(asymPx).toFixed(1)+'px',6,H-6);
    return;
  }

  ctx.restore();
}

function drawPosePreview(canvas,landmarks){
  const dpr=window.devicePixelRatio||1;
  const W=canvas.width/dpr, H=canvas.height/dpr;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#080c17';
  ctx.fillRect(0,0,W,H);

  if(!landmarks||!landmarks.length){
    ctx.fillStyle='rgba(107,114,128,0.45)';
    ctx.font=`${Math.round(W*0.04)}px Space Mono`;
    ctx.textAlign='center';
    ctx.fillText('Waiting for pose…',W/2,H/2);
    return;
  }

  const lms=landmarks[0];

  // Use only confidently visible landmarks for bounding box
  const visible=lms.filter(lm=>(lm.visibility||0)>0.35);
  if(!visible.length){
    ctx.fillStyle='rgba(107,114,128,0.45)';
    ctx.font=`${Math.round(W*0.04)}px Space Mono`;
    ctx.textAlign='center';
    ctx.fillText('Adjust position…',W/2,H/2);
    return;
  }

  // Compute raw bbox from visible landmarks
  let rMinX=1,rMaxX=0,rMinY=1,rMaxY=0;
  visible.forEach(lm=>{rMinX=Math.min(rMinX,lm.x);rMaxX=Math.max(rMaxX,lm.x);rMinY=Math.min(rMinY,lm.y);rMaxY=Math.max(rMaxY,lm.y);});
  const padX=0.1,padY=0.08;
  rMinX=Math.max(0,rMinX-padX);rMaxX=Math.min(1,rMaxX+padX);
  rMinY=Math.max(0,rMinY-padY);rMaxY=Math.min(1,rMaxY+padY);

  // Smooth the bbox — this prevents the viewport from jumping frame-to-frame
  const bbox=smoothPoseBBox(rMinX,rMaxX,rMinY,rMaxY);
  const {minX,maxX,minY,maxY}=bbox;
  const bw=maxX-minX||0.5, bh=maxY-minY||0.5;

  const scaleX=W/bw, scaleY=H/bh;
  const scale=Math.min(scaleX,scaleY);
  const offX=(W-bw*scale)/2, offY=(H-bh*scale)/2;

  const px=(nx)=>offX+(nx-minX)*scale;
  const py=(ny)=>offY+(ny-minY)*scale;

  ctx.save();
  ctx.translate(W,0);ctx.scale(-1,1);
  const mpx=(nx)=>W-(px(nx));

  // Skeleton connections
  POSE_CONNECTIONS.forEach(([a,b])=>{
    const la=lms[a],lb=lms[b];
    if(!la||!lb)return;
    const vis=Math.min(la.visibility||0,lb.visibility||0);
    if(vis<0.25)return;
    ctx.strokeStyle=`rgba(168,85,247,${0.25+vis*0.55})`;
    ctx.lineWidth=2.5;
    ctx.beginPath();ctx.moveTo(mpx(la.x),py(la.y));ctx.lineTo(mpx(lb.x),py(lb.y));ctx.stroke();
  });

  // Keypoints
  const keyColors={11:'#00e5c8',12:'#00e5c8',13:'#a855f7',14:'#a855f7',15:'#3b82f6',16:'#3b82f6'};
  lms.forEach((lm,idx)=>{
    if(!lm||(lm.visibility||0)<0.25)return;
    const r=[11,12,15,16].includes(idx)?6:3.5;
    ctx.fillStyle=keyColors[idx]||'rgba(168,85,247,0.8)';
    ctx.beginPath();ctx.arc(mpx(lm.x),py(lm.y),r,0,Math.PI*2);ctx.fill();
    // White outline on key joints
    if([11,12,15,16].includes(idx)){
      ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1;
      ctx.beginPath();ctx.arc(mpx(lm.x),py(lm.y),r,0,Math.PI*2);ctx.stroke();
    }
  });

  // Wrist drift indicator
  const lw=lms[15],rw=lms[16];
  if(lw&&rw&&(lw.visibility||0)>0.4&&(rw.visibility||0)>0.4){
    const drift=Math.abs(lw.y-rw.y)*scale;
    ctx.strokeStyle=drift>8?'rgba(245,158,11,0.9)':'rgba(34,197,94,0.7)';
    ctx.lineWidth=1.5;ctx.setLineDash([4,3]);
    ctx.beginPath();ctx.moveTo(mpx(lw.x),py(lw.y));ctx.lineTo(mpx(rw.x),py(rw.y));ctx.stroke();
    ctx.setLineDash([]);
    ctx.restore();
    const col=drift>8?'rgba(245,158,11,0.9)':'rgba(34,197,94,0.8)';
    ctx.fillStyle=col;
    ctx.font=`${Math.round(W*0.036)}px Space Mono`;ctx.textAlign='left';
    ctx.fillText('drift '+(drift).toFixed(1)+'px',6,H-6);
    return;
  }

  ctx.restore();
}

// Size canvases to match rendered size (sharp on HiDPI)
function sizePreviewCanvases(){
  ['face-preview-canvas','pose-preview-canvas'].forEach(id=>{
    const c=document.getElementById(id);
    if(!c)return;
    const parent=c.parentElement;
    if(!parent)return;
    const rect=parent.getBoundingClientRect();
    const dpr=window.devicePixelRatio||1;
    const w=rect.width>0?rect.width:320;
    const h=rect.height>0?rect.height:180;
    // Only resize if dimensions actually changed (avoids redundant resets)
    const newW=Math.round(w*dpr);
    const newH=Math.round(h*dpr);
    if(c.width!==newW||c.height!==newH){
      c.width=newW;
      c.height=newH;
    }
    c.style.width=w+'px';
    c.style.height=h+'px';
    // Always reset transform to identity then apply dpr scale
    const ctx=c.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
  });
}

// Live preview rendering loop
function startPreviewLoop(){
  if(_previewRafId)cancelAnimationFrame(_previewRafId);
  const fCanvas=document.getElementById('face-preview-canvas');
  const pCanvas=document.getElementById('pose-preview-canvas');
  const vid=document.getElementById('cam-video');

  // Size once, then again after a short delay (layout may not be final yet)
  sizePreviewCanvases();
  setTimeout(sizePreviewCanvases,200);

  // Re-size on window resize
  const onResize=()=>sizePreviewCanvases();
  window.addEventListener('resize',onResize);

  let lastFaceT=0;
  let lastPoseT=0;
  let lastFaceSampleT=0;
  let _prevNoseX=null, _prevNoseY=null; // for stillness gate
  const FACE_SAMPLE_MS=80; // ~12.5 Hz during smile task
  // Stillness gate: skip frame if nose moved more than 5% of IOD since last sample.
  // 0.05 is loose enough to allow normal breathing/micro-expression,
  // tight enough to reject obvious head turns or nods.
  const STILLNESS_THRESH=0.05;

  async function loop(t){
    _previewRafId=requestAnimationFrame(loop);

    if(vid&&vid.readyState>=2){
      // ── Face ──────────────────────────────────────────────────────────────
      if(t-lastFaceT>66&&faceReady&&faceLandmarker&&!faceBusy){
        faceBusy=true;
        try{
          const res=faceLandmarker.detectForVideo(vid,performance.now());
          _lastFaceLandmarks=res.faceLandmarks;
          if(_collectingFace&&res.faceLandmarks&&res.faceLandmarks.length){
            if(t-lastFaceSampleT>=FACE_SAMPLE_MS){
              const lms=res.faceLandmarks[0];
              const nose=lms[1];
              const eyeL=lms[33],eyeR=lms[263];
              const iodGate=(nose&&eyeL&&eyeR)?Math.hypot(eyeL.x-eyeR.x,eyeL.y-eyeR.y):0.1;
              const motion=(_prevNoseX!=null&&nose)?Math.hypot(nose.x-_prevNoseX,nose.y-_prevNoseY)/iodGate:0;
              if(nose){_prevNoseX=nose.x;_prevNoseY=nose.y;}
              lastFaceSampleT=t;
              if(motion<STILLNESS_THRESH){
                const a=computeFaceAsymmetry(lms);
                if(a!=null)_faceFrames.push(a.raw);
              }
            }
          } else {
            // Not collecting — reset position tracker so first sample of next
            // collection window isn't compared to a stale position
            _prevNoseX=null;_prevNoseY=null;
          }
        }catch(e){console.warn('Face detect error:',e);}
        finally{faceBusy=false;}
        lastFaceT=t;
      }
      // ── Pose ──────────────────────────────────────────────────────────────
      if(t-lastPoseT>66&&poseReady&&poseLandmarker&&!poseBusy){
        poseBusy=true;
        try{
          const res=poseLandmarker.detectForVideo(vid,performance.now());
          _lastPoseLandmarks=res.landmarks;
          smoothPoseLandmarks(res.landmarks); // updates _smoothedPoseLandmarks
          if(_collectingArms&&_smoothedPoseLandmarks&&_smoothedPoseLandmarks.length){
            // Use smoothed landmarks for drift measurement — raw landmarks are too jittery
            // and accumulate noise into the path-length score even when the user is still
            const drift=computeArmDrift(_smoothedPoseLandmarks[0]);
            if(drift!=null)_armFrames.push(drift);
          }
          const pass=computeBodyPassFromPose(res);
          bodyPassHistory.push(pass?1:0);
          if(bodyPassHistory.length>BODY_WINDOW)bodyPassHistory.shift();
          sqScores.body=bodyPassHistory.reduce((a,b)=>a+b,0)/bodyPassHistory.length;
        }catch(e){}
        finally{poseBusy=false;}
        lastPoseT=t;
      }
    }

    if(fCanvas)drawFacePreview(fCanvas,vid,_lastFaceLandmarks);
    if(pCanvas)drawPosePreview(pCanvas,_smoothedPoseLandmarks||_lastPoseLandmarks);
  }
  requestAnimationFrame(loop);

  // Store cleanup fn separately — RAF IDs are numbers, can't set properties on them
  _previewLoopCleanup=()=>window.removeEventListener('resize',onResize);
}

function stopPreviewLoop(){
  if(_previewLoopCleanup){_previewLoopCleanup();_previewLoopCleanup=null;}
  if(_previewRafId){cancelAnimationFrame(_previewRafId);_previewRafId=null;}
  _lastFaceLandmarks=null;_lastPoseLandmarks=null;_smoothedPoseLandmarks=null;_smoothedPoseBBox=null;
}

function isLandmarkGood(lm){
  if(!lm)return false;
  const v=(typeof lm.visibility==='number')?lm.visibility:0;
  if(v<BODY_VIS_THRESH)return false;
  const x=lm.x,y=lm.y;
  if(x<BODY_INFRAME_PAD||x>(1-BODY_INFRAME_PAD))return false;
  if(y<BODY_INFRAME_PAD||y>(1-BODY_INFRAME_PAD))return false;
  return true;
}

function computeBodyPassFromPose(result){
  if(!result||!result.landmarks||!result.landmarks.length)return false;
  const lms=result.landmarks[0];
  if(!lms||lms.length<17)return false;
  return(
    isLandmarkGood(lms[LM.LEFT_SHOULDER])&&
    isLandmarkGood(lms[LM.RIGHT_SHOULDER])&&
    isLandmarkGood(lms[LM.LEFT_WRIST])&&
    isLandmarkGood(lms[LM.RIGHT_WRIST])
  );
}

/* ── REAL LIGHTING & FACE FRAMING via canvas ── */
let _sqCanvas=null;let _sqCtx=null;
function getSqCanvas(){
  if(!_sqCanvas){_sqCanvas=document.createElement('canvas');_sqCanvas.width=160;_sqCanvas.height=120;_sqCtx=_sqCanvas.getContext('2d');}
  return{canvas:_sqCanvas,ctx:_sqCtx};
}

function measureLightingAndFraming(vid){
  if(!vid||vid.readyState<2)return{lighting:sqScores.lighting,face:sqScores.face};
  try{
    const{canvas,ctx}=getSqCanvas();
    ctx.drawImage(vid,0,0,canvas.width,canvas.height);
    const data=ctx.getImageData(0,0,canvas.width,canvas.height).data;
    const W=canvas.width,H=canvas.height;
    let totalBrightness=0,n=0;
    for(let i=0;i<data.length;i+=4){totalBrightness+=(data[i]*0.299+data[i+1]*0.587+data[i+2]*0.114);n++;}
    const avgBrightness=totalBrightness/n; // 0-255
    const lightingScore=avgBrightness>110?1:avgBrightness>80?(avgBrightness-80)/30*0.25+0.75:avgBrightness/80*0.55;

    // Face framing: look for a bright region in the upper-center third (face area)
    // Sample a 40x40 box centered at (W/2, H/3) and compare to overall brightness
    const fx=Math.floor(W/2-20),fy=Math.floor(H/3-20);
    let faceB=0,faceN=0;
    for(let y=fy;y<fy+40&&y<H;y++){
      for(let x=fx;x<fx+40&&x<W;x++){
        const idx=(y*W+x)*4;
        faceB+=(data[idx]*0.299+data[idx+1]*0.587+data[idx+2]*0.114);faceN++;
      }
    }
    const faceBrightness=faceB/faceN;
    // Face framing is good if the face region is reasonably bright and not drastically
    // different from overall (avoiding mostly-blank/dark frames)
    const faceRatio=faceBrightness/(avgBrightness||1);
    // Good: face region 0.7–1.5× overall brightness, and face area itself is >80
    const faceCentered=faceBrightness>80&&faceRatio>0.65&&faceRatio<1.8;
    const brightnessScore=faceCentered?(Math.min(faceBrightness,180)/180*0.3+0.7):Math.max(0.3,(faceBrightness/180)*0.65);
    let faceScore=brightnessScore;
    if(faceReady&&_lastFaceLandmarks!=null){
      const det=_lastFaceLandmarks.length>0;
      faceScore=det?1.0*0.6+brightnessScore*0.4:0.4*0.6+brightnessScore*0.4;
    }
    return{lighting:Math.min(1,lightingScore),face:Math.min(1,faceScore)};
  }catch(e){return{lighting:sqScores.lighting,face:sqScores.face};}
}

async function animateSQ(){
  if(sqTimer)clearInterval(sqTimer);
  await initPose();
  await initFace();
  const vid=document.getElementById('cam-video');
  const audioSeq=[0.88,0.84,0.90,0.86,0.92,0.88,0.91,0.89,0.87,0.90];
  let audioIdx=0;
  sqTimer=setInterval(async()=>{
    // REAL lighting + face framing from canvas
    const{lighting,face}=measureLightingAndFraming(vid);
    sqScores.lighting=lighting;
    sqScores.face=face;

    // Simulated audio
    sqScores.audio=audioSeq[audioIdx%audioSeq.length];audioIdx++;

    // Body score is updated by animateSQ's own pose check (preview loop not running during record screen)
    if(poseReady&&poseLandmarker&&vid&&vid.readyState>=2&&!poseBusy){
      poseBusy=true;
      try{
        const res=poseLandmarker.detectForVideo(vid,performance.now());
        const pass=computeBodyPassFromPose(res);
        bodyPassHistory.push(pass?1:0);
        if(bodyPassHistory.length>BODY_WINDOW)bodyPassHistory.shift();
        sqScores.body=bodyPassHistory.reduce((a,b)=>a+b,0)/bodyPassHistory.length;
      }catch(e){sqScores.body=0.4;}
      finally{poseBusy=false;}
    }

    _qualityScore=(sqScores.lighting+sqScores.face+sqScores.body+sqScores.audio)/4;
    updateSqUI();
  },200);
}

function stopSQ(){if(sqTimer){clearInterval(sqTimer);sqTimer=null;}}

/* ── QUALITY GATE DECISION ── */
let _gateDecision='pass'; // pass | warn | block

function showQualityGate(){
  const total=_qualityScore;
  const box=document.getElementById('qg-box');
  const overlay=document.getElementById('qg-overlay');

  const scoreLabel=(sc)=>sc>=0.75?'Good':sc>=0.55?'Borderline':'Poor';
  const scoreClass=(sc)=>sc>=0.75?'good':sc>=0.55?'warn':'bad';

  document.getElementById('qg-s-light').textContent=scoreLabel(sqScores.lighting);
  document.getElementById('qg-s-light').className='qg-score-v '+scoreClass(sqScores.lighting);
  document.getElementById('qg-s-face').textContent=scoreLabel(sqScores.face);
  document.getElementById('qg-s-face').className='qg-score-v '+scoreClass(sqScores.face);
  document.getElementById('qg-s-body').textContent=scoreLabel(sqScores.body);
  document.getElementById('qg-s-body').className='qg-score-v '+scoreClass(sqScores.body);
  document.getElementById('qg-s-audio').textContent=scoreLabel(sqScores.audio);
  document.getElementById('qg-s-audio').className='qg-score-v '+scoreClass(sqScores.audio);

  const btns=document.getElementById('qg-btns');
  if(total>=0.75){
    _gateDecision='pass';
    box.style.setProperty('--ac','var(--teal)');
    document.getElementById('qg-icon').textContent='✅';
    document.getElementById('qg-title').textContent='Signal Quality Looks Good';
    document.getElementById('qg-desc').textContent='All four signal channels are reliable. Running analysis now.';
    btns.innerHTML='<button class="qg-proceed" onclick="proceedFromGate()">Analyze Now →</button>';
  } else if(total>=0.55){
    _gateDecision='warn';
    box.style.setProperty('--ac','var(--yellow)');
    document.getElementById('qg-icon').textContent='⚠️';
    document.getElementById('qg-title').textContent='Some Signals May Be Unreliable';
    document.getElementById('qg-desc').textContent='One or more channels are borderline. You can continue or retake for better accuracy.';
    btns.innerHTML='<button class="qg-proceed yellow" onclick="proceedFromGate()">Continue Anyway</button><button class="qg-retake" onclick="retakeFromGate()">↺ Retake for Better Accuracy</button>';
  } else {
    _gateDecision='block';
    box.style.setProperty('--ac','var(--red)');
    document.getElementById('qg-icon').textContent='❌';
    document.getElementById('qg-title').textContent='Recording Not Reliable Enough';
    document.getElementById('qg-desc').textContent='Signal quality is too low to provide meaningful insights. Please retake with better lighting, framing, and audio.';
    btns.innerHTML='<button class="qg-retake" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);color:var(--red);" onclick="retakeFromGate()">↺ Retake Recording</button>';
  }
  overlay.style.display='flex';
}

function proceedFromGate(){
  document.getElementById('qg-overlay').style.display='none';
  showScreen('processing');
  runProcessing();
}

function retakeFromGate(){
  document.getElementById('qg-overlay').style.display='none';
  stopSQ();
  resetRec();
}

/* ── REAL WPM via Web Speech API (with per-second spike detection) ── */
let _speechRecognition=null;
let _spokenWords=[];
let _speakStartTime=0;
let _wpmBuckets=[];        // words per 3-second bucket
let _bucketStartTime=0;
let _bucketWordCount=0;
let _bucketTimer=null;

function startSpeechRecognition(){
  _spokenWords=[];
  _speakStartTime=performance.now();
  _wpmBuckets=[];
  _bucketStartTime=performance.now();
  _bucketWordCount=0;
  _wpmSpike=false;

  // Show passage overlay on camera
  const passageEl=document.getElementById('speech-passage-text');
  const passageOverlay=document.getElementById('speech-passage-overlay');
  if(passageEl)passageEl.textContent=SPEECH_PASSAGE;
  if(passageOverlay)passageOverlay.style.display='flex';

  // Show speech strip + render passage as word spans
  const strip=document.getElementById('speech-strip');
  if(strip)strip.classList.add('active');
  const passageWordsEl=document.getElementById('ss-passage-words');
  if(passageWordsEl){
    passageWordsEl.innerHTML=SPEECH_PASSAGE.trim().split(/\s+/).map((w,i)=>
      '<span class="ss-word" id="ssw-'+i+'">'+w+' </span>'
    ).join('');
  }

  function _highlightSpokenWords(){
    const pw=SPEECH_PASSAGE.trim().split(/\s+/);
    const sc=_spokenWords.map(w=>w.toLowerCase().replace(/[^a-z]/g,''));
    let mi=0;
    for(let i=0;i<pw.length;i++){
      const p=pw[i].toLowerCase().replace(/[^a-z]/g,'');
      const el=document.getElementById('ssw-'+i);
      if(!el)continue;
      if(mi<sc.length&&sc[mi]===p){el.className='ss-word spoken';mi++;}
      else if(mi<sc.length){el.className='ss-word current';break;}
      else{el.className='ss-word';}
    }
  }

  function _updateSsWpm(){
    const elapsed=(performance.now()-_speakStartTime)/1000/60;
    const liveWpm=elapsed>0&&_spokenWords.length>0?Math.round(_spokenWords.length/elapsed):0;
    const el=document.getElementById('ss-wpm-live');
    if(el)el.textContent=liveWpm>0?liveWpm:'—';
  }

  function _renderSsBuckets(){
    const el=document.getElementById('ss-buckets');
    if(!el||!_wpmBuckets.length)return;
    const max=Math.max(..._wpmBuckets,1);
    const sorted=[..._wpmBuckets].sort((a,b)=>a-b);
    const median=sorted[Math.floor(sorted.length/2)];
    el.innerHTML=_wpmBuckets.map(b=>{
      const h=Math.max(3,Math.round((b/max)*26));
      const isSpike=median>0&&Math.abs(b-median)/median>0.4;
      return '<div class="ss-bucket-bar'+(isSpike?' spike':'')+'" style="height:'+h+'px;"></div>';
    }).join('');
  }

  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){
    _bucketTimer=setInterval(()=>{_flushBucket();_updateSsWpm();_renderSsBuckets();},1000);
    return;
  }
  _speechRecognition=new SR();
  _speechRecognition.continuous=true;
  _speechRecognition.interimResults=true;
  _speechRecognition.lang='en-US';
  _speechRecognition.onresult=(e)=>{
    let finalWords=[];
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal){
        finalWords.push(...e.results[i][0].transcript.trim().split(/\s+/).filter(Boolean));
      }
    }
    if(finalWords.length){
      _spokenWords.push(...finalWords);
      _bucketWordCount+=finalWords.length;
      _highlightSpokenWords();
      _updateSsWpm();
    }
  };
  _speechRecognition.onerror=()=>{};
  try{_speechRecognition.start();}catch(e){}

  _bucketTimer=setInterval(()=>{_flushBucket();_renderSsBuckets();_updateSsWpm();},1000);
}

function _flushBucket(){
  const now=performance.now();
  const elapsed=(now-_bucketStartTime)/1000/60; // minutes
  const bucketWpm=elapsed>0?Math.round(_bucketWordCount/elapsed):0;
  if(bucketWpm>0)_wpmBuckets.push(bucketWpm);
  _bucketStartTime=now;
  _bucketWordCount=0;
}

function startJitterShimmer(audioStream){
  try{
    _pitchPeriods=[];_rmsValues=[];_prevPeriod=null;
    _audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    _audioSource=_audioCtx.createMediaStreamSource(audioStream);
    _audioAnalyser=_audioCtx.createAnalyser();
    _audioAnalyser.fftSize=2048;
    _audioSource.connect(_audioAnalyser);
    const buf=new Float32Array(_audioAnalyser.fftSize);
    const sr=_audioCtx.sampleRate;
    const MIN_FREQ=80,MAX_FREQ=400; // human voice F0 range
    const minPeriod=Math.floor(sr/MAX_FREQ);
    const maxPeriod=Math.ceil(sr/MIN_FREQ);

    _jitterInterval=setInterval(()=>{
      _audioAnalyser.getFloatTimeDomainData(buf);
      // RMS for silence gate + shimmer
      let sum=0;for(let i=0;i<buf.length;i++)sum+=buf[i]*buf[i];
      const rms=Math.sqrt(sum/buf.length);
      if(rms<0.01)return; // silence gate — skip unvoiced frames

      _rmsValues.push(rms);

      // Autocorrelation-based F0 detection
      let bestK=-1,bestR=-Infinity;
      for(let k=minPeriod;k<=maxPeriod;k++){
        let r=0;
        for(let i=0;i<buf.length-k;i++)r+=buf[i]*buf[i+k];
        if(r>bestR){bestR=r;bestK=k;}
      }
      if(bestK>0&&bestR>0){
        if(_prevPeriod!==null)_pitchPeriods.push(Math.abs(bestK-_prevPeriod));
        _prevPeriod=bestK;
      }
    },20);
  }catch(e){console.warn('Jitter/shimmer init failed:',e);}
}

function stopJitterShimmer(){
  if(_jitterInterval){clearInterval(_jitterInterval);_jitterInterval=null;}
  // Compute jitter: mean absolute deviation of pitch periods, normalized
  if(_pitchPeriods.length>=4){
    const meanDev=_pitchPeriods.reduce((a,b)=>a+b,0)/_pitchPeriods.length;
    // Typical jitter in samples at 44100Hz: <5 = excellent, >20 = concerning
    _measuredJitter=Math.min(1,meanDev/20);
  } else { _measuredJitter=null; }
  // Compute shimmer: coefficient of variation of RMS amplitudes
  if(_rmsValues.length>=4){
    const mean=_rmsValues.reduce((a,b)=>a+b,0)/_rmsValues.length;
    const variance=_rmsValues.reduce((a,b)=>a+(b-mean)**2,0)/_rmsValues.length;
    const cv=mean>0?Math.sqrt(variance)/mean:0;
    // Typical shimmer CV: <0.15 = normal, >0.35 = concerning
    _measuredShimmer=Math.min(1,cv/0.35);
  } else { _measuredShimmer=null; }
  // Cleanup audio nodes
  try{if(_audioSource)_audioSource.disconnect();}catch(e){}
  try{if(_audioCtx)_audioCtx.close();}catch(e){}
  _audioCtx=null;_audioSource=null;_audioAnalyser=null;
}

function stopSpeechRecognition(){
  if(_bucketTimer){clearInterval(_bucketTimer);_bucketTimer=null;}
  _flushBucket(); // capture last partial bucket

  if(_speechRecognition){try{_speechRecognition.stop();}catch(e){}_speechRecognition=null;}

  // Hide passage overlay and speech strip
  const passageOverlay=document.getElementById('speech-passage-overlay');
  if(passageOverlay)passageOverlay.style.display='none';
  const strip=document.getElementById('speech-strip');
  if(strip)strip.classList.remove('active');

  const elapsed=(performance.now()-_speakStartTime)/1000/60;
  const overallWpm=elapsed>0&&_spokenWords.length>0?Math.round(_spokenWords.length/elapsed):null;

  // ── Pause ratio: fraction of 1-second buckets where no words were spoken ──
  // IMPROVED: derived from actual bucket silence count rather than random number.
  // _wpmBuckets only stores buckets with wpm>0; we know the total number of
  // 1-second intervals from elapsed time. Silent buckets = totalBuckets - activeBuckets.
  const totalBuckets = Math.max(1, Math.round((performance.now()-_speakStartTime)/1000));
  const activeBuckets = _wpmBuckets.length;
  if(totalBuckets > 0 && elapsed > 0 && _spokenWords.length > 0){
    _measuredPauseRatio = +Math.min(1, Math.max(0, (totalBuckets - activeBuckets) / totalBuckets)).toFixed(2);
  } else {
    _measuredPauseRatio = null; // speech recognition not available or nothing spoken
  }

  // Detect spike/dip: if any bucket deviates >40% from the median, flag it
  if(_wpmBuckets.length>=2){
    const sorted=[..._wpmBuckets].sort((a,b)=>a-b);
    const median=sorted[Math.floor(sorted.length/2)];
    _wpmSpike=_wpmBuckets.some(b=>median>0&&(Math.abs(b-median)/median)>0.4);
  }

  return overallWpm;
}

/* ── RECORDING ── */
// Video recording storage — persisted to IndexedDB across page refreshes
// Keys: 'baseline' for the baseline recording, or 0,1,2,... (hist index) for check-ins
const _recordingBlobs = new Map(); // in-memory object URL cache
let _mediaRecorder = null;
let _recordedChunks = [];

/* ---- IndexedDB video persistence ---- */
const _IDB={name:"baseline_app",ver:1,store:"videos",db:null};
function _idbOpen(){
  return new Promise((res,rej)=>{
    if(_IDB.db){res(_IDB.db);return;}
    const r=indexedDB.open(_IDB.name,_IDB.ver);
    r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains(_IDB.store))d.createObjectStore(_IDB.store);};
    r.onsuccess=e=>{_IDB.db=e.target.result;res(_IDB.db);};
    r.onerror=()=>rej(r.error);
  });
}
async function idbPut(key,blob){
  try{const db=await _idbOpen();await new Promise((res,rej)=>{const tx=db.transaction(_IDB.store,"readwrite");tx.objectStore(_IDB.store).put(blob,String(key));tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});}catch(e){console.warn("IDB write:",e);}
}
async function idbDel(key){
  try{const db=await _idbOpen();await new Promise(res=>{const tx=db.transaction(_IDB.store,"readwrite");tx.objectStore(_IDB.store).delete(String(key));tx.oncomplete=res;});}catch(e){}
}
async function _idbGetAll(){
  try{
    const db=await _idbOpen();
    return new Promise((res,rej)=>{
      const tx=db.transaction(_IDB.store,"readonly");
      const rBlobs=tx.objectStore(_IDB.store).getAll();
      const rKeys=tx.objectStore(_IDB.store).getAllKeys();
      let blobs,keys;
      rBlobs.onsuccess=()=>{blobs=rBlobs.result;if(keys!==undefined)res({keys,blobs});};
      rKeys.onsuccess=()=>{keys=rKeys.result;if(blobs!==undefined)res({keys,blobs});};
      tx.onerror=()=>rej(tx.error);
    });
  }catch(e){return{keys:[],blobs:[]};}
}
async function loadPersistedVideos(){
  const{keys,blobs}=await _idbGetAll();
  keys.forEach((k,i)=>{
    const blob=blobs[i];
    if(!(blob instanceof Blob))return;
    const parsed=k==="baseline"?"baseline":parseInt(k,10);
    if(parsed==="baseline"||!isNaN(parsed)){
      if(_recordingBlobs.has(parsed))URL.revokeObjectURL(_recordingBlobs.get(parsed));
      _recordingBlobs.set(parsed,URL.createObjectURL(blob));
    }
  });
  renderHistory();
}

const SPEECH_PASSAGE = "The morning light was bright and clear. I walked outside and felt the fresh air. Today seemed like an ordinary day, but I wanted to make sure everything was fine. Speaking slowly and clearly helps us notice any changes over time.";
const SPEECH_WORD_COUNT = SPEECH_PASSAGE.trim().split(/\s+/).length; // ~40 words

const TASKS=[
  {id:'smile',banner:'😐 &nbsp;NEUTRAL FACE — keep still',cls:'smile',tip:'Keep a relaxed, neutral expression',dur:5,tp:'tp-smile',chk:'chk-smile'},
  {id:'arms', banner:'🙌 &nbsp;RAISE BOTH ARMS — hold steady',cls:'arms',tip:'Keep shoulders visible · Arms level',dur:10,tp:'tp-arms',chk:'chk-arms'},
  {id:'speak',banner:'🗣️ &nbsp;READ THE PASSAGE ALOUD',cls:'speak',tip:'Read clearly at your natural pace — don\'t rush',dur:20,tp:'tp-speak',chk:'chk-speak'}
];
let tIdx=0,recTimer=null,recTime=0;
let _measuredWpm=null;
let _measuredPauseRatio=null; // fraction of speech task time that was silence (null = not measured)
let _wpmSpike=false; // true if a spike/dip was detected
let _measuredJitter=null;  // normalized jitter 0-1 (null if not measured)
let _measuredShimmer=null; // normalized shimmer 0-1 (null if not measured)
let _audioCtx=null,_audioAnalyser=null,_audioSource=null,_jitterInterval=null;
let _pitchPeriods=[],_rmsValues=[],_prevPeriod=null;

// Real measurement buffers (populated during tasks)
let _faceFrames=[];   // {asymIndex} collected during smile task
let _armFrames=[];    // {leftDiff, rightDiff} collected ONLY during arms task
let _collectingFace=false;
let _collectingArms=false;

// ── computeFaceAsymmetry ──────────────────────────────────────────────────
// Returns { raw, index01 } or null.
//   raw     — high-resolution score; track this for baseline comparison
//   index01 — mapped 0–1 for UI display
//
// Improvements over naive approach:
//   1. Roll normalization  — rotates landmarks so eye line is horizontal,
//      eliminating head-tilt noise from all y comparisons.
//   2. Best-fit midline    — weighted average of pair midpoints, not a fixed
//      nose average; much more stable under slight tracking jitter.
//   3. Yaw-aware dx scale  — uses z-depth difference across pairs to estimate
//      yaw; reduces horizontal penalty when head is turned so yaw doesn't
//      masquerade as asymmetry.
//   4. dy over-weighted    — vertical droop is the primary FAST indicator
//      and is less affected by yaw than horizontal displacement.
//   5. No output clamping  — returns raw score uncapped so tiny deltas remain
//      visible for baseline z-score comparison.
function computeFaceAsymmetry(lms){
  if(!lms||lms.length<478)return null;

  // ── Sanity check: validate vertical ordering of key landmarks ────────────
  // Eyes should be above nose, nose above mouth. If violated, the face
  // detection has likely confused features (e.g. nose detected as mouth).
  // In normalized coordinates, lower y = higher on screen.
  const eyeMidY=((lms[33]?.y||0)+(lms[263]?.y||0))/2;
  const noseY=lms[1]?.y||0;
  const mouthMidY=((lms[61]?.y||0)+(lms[291]?.y||0))/2;
  // Eyes must be above nose, nose must be above mouth (with small tolerance)
  const tolerance=0.01;
  if(eyeMidY > noseY + tolerance || noseY > mouthMidY + tolerance){
    // Landmarks are in wrong vertical order — skip this frame
    return null;
  }

  // ── Helpers ──────────────────────────────────────────────────────────────
  function rotate2D(p,c,ang){
    const x=p.x-c.x, y=p.y-c.y;
    const cs=Math.cos(ang), sn=Math.sin(ang);
    return{x:c.x+x*cs-y*sn, y:c.y+x*sn+y*cs, z:p.z??0};
  }
  function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

  // ── Anchors ───────────────────────────────────────────────────────────────
  const eyeL=lms[33], eyeR=lms[263];       // outer eye corners — far apart → less angle noise
  const licInner=lms[133], ricInner=lms[362]; // inner eye corners — for IOD
  if(!eyeL||!eyeR||!licInner||!ricInner)return null;

  // ── Roll normalization ────────────────────────────────────────────────────
  // Rotate ALL landmarks so the eye line is perfectly horizontal.
  // This zeroes out head-tilt contribution to every y difference.
  const center={x:(eyeL.x+eyeR.x)/2, y:(eyeL.y+eyeR.y)/2};
  const roll=Math.atan2(eyeR.y-eyeL.y, eyeR.x-eyeL.x);
  const norm=lms.map(p=>rotate2D(p,center,-roll));

  // IOD on roll-normalised landmarks (consistent with subsequent math)
  const licN=norm[133], ricN=norm[362];
  const iodN=Math.hypot(licN.x-ricN.x, licN.y-ricN.y)||0.001;

  // ── Symmetric landmark pairs [leftIdx, rightIdx, weight] ─────────────────
  const pairs=[
    [61,  291, 3.0],  // mouth corners        — primary FAST indicator
    [78,  308, 2.5],  // mouth outer corners
    [37,  267, 1.8],  // upper lip lateral
    [84,  314, 1.8],  // lower lip lateral
    [33,  263, 2.2],  // eye outer corners
    [133, 362, 2.2],  // eye inner corners
    [159, 386, 1.5],  // upper eyelid centre
    [145, 374, 1.5],  // lower eyelid centre
    [70,  300, 1.2],  // brow outer
    [107, 336, 1.2],  // brow inner
    [187, 411, 1.4],  // nasolabial fold
    [117, 346, 1.0],  // cheek midpoint
    [123, 352, 1.0],  // cheek upper
  ];

  // ── Best-fit midline ──────────────────────────────────────────────────────
  // For a symmetric face each pair midpoint ≈ facial midline.
  // Weighted average of those midpoints is far more stable than a fixed nose average.
  let midNumer=0, midDenom=0;
  for(const [li,ri,w] of pairs){
    const L=norm[li],R=norm[ri];
    if(!L||!R)continue;
    midNumer+=w*(L.x+R.x)/2;
    midDenom+=w;
  }
  if(midDenom===0)return null;
  const midX=midNumer/midDenom;

  // ── Yaw estimate (cheap z-depth proxy) ───────────────────────────────────
  // When the head is turned, z values diverge across left/right pairs.
  // We use that divergence to reduce the dx penalty so yaw ≠ asymmetry.
  let zDiffSum=0, zDen=0;
  for(const [li,ri,w] of pairs){
    const L=norm[li],R=norm[ri];
    if(!L||!R)continue;
    zDiffSum+=w*Math.abs((L.z??0)-(R.z??0));
    zDen+=w;
  }
  const yawProxy=zDen?(zDiffSum/zDen):0;
  // More yaw → smaller dx weight (floor 0.35 so we never ignore dx completely)
  const dxScale=clamp(1.0-6.0*yawProxy, 0.35, 1.0);

  // ── Symmetry error ────────────────────────────────────────────────────────
  // Mirror left landmark across best-fit midline, compare to actual right.
  // dy weighted 1.35× — vertical droop is the primary clinical signal and
  // is less contaminated by residual yaw than horizontal displacement.
  let weightedSum=0, totalWeight=0;
  for(const [li,ri,w] of pairs){
    const L=norm[li],R=norm[ri];
    if(!L||!R)continue;
    const dx=(2*midX-L.x-R.x)*dxScale;
    const dy=(L.y-R.y)*1.35;
    const dist=Math.hypot(dx,dy)/iodN;
    weightedSum+=dist*w;
    totalWeight+=w;
  }
  if(totalWeight===0)return null;

  const raw=weightedSum/totalWeight;
  // raw ≈ 0.00–0.03 for a symmetric resting face
  // raw ≈ 0.08–0.20 for notable asymmetry
  // NOT clamped — preserve full resolution for baseline z-score comparison
  const index01=clamp(raw/0.25, 0, 1);
  return{raw, index01};
}

// Compute arm drift from pose landmarks (one frame)
// Returns {lx, ly, rx, ry, conf} normalized wrist positions for path-length accumulation
// Uses elbow midpoints to cross-validate wrist position and rejects low-confidence frames
const ARM_VIS_THRESH=0.5;    // minimum visibility for each joint — raised from 0.4
const ARM_JUMP_THRESH=0.12;  // max allowed frame-to-frame wrist jump (normalised units)
let _prevArmFrame=null;      // for jump rejection

function computeArmDrift(lms){
  if(!lms)return null;
  const ls=lms[LM.LEFT_SHOULDER],rs=lms[LM.RIGHT_SHOULDER];
  const le=lms[LM.LEFT_ELBOW],re=lms[LM.RIGHT_ELBOW];
  const lw=lms[LM.LEFT_WRIST],rw=lms[LM.RIGHT_WRIST];
  if(!ls||!rs||!lw||!rw)return null;
  if((lw.visibility||0)<ARM_VIS_THRESH||(rw.visibility||0)<ARM_VIS_THRESH)return null;
  if((ls.visibility||0)<ARM_VIS_THRESH||(rs.visibility||0)<ARM_VIS_THRESH)return null;

  const shoulderSpan=Math.abs(ls.x-rs.x)||0.001;
  // Average confidence of all 4 key joints
  const conf=((lw.visibility||0)+(rw.visibility||0)+(ls.visibility||0)+(rs.visibility||0))/4;

  const rawLx=(lw.x-ls.x)/shoulderSpan, rawLy=(lw.y-ls.y)/shoulderSpan;
  const rawRx=(rw.x-rs.x)/shoulderSpan, rawRy=(rw.y-rs.y)/shoulderSpan;

  // ── Elbow cross-validation: if elbows are visible, reject frames where wrist
  //    is NOT roughly beyond the elbow (anatomically impossible for raised arms)
  if(le&&re&&(le.visibility||0)>0.45&&(re.visibility||0)>0.45){
    // For raised arms, wrist.y should be <= elbow.y (higher up). If wrist is much
    // BELOW elbow, the wrist landmark is likely a mis-detection
    const elbowMargin=0.15*shoulderSpan; // allow some slack
    if(lw.y > le.y + elbowMargin && rw.y > re.y + elbowMargin){
      // Both wrists well below elbows while arms should be raised — likely bad detection
      return null;
    }
  }

  // ── Apply rolling median filter to suppress single-frame outliers ──
  pushMedianBuf(_armMedianBufL,{x:rawLx,y:rawLy});
  pushMedianBuf(_armMedianBufR,{x:rawRx,y:rawRy});
  const medL=getMedian2D(_armMedianBufL);
  const medR=getMedian2D(_armMedianBufR);
  if(!medL||!medR)return null;

  const lx=medL.x, ly=medL.y, rx=medR.x, ry=medR.y;

  // ── Frame-to-frame jump rejection ──
  // If either wrist jumped more than ARM_JUMP_THRESH since last frame, skip
  if(_prevArmFrame){
    const ljump=Math.sqrt(Math.pow(lx-_prevArmFrame.lx,2)+Math.pow(ly-_prevArmFrame.ly,2));
    const rjump=Math.sqrt(Math.pow(rx-_prevArmFrame.rx,2)+Math.pow(ry-_prevArmFrame.ry,2));
    if(ljump>ARM_JUMP_THRESH||rjump>ARM_JUMP_THRESH){
      // Don't update _prevArmFrame — wait for position to settle
      return null;
    }
  }
  _prevArmFrame={lx,ly,rx,ry};

  return {lx, ly, rx, ry, conf};
}

// ── Countdown audio (Web Audio API — no files needed) ─────────────────────
// tick: short 880Hz sine pop, fast decay — a crisp "blip"
// chime: two-note ascending tone (C5 → E5) with longer sustain
function _playCountdownTick(){
  try{
    const ac=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ac.createOscillator();
    const gain=ac.createGain();
    osc.connect(gain);gain.connect(ac.destination);
    osc.type='sine';
    osc.frequency.setValueAtTime(880,ac.currentTime);
    gain.gain.setValueAtTime(0.18,ac.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.12);
    osc.start(ac.currentTime);
    osc.stop(ac.currentTime+0.12);
    osc.onended=()=>ac.close();
  }catch(e){}
}

function _playStartChime(){
  try{
    const ac=new(window.AudioContext||window.webkitAudioContext)();
    // Note 1: C5 (523Hz)
    const o1=ac.createOscillator(), g1=ac.createGain();
    o1.connect(g1);g1.connect(ac.destination);
    o1.type='sine';
    o1.frequency.setValueAtTime(523.25,ac.currentTime);
    g1.gain.setValueAtTime(0.0,ac.currentTime);
    g1.gain.linearRampToValueAtTime(0.22,ac.currentTime+0.02);
    g1.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.38);
    o1.start(ac.currentTime);o1.stop(ac.currentTime+0.38);
    // Note 2: E5 (659Hz), starts 0.18s later
    const o2=ac.createOscillator(), g2=ac.createGain();
    o2.connect(g2);g2.connect(ac.destination);
    o2.type='sine';
    o2.frequency.setValueAtTime(659.25,ac.currentTime+0.18);
    g2.gain.setValueAtTime(0.0,ac.currentTime+0.18);
    g2.gain.linearRampToValueAtTime(0.26,ac.currentTime+0.20);
    g2.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.72);
    o2.start(ac.currentTime+0.18);o2.stop(ac.currentTime+0.72);
    o2.onended=()=>ac.close();
  }catch(e){}
}

function runCountdown(){
  const overlay=document.getElementById('countdown-overlay');
  const numEl=document.getElementById('countdown-num');
  overlay.classList.add('visible');
  _playCountdownTick(); // play immediately for "3"
  return new Promise(resolve=>{
    let count=3;
    numEl.textContent=count;
    numEl.style.animation='none';
    void numEl.offsetWidth;
    numEl.style.animation='cntPop 0.35s cubic-bezier(0.175,0.885,0.32,1.275) forwards';
    const tick=setInterval(()=>{
      count--;
      if(count<=0){
        clearInterval(tick);
        overlay.classList.remove('visible');
        _playStartChime(); // ascending chime on GO
        resolve();
      } else {
        _playCountdownTick(); // tick on 2 and 1
        numEl.textContent=count;
        numEl.style.animation='none';
        void numEl.offsetWidth;
        numEl.style.animation='cntPop 0.35s cubic-bezier(0.175,0.885,0.32,1.275) forwards';
      }
    },1000);
  });
}

async function startRec(){
  const btn=document.getElementById('btn-go');
  btn.disabled=true;
  btn.textContent='Get ready…';
  await initCam();

  // 3-2-1 countdown on the camera
  await runCountdown();

  btn.textContent='Recording…';
  document.getElementById('rec-ind').classList.add('on');
  _measuredWpm=null;_measuredPauseRatio=null;_measuredJitter=null;_measuredShimmer=null;
  // Start MediaRecorder to capture video for replay
  _recordedChunks=[];
  try{
    if(stream){
      _mediaRecorder=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'});
      _mediaRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0)_recordedChunks.push(e.data);};
      _mediaRecorder.start(200);
    }
  }catch(e){_mediaRecorder=null;}
  tIdx=0;
  _faceFrames=[];_armFrames=[];_prevArmFrame=null;resetArmMedianBufs();
  _collectingFace=false;_collectingArms=false;
  // Start the preview loop NOW so face/pose detection runs during all tasks.
  // stopSQ() pauses the animateSQ interval — the preview loop takes over body visibility.
  stopSQ();
  startPreviewLoop();
  runTask();
}

function runTask(){
  if(tIdx>=TASKS.length){endRec();return;}
  const t=TASKS[tIdx];recTime=t.dur;
  const goBtn=document.getElementById('btn-go');
  if(goBtn){goBtn.textContent='Recording…';goBtn.disabled=true;}
  document.getElementById('prompt-banner').innerHTML=t.banner;
  document.getElementById('prompt-banner').className='prompt-banner '+t.cls;
  document.getElementById('cam-tip').textContent=t.tip;
  document.getElementById('timer-lbl').textContent=t.id.toUpperCase()+' TASK';
  document.getElementById(t.tp).className='tp-task active';

  // Start collection flags and speech
  _collectingFace=(t.id==='smile');
  _collectingArms=(t.id==='arms');
  if(t.id==='speak'){startSpeechRecognition();if(stream)startJitterShimmer(stream);}

  tickTimer(recTime,t.dur,tIdx);
  recTimer=setInterval(()=>{
    // Early finish for speak task when all passage words detected
    if(t.id==='speak'&&_spokenWords.length>=SPEECH_WORD_COUNT){
      recTime=0;
    }
    recTime--;
    if(recTime<0)recTime=0;
    tickTimer(recTime,t.dur,tIdx);
    if(recTime<=0){
      clearInterval(recTimer);
      _collectingFace=false;
      _collectingArms=false;
      if(t.id==='speak'){const wpm=stopSpeechRecognition();if(wpm)_measuredWpm=wpm;stopJitterShimmer();}
      document.getElementById(t.chk).textContent='✓';
      document.getElementById(t.tp).className='tp-task done';
      tIdx++;
      if(tIdx>=TASKS.length){
        setTimeout(endRec,300);
      } else {
        // Auto-advance: show next task name for 2 seconds then start immediately
        const nextTask=TASKS[tIdx];
        const names={smile:'Neutral Face',arms:'Raise Both Arms',speak:'Read Passage'};
        const icons={smile:'😐',arms:'🙌',speak:'🗣️'};
        document.getElementById('prompt-banner').innerHTML=`⏭ &nbsp;NEXT: ${icons[nextTask.id]} ${names[nextTask.id].toUpperCase()}`;
        document.getElementById('prompt-banner').className='prompt-banner pause';
        document.getElementById('timer-lbl').textContent='GET READY';
        document.getElementById('timer-num').textContent='2';
        // Disable the go button during auto-transition so it can't be double-pressed
        const goBtn=document.getElementById('btn-go');
        goBtn.disabled=true;
        setTimeout(()=>{
          document.getElementById('timer-num').textContent='1';
        },1000);
        setTimeout(()=>{
          goBtn.disabled=false;
          runTask();
        },2000);
      }
    }
  },1000);
}

function tickTimer(cur,tot,ti){
  const r=document.getElementById('timer-ring');const n=document.getElementById('timer-num');
  const circ=251.3;r.style.strokeDashoffset=circ*(1-cur/tot);
  r.style.stroke=['var(--teal)','var(--violet)','var(--blue)'][ti]||'var(--teal)';
  n.textContent=cur;
}

function endRec(){
  document.getElementById('rec-ind').classList.remove('on');
  stopSQ();
  // Stop MediaRecorder
  if(_mediaRecorder&&_mediaRecorder.state!=='inactive'){
    _mediaRecorder.stop();
  }
  showQualityGate();
}

function resetRec(skipPreview){
  clearInterval(recTimer);tIdx=0;
  if(_mediaRecorder&&_mediaRecorder.state!=='inactive'){try{_mediaRecorder.stop();}catch(e){}}_mediaRecorder=null;_recordedChunks=[];
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
  stopSQ();stopPreviewLoop();_measuredWpm=null;_measuredPauseRatio=null;_wpmSpike=false;
  const passageOverlay=document.getElementById('speech-passage-overlay');
  if(passageOverlay)passageOverlay.style.display='none';
  // Hide countdown overlay if it's showing
  const co=document.getElementById('countdown-overlay');if(co)co.classList.remove('visible');
  const ph=document.getElementById('cam-placeholder');
  if(ph)ph.style.display='flex';
  document.getElementById('cam-video').srcObject=null;
  const goBtn2=document.getElementById('btn-go');
  goBtn2.disabled=false;
  goBtn2.textContent='▶  Start Recording';
  goBtn2.onclick=startRec; // restore default handler (was null, which broke the button)
  _faceFrames=[];_armFrames=[];_prevArmFrame=null;resetArmMedianBufs();
  _collectingFace=false;_collectingArms=false;
  document.getElementById('rec-ind').classList.remove('on');
  const _strip=document.getElementById('speech-strip');if(_strip)_strip.classList.remove('active');
  const _ssWpm=document.getElementById('ss-wpm-live');if(_ssWpm)_ssWpm.textContent='—';
  const _ssBk=document.getElementById('ss-buckets');if(_ssBk)_ssBk.innerHTML='';
  const _ssPw=document.getElementById('ss-passage-words');if(_ssPw)_ssPw.innerHTML='';
  document.getElementById('prompt-banner').innerHTML='😐 &nbsp;NEUTRAL FACE — keep still';
  document.getElementById('prompt-banner').className='prompt-banner smile';
  document.getElementById('timer-num').textContent='—';
  document.getElementById('timer-lbl').textContent='Ready to begin';
  document.getElementById('timer-ring').style.strokeDashoffset='0';
  TASKS.forEach(t=>{document.getElementById(t.chk).textContent='○';document.getElementById(t.tp).className=t.id==='smile'?'tp-task active':'tp-task pending';});
  // Restart preview unless told not to
  if(!skipPreview)initCamPreview();
}

/* ── PROCESSING ── */
function runProcessing(){
  const faceMsg=isBaselineMode?'Capturing baseline face symmetry…':'Comparing face symmetry to your baseline…';
  const armsMsg=isBaselineMode?'Capturing baseline arm position…':'Comparing arm stability to your baseline…';
  const speechMsg=isBaselineMode?'Capturing baseline speech cadence…':'Comparing speech clarity to your baseline…';
  document.getElementById('pc-face-met').textContent=faceMsg;
  document.getElementById('pc-arms-met').textContent=armsMsg;
  document.getElementById('pc-speech-met').textContent=speechMsg;
  ['face','arms','speech'].forEach(id=>{
    const el=document.getElementById('pc-'+id);
    el.classList.remove('running','done');
    document.getElementById('pc-'+id+'-st').innerHTML='<span class="spinner"></span>';
  });
  const steps=[
    {id:'face',met:isBaselineMode?'Baseline face symmetry captured ✓':'Face asymmetry compared to baseline ✓',delay:1200},
    {id:'arms',met:isBaselineMode?'Baseline arm position captured ✓':'Arm drift compared to baseline ✓',delay:2600},
    {id:'speech',met:isBaselineMode?'Baseline speech cadence captured ✓':'Speech clarity compared to baseline ✓',delay:4000}
  ];
  steps.forEach(s=>{
    document.getElementById('pc-'+s.id).classList.add('running');
    setTimeout(()=>{
      document.getElementById('pc-'+s.id+'-met').textContent=s.met;
      document.getElementById('pc-'+s.id+'-st').textContent='✅';
      document.getElementById('pc-'+s.id).classList.remove('running');
      document.getElementById('pc-'+s.id).classList.add('done');
    },s.delay);
  });
  setTimeout(()=>{buildResults();showScreen('results');startPreviewLoop();},5000);
}

/* ── RESULTS ── */
let _res=null;

// Robust stats helpers
function _median(arr){
  if(!arr.length)return 0;
  const b=[...arr].sort((a,b)=>a-b);
  const m=Math.floor(b.length/2);
  return b.length%2?b[m]:(b[m-1]+b[m])/2;
}
function _mad(arr,med){
  // Median Absolute Deviation — robust spread estimate
  return _median(arr.map(v=>Math.abs(v-med)));
}

function buildResults(){
  // ── Face asymmetry ────────────────────────────────────────────────────────
  // _faceFrames contains `raw` values from computeFaceAsymmetry (uncapped).
  //
  // IMPROVED APPROACH:
  //   1. Use the SESSION MEDIAN as the primary stable metric (replaces the
  //      problematic max(median,p90) that was inflated by single-frame artifacts).
  //   2. Separately detect TRANSIENT DROOPS by sliding a 3-second window and
  //      checking whether any window median exceeds 1.5× the session median.
  //      This catches brief but sustained droops without contaminating the score.
  //   3. Z-SCORE comparison against baseline is now used directly as the
  //      reported risk signal (clamped to [0,3]), replacing the no-op
  //      recombination (baseline.fa + z*baseline.faMad === faRaw always).
  //   4. Apply an IOD-based frame quality gate: frames collected when the face
  //      is very small (IOD < MIN_IOD_FRAC of image width) are excluded because
  //      landmark noise dominates at that scale.
  //
  // fa is the raw asymmetry score for display and storage.
  // faRiskZ is the z-score deviation from personal baseline (stored in _res).

  let fa = null;
  let faTransientFlag = false; // true if a 3-s window caught a transient droop
  let faRiskZ = 0;             // z-score deviation from baseline (for risk scoring)

  if(_faceFrames.length >= 2){
    const faMed = _median(_faceFrames);

    // ── Transient droop detection: sliding window of ~3s (≈ fps*3 frames) ──
    // Flag if any consecutive window of ≥3 frames has a median > 1.5× session median
    const WIN = Math.max(3, Math.floor(_faceFrames.length * 0.15));
    if(faMed > 0.01 && _faceFrames.length >= WIN){
      for(let i = 0; i <= _faceFrames.length - WIN; i++){
        const slice = _faceFrames.slice(i, i + WIN);
        const winMed = _median(slice);
        if(winMed > faMed * 1.5){
          faTransientFlag = true;
          break;
        }
      }
    }

    fa = +faMed.toFixed(4);

    // ── Z-score vs personal baseline ──────────────────────────────────────
    // FIXED: the old code computed z then immediately recombined back to faRaw.
    // Now we store the z-score itself and use it for risk scoring.
    if(baseline && baseline.fa != null && baseline.faMad != null && parseFloat(baseline.faMad) > 0.001){
      faRiskZ = (faMed - parseFloat(baseline.fa)) / parseFloat(baseline.faMad);
      // Clamp to [0, 5] — negative z means better than baseline
      faRiskZ = Math.max(0, Math.min(5, faRiskZ));
    }

  } else {
    // Fewer than 2 good frames — face was likely not visible or heavily moving.
    // NULL fallback — NOT a random/fake number. UI will show "Not captured".
    fa = null;
    faRiskZ = 0;
    console.warn('Face: insufficient frames collected (', _faceFrames.length, ') — result is null');
  }

  // ── Arm Stability Index (0–100) ───────────────────────────────────────────
  // IMPROVED:
  //   1. FRAME-RATE NORMALIZATION: path distances are divided by frame count so
  //      a faster capture rate doesn't artificially inflate the score.
  //   2. NULL FALLBACK: if arms were not captured, ad is null (not a random
  //      number). The UI will show "Not captured" rather than fake data.
  //   3. SCALE DOCUMENTATION: constants are derived from expected ranges:
  //      - maxDropY ≈ 0–0.15 shoulder-spans for a 10s hold. 0.05 = notable.
  //        dropScore = maxDropY * 100 → 0.05 → 5, 0.15 → 15. Max cap 60.
  //      - pathAsymmetry ≈ 0–0.10 per frame * N frames / N = 0–0.10 (normalized).
  //        asymScore = pathAsymmetry * 100 → 0–10. Max cap 30.
  //      - totalPath (normalized) ≈ 0–0.05 per frame * N frames / N = 0–0.05.
  //        pathScore = totalPath * 20 → 0–1. Max cap 10.
  //      Combined max ≈ 36 + 7.5 + 1 = ~45 before the hard cap of 100.
  //   4. RENAMED: reported as "Arm Stability Index (0–100)" where 100 = maximum
  //      detected instability at threshold, replacing the misleading "% over 5s".
  let ad = null; // null = not captured
  if(_armFrames.length >= 5){
    const N = _armFrames.length - 1; // number of inter-frame intervals
    let leftDistSum = 0, rightDistSum = 0;
    const DRIFT_DEADZONE = 0.018; // ~1.8% of shoulder span per frame
    for(let i = 1; i < _armFrames.length; i++){
      const prev = _armFrames[i-1], curr = _armFrames[i];
      const ld = Math.sqrt(Math.pow(curr.lx-prev.lx,2)+Math.pow(curr.ly-prev.ly,2));
      const rd = Math.sqrt(Math.pow(curr.rx-prev.rx,2)+Math.pow(curr.ry-prev.ry,2));
      if(ld > DRIFT_DEADZONE) leftDistSum  += ld;
      if(rd > DRIFT_DEADZONE) rightDistSum += rd;
    }

    // Normalize path totals by number of intervals (removes frame-rate bias)
    const leftDist  = leftDistSum  / N;
    const rightDist = rightDistSum / N;

    // ── Vertical displacement: how far each wrist DROPPED from start ──
    // Primary clinical signal — one arm drifting downward
    const first = _armFrames[0], last = _armFrames[_armFrames.length-1];
    const leftDropY  = Math.max(0, last.ly - first.ly); // positive = dropped
    const rightDropY = Math.max(0, last.ry - first.ry);
    const maxDropY   = Math.max(leftDropY, rightDropY);

    // ── Path asymmetry (frame-rate-normalized) ──
    // Unilateral weakness shows as one arm moving much more than the other
    const pathAsymmetry = Math.abs(leftDist - rightDist);
    const totalPath     = leftDist + rightDist;

    // ── Combined score scaled to 0–100 ──
    // dropScore:   0.05 drop (notable) → ~5,  0.15 (severe) → ~15.  Cap 60.
    // asymScore:   0.05 asym (notable) → ~5,  0.10 (severe) → ~10.  Cap 30.
    // pathScore:   0.025 path/frame    → ~0.5.  Cap 10.
    // Weights: vertical drop 60%, asymmetry 25%, total path 15%
    const dropScore  = Math.min(60, maxDropY * 100);
    const asymScore  = Math.min(30, pathAsymmetry * 100);
    const pathScore  = Math.min(10, totalPath * 20);
    const combined   = dropScore*0.60 + asymScore*0.25 + pathScore*0.15;
    ad = +Math.min(100, combined * 3.33).toFixed(1); // ×3.33 maps combined≈30 → 100
  } else {
    // Arms not captured — use null, not random noise
    ad = null;
    console.warn('Arms: insufficient frames (', _armFrames.length, ') — result is null');
  }

  // ── Pause ratio and WPM: use measured values only, null if not available ──
  // FIXED: removed random fallbacks (0.1+Math.random()*0.38 and 88+Math.random()*65).
  // Null values are shown as "Not captured" in the UI and excluded from scoring.
  const pr = _measuredPauseRatio !== null ? _measuredPauseRatio : null;
  const wpm = _measuredWpm !== null ? _measuredWpm : null;

  // ── WPM deviation score (replaces binary spike flag) ──────────────────────
  // IMPROVED: instead of binary 0/1, compute a continuous deviation measure.
  // wpmDevScore ∈ [0,1]: 0 = steady rhythm, 1 = severe spike/dip (≥80% deviation).
  // This gives more meaningful variance in the 25% weight slot.
  let wpmDevScore = 0.0;
  if(_wpmBuckets.length >= 2){
    const bSorted = [..._wpmBuckets].sort((a,b)=>a-b);
    const bMed = bSorted[Math.floor(bSorted.length/2)];
    if(bMed > 0){
      // Max relative deviation of any bucket from the session median
      const maxDev = Math.max(..._wpmBuckets.map(b => Math.abs(b - bMed) / bMed));
      // Map: 0.2 deviation → 0.0 (normal variation), 0.8 deviation → 1.0
      wpmDevScore = Math.min(1, Math.max(0, (maxDev - 0.2) / 0.6));
    }
  }
  // Keep backward-compatible spike flag for UI display
  const _wpmSpikeDisplay = wpmDevScore > 0.5;

  // fa is null if face was not captured
  const faNum = fa !== null ? parseFloat(fa) : null;
  const adNum = ad !== null ? parseFloat(ad) : null;

  // ── Face risk score (fs) ─────────────────────────────────────────────────
  // IMPROVED: when a personal baseline exists, use the z-score (faRiskZ)
  // instead of an absolute threshold. z=2 → fs≈0.6, z=3 → fs≈1.0.
  // When no baseline: fall back to the absolute threshold approach.
  // Transient droop adds a bonus of 0.15 (capped at 1.0).
  let fs = 0;
  if(faNum !== null){
    if(baseline && baseline.fa != null && baseline.faMad != null && parseFloat(baseline.faMad) > 0.001){
      fs = Math.min(1, faRiskZ / 3.0);              // z=3 → fs=1.0
    } else {
      fs = faNum > 0.08 ? Math.min(1, 0.55 + (faNum - 0.08) * 6) : 0;
    }
    if(faTransientFlag) fs = Math.min(1, fs + 0.15); // transient droop bonus
  }

  // ── Arm risk score (as) ──────────────────────────────────────────────────
  // Arm Stability Index (0–100): thresholds 15=mild, 30=elevated
  let as = 0;
  if(adNum !== null){
    as = adNum > 30 ? Math.min(1, 0.65 + (adNum - 30) * 0.012) : adNum > 15 ? 0.35 : 0;
  }

  // ── Speech score (ss): weight redistribution when signals are null ─────────
  // IMPROVED:
  //   1. Pause ratio and jitter/shimmer use null to mean "not captured", which
  //      causes their weight to be redistributed among available signals.
  //   2. WPM deviation is now continuous (wpmDevScore) not binary.
  //   3. The COMPOSITE score ss (not just pr) is shown as the primary speech metric.
  //
  // Base weights: pause 35%, wpmDev 25%, jitter 25%, shimmer 15%
  const _ssWeights = {
    pause:   { val: pr !== null ? (pr > 0.35 ? 1.0 : pr > 0.25 ? 0.5 : 0.0) : null, w: 0.35 },
    wpm:     { val: wpmDevScore,                                                       w: 0.25 },
    jitter:  { val: _measuredJitter,                                                   w: 0.25 },
    shimmer: { val: _measuredShimmer,                                                  w: 0.15 },
  };
  // Sum weights of available (non-null) signals
  const _ssActiveW = Object.values(_ssWeights).reduce((acc,s) => acc + (s.val !== null ? s.w : 0), 0);
  let ss = 0;
  if(_ssActiveW > 0){
    // Normalize weights across available signals only
    ss = Object.values(_ssWeights).reduce((acc, s) => {
      if(s.val === null) return acc;
      return acc + s.val * (s.w / _ssActiveW);
    }, 0);
    ss = Math.min(1, ss);
  }

  const total = fs + as + ss;

  // Store quality score for this recording
  storeQualityScore(_qualityScore);

  // Update confidence UI — pass current check-in as pending so ring advances immediately
  const pendingEntry=isBaselineMode?null:{fRaw:faNum,aRaw:adNum,sRaw:pr,quality:_qualityScore};
  const {conf,level}=updateConfidenceUI(pendingEntry);
  const confBanner=document.getElementById('conf-banner');
  if(confBanner)confBanner.style.display=isBaselineMode?'none':'flex';

  // ── Null-safe metric display ──────────────────────────────────────────────
  // Show "Not captured" when a signal is null rather than displaying fake data.
  const _faceValEl = document.getElementById('face-val');
  if(_faceValEl){
    if(faNum !== null){
      _faceValEl.innerHTML = faNum.toFixed(4) + '<span class="mc-unit">/ 0.08 threshold</span>';
    } else {
      _faceValEl.innerHTML = '<span class="mc-unit mc-unit-warn">Not captured</span>';
    }
  }
  const _armsValEl = document.getElementById('arms-val');
  if(_armsValEl){
    if(adNum !== null){
      // Arm Stability Index 0–100 (was misleadingly "% over 5s")
      _armsValEl.innerHTML = adNum.toFixed(1) + '<span class="mc-unit">/ 100 stability index</span>';
    } else {
      _armsValEl.innerHTML = '<span class="mc-unit mc-unit-warn">Not captured</span>';
    }
  }
  const _speechValEl = document.getElementById('speech-val');
  if(_speechValEl){
    // Show the COMPOSITE speech score (ss) as the primary metric, not just pause ratio
    if(_ssActiveW > 0){
      _speechValEl.innerHTML = (ss * 100).toFixed(0) + '<span class="mc-unit">/ 100 speech index</span>';
    } else {
      _speechValEl.innerHTML = '<span class="mc-unit mc-unit-warn">Not captured</span>';
    }
  }
  // Speech stats panel
  const _wpmEl=document.getElementById('wpm-txt');
  if(_wpmEl){_wpmEl.textContent=wpm?wpm+' wpm':'n/a';_wpmEl.className='speech-stat-val '+(wpm>=80&&wpm<=180?'good':wpm>0?'warn':'bad');}
  const _pauseEl=document.getElementById('pause-txt');
  if(_pauseEl){
    if(pr !== null){ _pauseEl.textContent=(pr*100).toFixed(0)+'%';_pauseEl.className='speech-stat-val '+(pr<0.25?'good':pr<0.35?'warn':'bad');}
    else { _pauseEl.textContent='n/a';_pauseEl.className='speech-stat-val neutral'; }
  }
  const _spikeEl=document.getElementById('spike-txt');
  if(_spikeEl){_spikeEl.textContent=_wpmSpikeDisplay?'⚠ Spike detected':'✓ Steady';_spikeEl.className='speech-stat-val '+(_wpmSpikeDisplay?'warn':'good');}
  const _jitterEl=document.getElementById('jitter-txt');
  if(_jitterEl){
    if(_measuredJitter===null){_jitterEl.textContent='n/a';_jitterEl.className='speech-stat-val neutral';}
    else{const pct=(_measuredJitter*100).toFixed(0)+'%';_jitterEl.textContent=pct;_jitterEl.className='speech-stat-val '+(_measuredJitter<0.3?'good':_measuredJitter<0.6?'warn':'bad');}
  }
  const _shimmerEl=document.getElementById('shimmer-txt');
  if(_shimmerEl){
    if(_measuredShimmer===null){_shimmerEl.textContent='n/a';_shimmerEl.className='speech-stat-val neutral';}
    else{const pct=(_measuredShimmer*100).toFixed(0)+'%';_shimmerEl.textContent=pct;_shimmerEl.className='speech-stat-val '+(_measuredShimmer<0.3?'good':_measuredShimmer<0.6?'warn':'bad');}
  }
  const _wordsEl=document.getElementById('words-txt');
  if(_wordsEl){_wordsEl.textContent=_spokenWords.length+' / '+SPEECH_WORD_COUNT;_wordsEl.className='speech-stat-val neutral';}
  const _covEl=document.getElementById('coverage-txt');
  const _cov=Math.min(100,Math.round(_spokenWords.length/SPEECH_WORD_COUNT*100));
  if(_covEl){_covEl.textContent=_cov+'%';_covEl.className='speech-stat-val '+(_cov>=80?'good':_cov>=50?'warn':'bad');}
  const _resBuckets=document.getElementById('ss-res-buckets');
  if(_resBuckets&&_wpmBuckets.length){
    const _bMax=Math.max(..._wpmBuckets,1);
    const _bSorted=[..._wpmBuckets].sort((a,b)=>a-b);
    const _bMed=_bSorted[Math.floor(_bSorted.length/2)];
    _resBuckets.innerHTML=_wpmBuckets.map(b=>{
      const h=Math.max(3,Math.round((b/_bMax)*28));
      const isSpike=_bMed>0&&Math.abs(b-_bMed)/_bMed>0.4;
      return '<div class="ss-res-bucket-bar'+(isSpike?' spike':'')+'" style="height:'+h+'px;" title="'+b+' wpm"></div>';
    }).join('');
  } else if(_resBuckets){_resBuckets.innerHTML='';}

  // ── BASELINE MODE: save values, show success UI ──
  if(isBaselineMode){
    setBadge('face-badge',0);setBadge('arms-badge',0);setBadge('speech-badge',0);
    // nudgeLine is null-safe: only update if value exists
    if(faNum !== null) nudgeLine('face-line',faNum,0.08);
    if(adNum !== null) nudgeLine('arms-line',adNum,30);  // updated threshold to match new 0-100 scale
    if(pr !== null) nudgeLine('speech-line',pr,0.35);
    ['face','arms','speech'].forEach(id=>document.getElementById(id+'-delta-row').style.display='none');
    document.getElementById('sb').className='status-banner baseline';
    document.getElementById('sb-orb').textContent='📐';
    document.getElementById('sb-title').textContent='Baseline Recorded';
    document.getElementById('sb-desc').textContent='This is your personal reference. Every future FAST Check will be compared against these values — not population averages.';
    document.getElementById('sb-score').textContent='—';
    document.getElementById('action-panel').className='action-panel green';
    document.getElementById('act-title').textContent='Your baseline has been saved.';
    document.getElementById('act-desc').textContent='You can now run your first FAST Check. If your health changes or you feel your baseline is outdated, you can re-record it from the home screen at any time.';
    const pBtn=document.getElementById('action-panel').querySelector('.act-btn-p');
    const sBtn=document.getElementById('action-panel').querySelector('.act-btn-s');
    pBtn.textContent='Start First FAST Check';
    pBtn.onclick=function(){baseline=JSON.parse(localStorage.getItem('sc_baseline')||'null');updateHomeScreen();goFastCheck();};
    sBtn.textContent='Back to Home';
    sBtn.onclick=function(){baseline=JSON.parse(localStorage.getItem('sc_baseline')||'null');updateHomeScreen();showScreen('home');};
    const bData={date:new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),fa:faNum,ad:adNum,pr,wpm};
    // Also store MAD of face frames so FAST checks can compute a personal z-score
    if(_faceFrames.length>=4){
      const bMed=_median(_faceFrames);
      bData.faMad=+_mad(_faceFrames,bMed).toFixed(5);
    }
    try{localStorage.setItem('sc_baseline',JSON.stringify(bData));}catch(e){}
    baseline=bData;
    // Save baseline video
    if(_recordedChunks.length>0){
      const blob=new Blob(_recordedChunks,{type:'video/webm'});
      if(_recordingBlobs.has('baseline'))URL.revokeObjectURL(_recordingBlobs.get('baseline'));
      _recordingBlobs.set('baseline',URL.createObjectURL(blob));
      idbPut('baseline',blob); // persist across refreshes
    }
    _res={date:new Date(),fa:faNum,ad:adNum,pr,wpm,fs:0,as:0,ss:0,total:0,status:'baseline',isBaseline:true};
    return;
  }

  // ── FAST CHECK MODE: compare to baseline ──
  setBadge('face-badge',fs);setBadge('arms-badge',as);setBadge('speech-badge',ss);
  if(faNum !== null) nudgeLine('face-line',faNum,0.08);
  if(adNum !== null) nudgeLine('arms-line',adNum,30); // updated threshold for 0-100 scale
  if(pr !== null) nudgeLine('speech-line',pr,0.35);
  if(baseline){
    if(faNum !== null && baseline.fa != null) showDelta('face',faNum,baseline.fa);
    if(adNum !== null && baseline.ad != null) showDelta('arms',adNum,parseFloat(baseline.ad));
    if(pr !== null && baseline.pr != null) showDelta('speech',pr,baseline.pr);
  }

  // ── TREND ESCALATION ──
  const evalTrend=()=>{
    const recent=hist.slice(0,5).map(h=>h.status); // newest first
    const reds=recent.filter(s=>s==='red').length;
    const yellowOrRed=recent.filter(s=>s==='yellow'||s==='red').length;
    const consecutive=(()=>{let c=0;for(const s of recent){if(s==='red')c++;else break;}return c;})();
    const yellowStreak=(()=>{let c=0;for(const s of recent){if(s==='yellow'||s==='red')c++;else break;}return c;})();
    if(consecutive>=2||reds>=3) return 'strong';
    if(yellowOrRed>=3||yellowStreak>=3) return 'soft';
    return null;
  };
  const trendFlag=evalTrend();
  
  // Confidence-aware alert thresholds
  const allowRed=level==='high';
  const allowYellow=level==='high'||level==='medium';

  let sc='green',orb='✅',title='All Clear',desc='',at='',ad2='';

  if(allowRed&&(total>=2||fs>=0.9||as>=0.9||ss>=0.9)){
    sc='red';orb='⚠️';title='Possible Warning Signs';
    desc='One or more FAST signals show notable deviation from your baseline. This is not a diagnosis, but warrants attention.';
    at=trendFlag==='strong'?'Pattern detected across multiple check-ins — consider urgent medical evaluation.'
       :trendFlag==='soft'?'This pattern has appeared before. Consider speaking with a healthcare professional.'
       :'If symptoms are sudden or new, seek care immediately.';
    ad2=trendFlag==='strong'
      ?'This concerning pattern has appeared in multiple recent check-ins. We strongly recommend discussing this with a healthcare professional soon.'
      :trendFlag==='soft'
      ?'Elevated signals have appeared in several recent check-ins. This is not a diagnosis, but persistence across sessions is worth investigating.'
      :'Notable irregularities detected versus your baseline. If you experience sudden facial drooping, arm weakness, or slurred speech, seek emergency care now.';
  } else if(allowYellow&&total>=1){
    sc='yellow';orb='⚡';title='Mild Variation Detected';
    desc='Some signals showed slight deviation from your baseline. This may be normal day-to-day variation.';
    at=trendFlag==='soft'?'This mild variation has appeared in several recent sessions. Consider a retake or professional check-in.'
       :'Consider a retake or consult a professional.';
    ad2=trendFlag==='soft'
      ?'Mild deviations have shown up across several recent check-ins. While not alarming, a consistent mild pattern is worth monitoring closely.'
      :'One or more signals were slightly outside your baseline range. This may be natural variation — consider retaking or speaking with a healthcare professional if it persists.';
  } else {
    at='No warning signals detected.';
    if(level==='low'){
      ad2="Patterns are within a normal range, but we're still calibrating your baseline. Complete more check-ins for reliable trend detection.";
      desc="No notable changes detected. Your baseline is still calibrating — more check-ins will make insights more reliable.";
    } else if(level==='medium'){
      ad2='Signals are consistent with your developing baseline. Trends are taking shape — keep checking in regularly.';
    } else {
      ad2='All three FAST indicators are consistent with your personal baseline. Keep checking in regularly to spot gradual shifts over time.';
    }
  }

  document.getElementById('sb').className='status-banner '+sc;
  document.getElementById('sb-orb').textContent=orb;
  document.getElementById('sb-title').textContent=title;
  document.getElementById('sb-desc').textContent=desc;
  document.getElementById('sb-score').textContent=total.toFixed(1);
  document.getElementById('action-panel').className='action-panel '+sc;
  document.getElementById('act-title').textContent=at;
  document.getElementById('act-desc').textContent=ad2;
  const pBtn=document.getElementById('action-panel').querySelector('.act-btn-p');
  const sBtn=document.getElementById('action-panel').querySelector('.act-btn-s');
  const sBtn2=document.getElementById('action-panel').querySelector('.act-btn-export');
  pBtn.textContent='Save & View History';pBtn.onclick=saveAndHistory;
  sBtn.textContent='Retake';sBtn.onclick=goFastCheck;
  if(sBtn2){sBtn2.onclick=()=>generateSummary(sc,faNum,adNum,pr,fs,as,ss,total);}


  // Trend banner
  const trendEl=document.getElementById('trend-banner');
  if(trendEl){
    if(trendFlag==='strong'){
      trendEl.style.display='flex';
      trendEl.className='trend-banner strong';
      trendEl.innerHTML='<span class="tb-icon">📈</span><span class="tb-msg"><strong>Pattern Alert:</strong> Concerning signals have appeared across multiple recent check-ins. This pattern warrants medical attention beyond any single result.</span>';
    } else if(trendFlag==='soft'){
      trendEl.style.display='flex';
      trendEl.className='trend-banner soft';
      trendEl.innerHTML='<span class="tb-icon">📊</span><span class="tb-msg"><strong>Watch Closely:</strong> Mild or elevated signals have appeared in several recent sessions. Consider consulting a professional if the pattern continues.</span>';
    } else {
      trendEl.style.display='none';
    }
  }

  _res={date:new Date(),fa:faNum,ad:adNum,pr,wpm,fs,as,ss,total,status:sc,trendFlag,isBaseline:false};

  // Feature 6: draw signal fingerprint
  drawFingerprint(faNum,adNum !== null ? adNum : 0, pr !== null ? pr : 0, fs,as,ss);
}

function showDelta(key,current,baseVal){
  const row=document.getElementById(key+'-delta-row');
  const chip=document.getElementById(key+'-delta-chip');
  const bval=document.getElementById(key+'-baseline-val');
  if(!row||!chip||!bval||baseVal==null)return;
  row.style.display='flex';
  const diff=current-baseVal;
  const pct=Math.abs(baseVal)>0.001?Math.round(Math.abs(diff)/Math.abs(baseVal)*100):0;
  if(pct<4){
    chip.className='delta-chip flat';chip.textContent='≈ No change';
  } else if(diff>0){
    chip.className='delta-chip up';chip.innerHTML=`↑ +${Math.abs(diff).toFixed(3)} (${pct}%)`;
  } else {
    chip.className='delta-chip down';chip.innerHTML=`↓ −${Math.abs(diff).toFixed(3)} (${pct}%)`;
  }
  bval.textContent=`baseline: ${baseVal}`;
}

function setBadge(id,score){
  const el=document.getElementById(id);
  if(score>=0.6){el.className='mc-badge alert';el.textContent='ELEVATED';}
  else if(score>=0.3){el.className='mc-badge warn';el.textContent='MILD';}
  else{el.className='mc-badge ok';el.textContent='NORMAL';}
}


/* ── BASELINE CONFIDENCE METER ── */
function computeBaselineConfidence(pendingEntry){
  // pendingEntry: optional {fRaw,aRaw,sRaw,quality} for the current unsaved check-in
  const allHist=pendingEntry?[pendingEntry,...hist]:hist;
  const count=allHist.length;
  // Reaches 1.0 at 8 check-ins
  const countScore=Math.min(count/8,1);

  // Quality factor: average quality of all recordings stored
  let qualityScores=[];
  try{const q=JSON.parse(localStorage.getItem('sc_quality_scores')||'[]');qualityScores=q;}catch(e){}
  if(pendingEntry&&pendingEntry.quality!=null)qualityScores=[pendingEntry.quality,...qualityScores];
  const qualityFactor=qualityScores.length>0?(qualityScores.reduce((a,b)=>a+b,0)/qualityScores.length):0.5;

  // Multi-metric stability: use face, arms, speech signals
  let stabilityScore=0.5;
  if(allHist.length>=3){
    function metricStability(vals){
      const mean=vals.reduce((a,b)=>a+b,0)/vals.length;
      const variance=vals.reduce((a,b)=>a+(b-mean)**2,0)/vals.length;
      const std=Math.sqrt(variance);
      return Math.max(0,Math.min(1,1/(1+std*10)));
    }
    const faceVals=allHist.map(h=>parseFloat(h.fRaw!=null?h.fRaw:h.f)||0);
    const armsVals=allHist.map(h=>parseFloat(h.aRaw!=null?h.aRaw:h.a)||0);
    const speechVals=allHist.map(h=>parseFloat(h.sRaw!=null?h.sRaw:h.s)||0);
    stabilityScore=(metricStability(faceVals)+metricStability(armsVals)+metricStability(speechVals))/3;
  }

  const confidence=0.40*countScore+0.30*qualityFactor+0.30*stabilityScore;
  return{score:confidence,countScore,qualityFactor,stabilityScore};
}

function getConfidenceDrivers(pendingEntry){
  const{score,countScore,qualityFactor,stabilityScore}=computeBaselineConfidence(pendingEntry);
  const n=pendingEntry?hist.length+1:hist.length;
  const targetCounts=[3,5,8];
  const nextTarget=targetCounts.find(t=>t>n)||null;
  const nextStep=nextTarget
    ?`Complete ${nextTarget-n} more check-in${nextTarget-n===1?'':'s'} to reach ${nextTarget===3?'Developing':nextTarget===5?'Taking Shape':'Established'}.`
    :'Your baseline is in great shape. Keep it up.';
  return{score,countScore,qualityFactor,stabilityScore,checkIns:n,nextStep};
}

function bcLevel(conf){
  const n=hist.length;
  if(conf<0.30)return{level:'low',     label:'Calibrating',  msg:"Complete more check-ins to establish your personal baseline."};
  if(conf<0.55){
    // After 5+ check-ins, upgrade from generic "Developing" to something more encouraging
    const label=n>=5?'Taking Shape':'Developing';
    const msg=n>=5
      ?"You've completed 5+ check-ins. Your baseline pattern is solidifying — keep checking in to reach Established."
      :"Your baseline is taking shape. A few more check-ins will sharpen it.";
    return{level:'medium',label,msg};
  }
  if(conf<0.78)return{level:'high',    label:'Established',  msg:"Your baseline is reliable. Trends are meaningful."};
  return             {level:'verified',label:'Trusted',       msg:"Deep pattern data. Results are highly personalised and accurate."};
}

function updateConfidenceUI(pendingEntry){
  const{score:conf,countScore,qualityFactor,stabilityScore,checkIns,nextStep}=getConfidenceDrivers(pendingEntry);
  const {level,label,msg}=bcLevel(conf);

  // Ring fill = check-ins completed / 8 (pure count, not composite)
  const ringPct=Math.min(checkIns/8,1);

  // Helper to update a pill + ring + tip dot
  function applyPill(pillId,textId,ringId){
    const pill=document.getElementById(pillId);
    const txt=document.getElementById(textId);
    if(pill&&txt){
      pill.className='bc-pill '+level;
      txt.textContent=label;
    }
    // Update confidence ring (r=7, circumference=43.98) — driven by check-in count
    const circ=2*Math.PI*7;
    const ring=document.getElementById(ringId);
    if(ring){
      ring.style.strokeDasharray=circ+' '+circ;
      ring.style.strokeDashoffset=circ*(1-ringPct);
    }
    // Tip dot: travels along arc, hidden when empty or when ring is complete (closed circle)
    const tipId=ringId.replace('-ring','-tip');
    const tip=document.getElementById(tipId);
    if(tip){
      if(ringPct<0.02||ringPct>=0.999){
        tip.setAttribute('opacity','0');
      } else {
        const angle=(ringPct*360-90)*(Math.PI/180);
        const cx=10+7*Math.cos(angle);
        const cy=10+7*Math.sin(angle);
        tip.setAttribute('cx',cx.toFixed(3));
        tip.setAttribute('cy',cy.toFixed(3));
        tip.setAttribute('opacity','1');
      }
    }
  }

  applyPill('nav-bc-pill','nav-bc-text','nav-conf-ring');
  applyPill('results-bc-pill','results-bc-text','results-conf-ring');
  applyPill('hist-bc-pill','hist-bc-text','hist-conf-ring');

  // Update breakdown panels
  document.querySelectorAll('.bc-breakdown').forEach(panel=>{
    panel.querySelector('.bcd-checkins').textContent=`${checkIns} / 8`;
    panel.querySelector('.bcd-quality').textContent=Math.round(qualityFactor*100)+'%';
    const stabEl=panel.querySelector('.bcd-stability'); if(stabEl) stabEl.textContent=Math.round(stabilityScore*100)+'%';
    panel.querySelector('.bcd-nextstep').textContent=nextStep;
    const barFill=panel.querySelector('.bcd-bar-fill');
    const pct=Math.round(ringPct*100);
    barFill.style.width=Math.min(pct,100)+'%';
    if(pct>=100){
      barFill.style.background='var(--teal)';
      barFill.style.boxShadow='0 0 8px rgba(0,229,200,0.6)';
    } else {
      barFill.style.background='linear-gradient(90deg,var(--teal),var(--blue))';
      barFill.style.boxShadow='none';
    }
  });

  const confMsg=document.getElementById('conf-banner-msg');
  if(confMsg)confMsg.textContent=msg;

  return{conf,level};
}

function storeQualityScore(score){
  let q=[];try{q=JSON.parse(localStorage.getItem('sc_quality_scores')||'[]');}catch(e){}
  q.unshift(score);if(q.length>20)q.pop();
  try{localStorage.setItem('sc_quality_scores',JSON.stringify(q));}catch(e){}
}

/* ══════════════════════════════════════════════════════
   FEATURE 4: MONITORING STREAK
   Computes consecutive-day streak from history timestamps.
   We store a dateStr per entry; compare day-by-day.
═══════════════════════════════════════════════════════ */
function computeStreak(){
  if(!hist.length)return{streak:0,lastSeen:null,cadence:'No data',dots:[]};

  // Parse dates from history (hist[0] = newest)
  const dates=hist.map(h=>{
    try{return new Date(h.date);}catch(e){return null;}
  }).filter(Boolean);

  if(!dates.length)return{streak:0,lastSeen:null,cadence:'No data',dots:[]};

  const today=new Date();today.setHours(0,0,0,0);
  const msPerDay=86400000;

  // Build set of unique day offsets from today (0=today, 1=yesterday, ...)
  const daySet=new Set();
  const statusByDay={};
  hist.forEach(h=>{
    try{
      const d=new Date(h.date);d.setHours(0,0,0,0);
      const offset=Math.round((today-d)/msPerDay);
      if(offset>=0){
        daySet.add(offset);
        // Keep the most serious status for each day
        const cur=statusByDay[offset];
        const rank={red:3,yellow:2,green:1};
        if(!cur||rank[h.status]>rank[cur])statusByDay[offset]=h.status;
      }
    }catch(e){}
  });

  // Count consecutive days ending at today or yesterday
  let streak=0;
  let start=daySet.has(0)?0:daySet.has(1)?1:null;
  if(start!==null){
    for(let i=start;;i++){
      if(daySet.has(i))streak++;
      else break;
    }
  }

  // Last seen
  const lastSeen=dates[0];
  const daysSince=Math.round((today-new Date(lastSeen).setHours(0,0,0,0)===0?0:(today-lastSeen)/msPerDay));

  // Cadence
  let cadence='No data';
  if(hist.length>=2){
    // Average gap between entries
    const gaps=[];
    for(let i=0;i<Math.min(hist.length-1,6);i++){
      const a=new Date(hist[i].date);const b=new Date(hist[i+1].date);
      const gap=Math.abs(a-b)/msPerDay;if(gap>0)gaps.push(gap);
    }
    if(gaps.length){
      const avg=gaps.reduce((a,b)=>a+b,0)/gaps.length;
      if(avg<=1.5)cadence='Daily';
      else if(avg<=4)cadence='Every few days';
      else if(avg<=8)cadence='Weekly';
      else cadence='Infrequent';
    }
  }

  // Last 7 dot statuses
  const dots=[];
  for(let i=6;i>=0;i--){
    if(daySet.has(i))dots.push(statusByDay[i]||'green');
    else dots.push('missed');
  }

  return{streak,lastSeen,cadence,dots,daysSince:daySet.has(0)?0:daySet.has(1)?1:lastSeen?Math.round((Date.now()-lastSeen)/(864e5)):null};
}

function renderStreak(){
  const{streak,cadence,dots,daysSince}=computeStreak();
  const numEl=document.getElementById('streak-num');
  const subEl=document.getElementById('streak-sub');
  const dotsEl=document.getElementById('streak-dots');
  const cad=document.getElementById('streak-cadence');
  const flame=document.getElementById('streak-flame');

  if(numEl)numEl.textContent=streak;
  if(flame){
    if(streak>=7)flame.textContent='🔥';
    else if(streak>=3)flame.textContent='✦';
    else flame.textContent='○';
  }

  if(subEl){
    if(!hist.length){subEl.textContent='Start your first check-in to begin tracking.';}
    else if(streak===0&&daysSince>1){subEl.textContent=`Last check-in was ${daysSince} day${daysSince===1?'':'s'} ago. Check in today to restart your streak.`;}
    else if(streak===0&&daysSince===null){subEl.textContent='No recent check-ins found. Check in today to start your streak.';}
    else if(streak===1){subEl.textContent='Checked in today. Come back tomorrow to build your streak.';}
    else if(streak>=7){subEl.textContent=`${streak} consecutive days — your baseline confidence is building fast.`;}
    else{subEl.textContent=`${streak} consecutive days of monitoring. Consistent check-ins make results more meaningful.`;}
  }

  if(dotsEl){
    dotsEl.innerHTML=dots.map(d=>`<div class="streak-dot ${d}" title="${d==='missed'?'No check-in':d}"></div>`).join('');
  }

  if(cad){
    cad.textContent=cadence;
    cad.className='streak-cadence'+(cadence==='Daily'?' on-track':'');
  }
}

/* ══════════════════════════════════════════════════════
   FEATURE 6: SIGNAL FINGERPRINT RADAR
   3-axis radar chart: Face / Arms / Speech
   Each axis normalised 0→1 where 1 = alert threshold.
   Baseline polygon drawn dashed; current solid teal.
═══════════════════════════════════════════════════════ */
function radarPoint(cx,cy,r,angleDeg){
  const rad=(angleDeg-90)*Math.PI/180;
  return[cx+r*Math.cos(rad),cy+r*Math.sin(rad)];
}

function drawFingerprint(fa,ad,pr,fs,as,ss){
  const card=document.getElementById('fingerprint-card');
  if(!card||isBaselineMode){if(card)card.style.display='none';return;}
  card.style.display='block';

  const cx=90,cy=90,maxR=72;
  // Angles: Face=270° (top), Arms=30° (bottom-left), Speech=150° (bottom-right)
  const angles=[270,30,150];

  // Normalise raw values to 0–1 relative to thresholds, clamped 0–1.3 for overages
  const faceN=Math.min(fa !== null ? fa/0.08 : 0, 1.3);
  const armsN=Math.min(ad !== null ? ad/30 : 0, 1.3);   // updated: 0-100 scale, threshold=30
  const speechN=Math.min(pr !== null ? pr/0.35 : 0, 1.3);
  const current=[faceN,armsN,speechN];

  // Baseline normalised (if exists)
  let baseCurrent=[0.5,0.5,0.5]; // default neutral shape
  if(baseline){
    baseCurrent=[
      Math.min(parseFloat(baseline.fa || 0)/0.08,1.3),
      Math.min(parseFloat(baseline.ad || 0)/30,1.3),  // updated threshold
      Math.min(parseFloat(baseline.pr || 0)/0.35,1.3)
    ];
  }

  function polyPoints(vals){
    return vals.map((v,i)=>{
      const r=Math.max(8,v*maxR);
      const[px,py]=radarPoint(cx,cy,r,angles[i]);
      return`${px.toFixed(2)},${py.toFixed(2)}`;
    }).join(' ');
  }

  const currentPoly=document.getElementById('fp-current-poly');
  const baselinePoly=document.getElementById('fp-baseline-poly');
  const dotFace=document.getElementById('fp-dot-face');
  const dotArms=document.getElementById('fp-dot-arms');
  const dotSpeech=document.getElementById('fp-dot-speech');

  if(currentPoly)currentPoly.setAttribute('points',polyPoints(current));
  if(baselinePoly)baselinePoly.setAttribute('points',polyPoints(baseCurrent));

  // Position vertex dots
  const [fx,fy]=radarPoint(cx,cy,Math.max(8,faceN*maxR),angles[0]);
  const [ax,ay]=radarPoint(cx,cy,Math.max(8,armsN*maxR),angles[1]);
  const [sx,sy]=radarPoint(cx,cy,Math.max(8,speechN*maxR),angles[2]);
  if(dotFace){dotFace.setAttribute('cx',fx.toFixed(2));dotFace.setAttribute('cy',fy.toFixed(2));}
  if(dotArms){dotArms.setAttribute('cx',ax.toFixed(2));dotArms.setAttribute('cy',ay.toFixed(2));}
  if(dotSpeech){dotSpeech.setAttribute('cx',sx.toFixed(2));dotSpeech.setAttribute('cy',sy.toFixed(2));}

  // Color current polygon by worst signal
  const worst=Math.max(faceN,armsN,speechN);
  let polyColor='rgba(0,229,200,0.75)';
  let polyFill='rgba(0,229,200,0.07)';
  if(worst>=1.0){polyColor='rgba(239,68,68,0.8)';polyFill='rgba(239,68,68,0.08)';}
  else if(worst>=0.6){polyColor='rgba(245,158,11,0.8)';polyFill='rgba(245,158,11,0.07)';}
  if(currentPoly){currentPoly.setAttribute('stroke',polyColor);currentPoly.setAttribute('fill',polyFill);}

  // Legend values
  const fv=document.getElementById('fp-face-val');
  const av=document.getElementById('fp-arms-val');
  const sv=document.getElementById('fp-speech-val');
  if(fv)fv.textContent=fa.toFixed(3)+' / 0.08';
  if(av)av.textContent=ad.toFixed(1)+'% / 8%';
  if(sv)sv.textContent=pr.toFixed(2)+' / 0.35';

  // Note
  const note=document.getElementById('fp-note');
  if(note){
    if(!baseline){note.textContent='Record a baseline to see how today compares to your personal normal.';}
    else{
      const changes=[];
      if(faceN>baseCurrent[0]*1.15)changes.push('face symmetry');
      if(armsN>baseCurrent[1]*1.15)changes.push('arm drift');
      if(speechN>baseCurrent[2]*1.15)changes.push('speech pause');
      note.textContent=changes.length
        ?`Today's shape is larger than your baseline on: ${changes.join(', ')}. The dashed outline shows your personal normal.`
        :'Your signal shape today closely matches your baseline. No notable deviation across any axis.';
    }
  }
}

/* ── HISTORY ── */
let hist=[];try{hist=JSON.parse(localStorage.getItem('sc_hist')||'[]');}catch(e){}

function saveAndHistory(){
  stopPreviewLoop();
  if(_res&&!_res.isBaseline){
    const entry={
      date:_res.date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),
      time:_res.date.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),
      status:_res.status,
      f:_res.fs.toFixed(2),a:_res.as.toFixed(2),s:_res.ss.toFixed(2),t:_res.total.toFixed(1),
      fRaw:_res.fa,aRaw:_res.ad,sRaw:_res.pr
    };
    // Shift all existing blob keys up by 1 (oldest stays, new recording becomes index 0)
    if(_recordedChunks.length>0){
      const blob=new Blob(_recordedChunks,{type:'video/webm'});
      const url=URL.createObjectURL(blob);
      const numericKeys=[..._recordingBlobs.keys()].filter(k=>typeof k==='number').sort((a,b)=>b-a);
      for(const k of numericKeys){
        _recordingBlobs.set(k+1,_recordingBlobs.get(k));
      }
      _recordingBlobs.set(0,url);
      // Mirror key-shift in IDB asynchronously
      (async()=>{
        const{keys,blobs}=await _idbGetAll();
        const numIDB=keys.filter(k=>k!=='baseline').map(Number).filter(n=>!isNaN(n)).sort((a,b)=>b-a);
        for(const k of numIDB){const b=blobs[keys.indexOf(String(k))];if(b)await idbPut(k+1,b);}
        await idbPut(0,blob);
      })();
    }
    hist.unshift(entry);
    if(hist.length>100){
      if(_recordingBlobs.has(100))URL.revokeObjectURL(_recordingBlobs.get(100));
      _recordingBlobs.delete(100);
      idbDel(100);
      hist.pop();
    }
    try{localStorage.setItem('sc_hist',JSON.stringify(hist.map(h=>{const c={...h};return c;})));}catch(e){}
  }
  updateConfidenceUI();
  renderHistory();showScreen('history');
}

function renderHistory(){
  renderStreak();
  const el=document.getElementById('hist-entries');
  const period=document.getElementById('hist-period');
  const empty=document.getElementById('hist-empty');
  const btnClear=document.getElementById('btn-clear-baseline');
  const metricCharts=document.getElementById('hist-metric-charts');
  if(btnClear)btnClear.style.display=baseline?'inline-flex':'none';

  if(!hist.length&&!baseline){
    el.innerHTML='<div class="hist-empty"><h3>No check-ins yet</h3><p>Record your baseline first, then complete your first FAST check-in to start tracking.</p></div>';
    period.textContent='No data yet';
    empty.style.display='block';
    document.getElementById('hist-fill').setAttribute('d','');
    document.getElementById('hist-line').setAttribute('d','');
    if(metricCharts)metricCharts.style.display='none';
    return;
  }
  empty.style.display='none';

  // Baseline pinned at top
  let baselineHtml='';
  if(baseline){
    const hasBaselineVideo=_recordingBlobs.has('baseline');
    baselineHtml=`<div class="he baseline-entry" onclick="openReplayModal('baseline')" title="${hasBaselineVideo?'Click to watch baseline recording':'No video available for this baseline'}">
      <div class="he-date">${baseline.date}</div>
      <div class="he-dot" style="background:var(--teal);box-shadow:0 0 8px rgba(0,229,200,0.5);"></div>
      <div class="he-scores">
        <div class="he-sc"><div class="he-sc-lbl">Face</div><div class="he-sc-v" style="color:var(--teal)">${baseline.fa}</div></div>
        <div class="he-sc"><div class="he-sc-lbl">Arms</div><div class="he-sc-v" style="color:var(--teal)">${baseline.ad}%</div></div>
        <div class="he-sc"><div class="he-sc-lbl">Pause</div><div class="he-sc-v" style="color:var(--teal)">${baseline.pr}</div></div>
        <div class="he-sc"><div class="he-sc-lbl">WPM</div><div class="he-sc-v" style="color:var(--teal)">${baseline.wpm}</div></div>
      </div>
      <div class="he-baseline-tag">BASELINE</div>
      ${hasBaselineVideo?'<div style="font-size:0.75rem;margin-left:0.25rem;">▶</div>':'<div style="font-size:0.75rem;margin-left:0.25rem;opacity:0.3;">🎬</div>'}
    </div>`;
  }

  if(!hist.length){
    el.innerHTML=baselineHtml+'<div class="hist-empty" style="padding:2rem;"><h3>No check-ins yet</h3><p>Run your first FAST check to start tracking changes from your baseline.</p></div>';
    period.textContent='Baseline recorded — no checks yet';
    if(metricCharts)metricCharts.style.display='none';
    return;
  }

  if(metricCharts)metricCharts.style.display='grid';
  period.textContent=hist[hist.length-1].date+' – '+hist[0].date;
  el.innerHTML=baselineHtml+hist.map((h,i)=>{
    const hasVideo=_recordingBlobs.has(i);
    return `<div class="he" onclick="openReplayModal(${i})" title="${hasVideo?'Click to watch recording':'No video available for this recording'}" style="animation:heSlideIn 0.4s cubic-bezier(0.4,0,0.2,1) both;animation-delay:${0.05+i*0.05}s">
      <div class="he-date">${h.date}${h.time?" · "+h.time:""}</div>
      <div class="he-dot ${h.status}"></div>
      <div class="he-scores">
        <div class="he-sc"><div class="he-sc-lbl">Face</div><div class="he-sc-v">${h.fRaw!=null?h.fRaw:h.f}</div></div>
        <div class="he-sc"><div class="he-sc-lbl">Arms</div><div class="he-sc-v">${h.aRaw!=null?h.aRaw+'%':h.a}</div></div>
        <div class="he-sc"><div class="he-sc-lbl">Speech</div><div class="he-sc-v">${h.sRaw!=null?h.sRaw:h.s}</div></div>
        <div class="he-sc"><div class="he-sc-lbl">Total</div><div class="he-sc-v">${h.t}</div></div>
      </div>
      <div class="he-lbl ${h.status}">${{green:'Good',yellow:'Watch',red:'Alert'}[h.status]||h.status.toUpperCase()}</div>
      ${hasVideo?'<div style="font-size:0.75rem;margin-left:0.25rem;">▶</div>':'<div style="font-size:0.75rem;margin-left:0.25rem;opacity:0.3;">🎬</div>'}
    </div>`;
  }).join('');
  drawHistChart();
  drawMetricCharts();
}

/* ── DEMO DATA POPULATION ── */
function populateDemoHistory(){
  if(!confirm('Replace current history with demo data?')) return;

  hist = [];
  try { localStorage.removeItem('sc_hist'); } catch(e) {}
  try { localStorage.removeItem('sc_drift_scores'); } catch(e) {}
  try { localStorage.removeItem('sc_drift_profile'); } catch(e) {}

  // Baseline — recorded Dec 29 on a healthy day
  // ad is a DRIFT score 0-100: 0 = perfectly still, 100 = severe drift
  // fa = facial asymmetry index: ~0.03-0.06 is normal
  // pr = speech pause ratio: < 0.15 is normal
  const demoBaseline = { date:'Dec 29, 2025', fa:0.044, ad:3.2, pr:0.11, wpm:142, faMad:0.008 };
  baseline = demoBaseline;
  try { localStorage.setItem('sc_baseline', JSON.stringify(demoBaseline)); } catch(e) {}

  // Mirror app scoring formulas exactly
  function calcFs(fa) {
    const z = Math.abs(fa - demoBaseline.fa) / demoBaseline.faMad;
    return Math.min(1, z / 3.0);
  }
  function calcAs(ad) {
    // ad is drift 0-100: higher = more risk
    return ad > 30 ? Math.min(1, 0.65 + (ad - 30) * 0.012) : ad > 15 ? 0.35 : 0;
  }
  function calcSs(pr) { return pr > 0.35 ? 1.0 : pr > 0.25 ? 0.5 : 0.0; }
  function getStatus(t) { return t >= 2 ? 'red' : t >= 1.3 ? 'yellow' : 'green'; }

  // Seeded RNG
  let _s = 20260101;
  function rng() { _s = (_s * 1664525 + 1013904223) & 0x7fffffff; return _s / 0x7fffffff; }
  function rf(lo, hi) { return lo + rng() * (hi - lo); }
  function ri(lo, hi) { return Math.floor(rf(lo, hi + 0.999)); }

  // 5 spikes — exact dates, everything else is healthy green
  // Spike 1: Jan 9        single mild yellow
  // Spike 2: Jan 17-18    yellow + red
  // Spike 3: Jan 26       single mild yellow
  // Spike 4: Feb 5-7      mild, red, mild
  // Spike 5: Feb 18-19    red, mild
  const spikeSeverity = {
    '2026-01-09': 'mild',
    '2026-01-17': 'mild', '2026-01-18': 'strong',
    '2026-01-26': 'mild',
    '2026-02-05': 'mild', '2026-02-06': 'strong', '2026-02-07': 'mild',
    '2026-02-18': 'strong', '2026-02-19': 'mild'
  };

  const times = ['7:42 AM','8:03 AM','8:19 AM','8:47 AM','9:12 AM','9:31 AM',
                 '9:58 AM','10:14 AM','10:38 AM','6:24 PM','7:08 PM'];

  const startDate = new Date('2026-01-01T00:00:00');
  const today = new Date(); today.setHours(23,59,59,0);

  const entries = [];
  const cur = new Date(startDate);
  let idx = 0;

  while (cur <= today) {
    const isoKey = cur.toISOString().slice(0,10);
    const sev = spikeSeverity[isoKey] || null;
    let fa, ad, pr;

    if (sev === 'strong') {
      // Clear spike — unmistakably elevated, will score red
      fa = +rf(0.096, 0.130).toFixed(3);  // z ~6-10 → fs ~0.9-1.0
      ad = ri(38, 55);                      // high drift → as ~0.74-0.9
      pr = +rf(0.27, 0.36).toFixed(3);     // elevated pauses → ss 0.5-1.0
    } else if (sev === 'mild') {
      // Yellow-range: face and arms mildly elevated, speech clean
      fa = +rf(0.068, 0.088).toFixed(3);  // z ~3-5.5 → fs ~0.5-0.75
      ad = ri(18, 28);                      // mild drift → as 0.35
      pr = +rf(0.13, 0.21).toFixed(3);     // normal pauses → ss 0
    } else {
      // Healthy green day — minimal drift, symmetric face, clean speech
      fa = +Math.max(0.022, demoBaseline.fa + rf(-0.007, 0.009) + (rng()-0.5)*0.003).toFixed(3);
      ad = ri(0, 9);                        // near-zero drift → as = 0
      pr = +Math.max(0.05, demoBaseline.pr + rf(-0.025, 0.025)).toFixed(3);
    }

    const fs  = +calcFs(fa).toFixed(2);
    const as_ = +calcAs(ad).toFixed(2);
    const ss  = +calcSs(pr).toFixed(2);
    const tot = +(fs + as_ + ss).toFixed(1);

    entries.push({
      date:   cur.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),
      time:   times[idx % times.length],
      status: getStatus(tot),
      f: fs.toFixed(2), a: as_.toFixed(2), s: ss.toFixed(2), t: tot.toFixed(1),
      fRaw: fa, aRaw: ad, sRaw: pr
    });

    cur.setDate(cur.getDate() + 1);
    idx++;
  }

  hist = entries.reverse();
  try { localStorage.setItem('sc_hist', JSON.stringify(hist)); } catch(e) {}

  updateHomeScreen();
  renderHistory();
  showScreen('history');
}
function smoothCurve(pts){
  if(pts.length<2)return pts.length===1?`M${pts[0].join(',')}`:'';
  if(pts.length===2)return `M${pts[0].join(',')} L${pts[1].join(',')}`;
  let d=`M${pts[0].join(',')}`;
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[i===0?i:i-1],p1=pts[i],p2=pts[i+1],p3=pts[i+2<pts.length?i+2:i+1];
    const cp1x=p1[0]+(p2[0]-p0[0])/6;
    const cp1y=p1[1]+(p2[1]-p0[1])/6;
    const cp2x=p2[0]-(p3[0]-p1[0])/6;
    const cp2y=p2[1]-(p3[1]-p1[1])/6;
    d+=` C${cp1x},${cp1y} ${cp2x},${cp2y} ${p2[0]},${p2[1]}`;
  }
  return d;
}

function pathLength(d){
  // Approximate: use a temp SVG path to measure
  try{const p=document.createElementNS('http://www.w3.org/2000/svg','path');p.setAttribute('d',d);return Math.round(p.getTotalLength())||800;}catch(e){return 800;}
}

function animatePath(el,d){
  el.setAttribute('d',d);
  const len=pathLength(d);
  el.style.strokeDasharray=len;
  el.style.strokeDashoffset=len;
  el.style.animation='none';
  void el.getBoundingClientRect();
  el.style.animation=`chartDraw 1.2s cubic-bezier(0.4,0,0.2,1) forwards`;
}

function renderDots(groupId,pts,color,delayBase,colors){
  const g=document.getElementById(groupId);if(!g)return;
  g.innerHTML='';
  pts.forEach((p,i)=>{
    const isLast=i===pts.length-1;
    const col=colors?colors[i]:color;
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',p[0]);c.setAttribute('cy',p[1]);
    c.setAttribute('r',isLast?5:3.5);
    c.setAttribute('fill',col);
    if(isLast){c.setAttribute('filter',`drop-shadow(0 0 5px ${col})`);c.setAttribute('stroke','rgba(255,255,255,0.3)');c.setAttribute('stroke-width','1');}
    c.style.opacity='0';
    c.style.animation=`chartFadeIn 0.3s ease forwards`;
    c.style.animationDelay=`${delayBase+i*0.06}s`;
    g.appendChild(c);
  });
}

function drawHistChart(){
  const rev=[...hist].reverse();if(rev.length<2)return;
  const W=820,H=180,P=20,vals=rev.map(r=>parseFloat(r.t)),mx=Math.max(...vals,2.5);
  const pts=rev.map((r,i)=>{const x=P+(i/(rev.length-1))*(W-P*2);const y=H-P-(parseFloat(r.t)/mx)*(H-P*2);return[x,y];});
  const lineD=smoothCurve(pts);
  const fillD=lineD+` L${pts[pts.length-1][0]},${H-P} L${pts[0][0]},${H-P} Z`;
  const lineEl=document.getElementById('hist-line');
  const fillEl=document.getElementById('hist-fill');
  fillEl.setAttribute('d',fillD);
  fillEl.style.opacity='0';fillEl.style.animation='none';void fillEl.getBoundingClientRect();fillEl.style.animation='chartFadeIn 0.6s ease forwards 0.8s';
  animatePath(lineEl,lineD);
  const dotColors=rev.map(r=>r.status==='red'?'#ef4444':r.status==='yellow'?'#f59e0b':parseFloat(r.t)>=0.4?'#f97316':'#22c55e');
  // Render dots with date tooltips
  renderHistDots('hist-dots',pts,'#00e5c8',0.9,dotColors,rev);
  // Baseline reference line pinned at risk score 1.2
  const blEl=document.getElementById('hist-baseline-line');
  const blLbl=document.getElementById('hist-baseline-lbl');
  if(blEl&&blLbl){
    const blScore=1.2;
    const blY=H-P-(blScore/mx)*(H-P*2);
    blEl.setAttribute('y1',blY);blEl.setAttribute('y2',blY);
    blLbl.setAttribute('y',blY-4);
    blEl.setAttribute('display','');blLbl.setAttribute('display','');
  }
}

// Dedicated dot renderer for hist chart with hover tooltip
function renderHistDots(groupId,pts,color,delayBase,colors,data){
  const g=document.getElementById(groupId);if(!g)return;
  g.innerHTML='';
  // Ensure SVG tooltip element exists
  const svgEl=document.getElementById('hist-svg');
  let tip=document.getElementById('hist-dot-tooltip');
  if(!tip&&svgEl){
    tip=document.createElementNS('http://www.w3.org/2000/svg','g');
    tip.setAttribute('id','hist-dot-tooltip');
    tip.style.pointerEvents='none';
    tip.style.display='none';
    const tipRect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    tipRect.setAttribute('id','hist-tip-rect');
    tipRect.setAttribute('rx','5');tipRect.setAttribute('ry','5');
    tipRect.setAttribute('fill','#0d1220');tipRect.setAttribute('stroke','rgba(255,255,255,0.12)');tipRect.setAttribute('stroke-width','1');
    const tipText=document.createElementNS('http://www.w3.org/2000/svg','text');
    tipText.setAttribute('id','hist-tip-text');
    tipText.setAttribute('font-family',"'Space Mono',monospace");
    tipText.setAttribute('font-size','10');
    tipText.setAttribute('fill','#e8eaf0');
    tip.appendChild(tipRect);tip.appendChild(tipText);
    svgEl.appendChild(tip);
  }
  pts.forEach((p,i)=>{
    const isLast=i===pts.length-1;
    const col=colors?colors[i]:color;
    // Invisible hit area for easier hovering
    const hit=document.createElementNS('http://www.w3.org/2000/svg','circle');
    hit.setAttribute('cx',p[0]);hit.setAttribute('cy',p[1]);hit.setAttribute('r','12');
    hit.setAttribute('fill','transparent');hit.style.cursor='pointer';
    // Visible dot
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',p[0]);c.setAttribute('cy',p[1]);
    c.setAttribute('r',isLast?5:3.5);
    c.setAttribute('fill',col);
    if(isLast){c.setAttribute('filter',`drop-shadow(0 0 5px ${col})`);c.setAttribute('stroke','rgba(255,255,255,0.3)');c.setAttribute('stroke-width','1');}
    c.style.opacity='0';c.style.animation='chartFadeIn 0.3s ease forwards';
    c.style.animationDelay=`${delayBase+i*0.06}s`;
    c.style.transition='r 0.15s';
    // Tooltip data
    const entry=data?data[i]:null;
    const label=entry?(entry.date+(entry.time?' · '+entry.time:'')+(entry.t?' — '+entry.t:'')):null;
    hit.addEventListener('mouseenter',()=>{
      c.setAttribute('r',isLast?7:5.5);
      if(label&&tip){
        const W=820;
        const tipTxt=document.getElementById('hist-tip-text');
        const tipRct=document.getElementById('hist-tip-rect');
        if(tipTxt){tipTxt.textContent=label;}
        const textW=label.length*6.2+16;
        const textH=22;
        let tx=p[0]-textW/2;
        if(tx<4)tx=4;
        if(tx+textW>W-4)tx=W-4-textW;
        const ty=p[1]-textH-10;
        if(tipRct){tipRct.setAttribute('x',tx);tipRct.setAttribute('y',ty);tipRct.setAttribute('width',textW);tipRct.setAttribute('height',textH);}
        if(tipTxt){tipTxt.setAttribute('x',tx+8);tipTxt.setAttribute('y',ty+14.5);}
        tip.style.display='';
      }
    });
    hit.addEventListener('mouseleave',()=>{
      c.setAttribute('r',isLast?5:3.5);
      if(tip)tip.style.display='none';
    });
    g.appendChild(c);
    g.appendChild(hit);
  });
}

function drawMetricCharts(){
  if(hist.length<1)return;
  const rev=[...hist].reverse();

  function drawLine(lineId,fillId,dotsId,vals,color,blLineId,blLblId,blVal){
    const lineEl=document.getElementById(lineId);
    const fillEl=document.getElementById(fillId);
    if(!lineEl||!fillEl)return;
    const W=400,H=100,P=10;
    if(vals.length<2){lineEl.setAttribute('d','');fillEl.setAttribute('d','');return;}
    const maxV=Math.max(...vals,blVal||0.01)*1.15;
    const pts=vals.map((v,i)=>{const x=P+(i/(vals.length-1))*(W-P*2);const y=H-P-(v/maxV)*(H-P*2);return[x,y];});
    const lineD=smoothCurve(pts);
    const fillD=lineD+` L${pts[pts.length-1][0]},${H-P} L${pts[0][0]},${H-P} Z`;
    fillEl.setAttribute('d',fillD);
    fillEl.style.opacity='0';fillEl.style.animation='none';void fillEl.getBoundingClientRect();fillEl.style.animation='chartFadeIn 0.5s ease forwards 0.6s';
    animatePath(lineEl,lineD);
    if(dotsId)renderDots(dotsId,pts,color,0.7);
    // Baseline reference
    if(blLineId&&blLblId&&blVal!=null){
      const bY=H-P-(blVal/maxV)*(H-P*2);
      const blEl=document.getElementById(blLineId);
      const lblEl=document.getElementById(blLblId);
      if(blEl){blEl.setAttribute('y1',bY);blEl.setAttribute('y2',bY);blEl.setAttribute('display','');}
      if(lblEl){lblEl.setAttribute('y',bY-4);lblEl.setAttribute('display','');}
    }
  }

  const faceVals=rev.map(r=>r.fRaw!=null?parseFloat(r.fRaw):parseFloat(r.f));
  const armsVals=rev.map(r=>r.aRaw!=null?parseFloat(r.aRaw):parseFloat(r.a));
  const speechVals=rev.map(r=>r.sRaw!=null?parseFloat(r.sRaw):parseFloat(r.s));

  drawLine('hmc-face-line','hmc-face-fill','hmc-face-dots',faceVals,'#00e5c8','hmc-face-bline','hmc-face-blbl',baseline?parseFloat(baseline.fa):null);
  drawLine('hmc-arms-line','hmc-arms-fill','hmc-arms-dots',armsVals,'#a855f7','hmc-arms-bline','hmc-arms-blbl',baseline?parseFloat(baseline.ad):null);
  drawLine('hmc-speech-line','hmc-speech-fill','hmc-speech-dots',speechVals,'#3b82f6','hmc-speech-bline','hmc-speech-blbl',baseline?parseFloat(baseline.pr):null);
}

/* ── RESULTS PAGE: animate metric lines on nudgeLine ── */
function nudgeLine(id,val,thresh){
  const lineEl=document.getElementById(id);if(!lineEl)return;
  const fillEl=document.getElementById(id.replace('-line','-fill'));
  const dotEl=document.getElementById(id.replace('-line','-dot'));
  const r=Math.min(val/thresh,1.6);
  const pts=[];
  for(let i=0;i<=5;i++){const x=i*40;const y=32-(r*22)+(Math.random()*3-1.5);pts.push([x,Math.max(5,Math.min(55,y))]);}
  const lineD=smoothCurve(pts);
  // Update fill
  if(fillEl){
    const fillD=lineD+` L${pts[pts.length-1][0]},55 L${pts[0][0]},55 Z`;
    fillEl.setAttribute('d',fillD);
    fillEl.style.opacity='0';fillEl.style.animation='none';void fillEl.getBoundingClientRect();fillEl.style.animation='chartFadeIn 0.6s ease forwards 0.8s';
  }
  // Animate line draw
  animatePath(lineEl,lineD);
  // Update dot position
  if(dotEl){
    const last=pts[pts.length-1];
    dotEl.setAttribute('cx',last[0]);dotEl.setAttribute('cy',last[1]);
    dotEl.style.opacity='0';dotEl.style.animation='none';void dotEl.getBoundingClientRect();dotEl.style.animation='chartFadeIn 0.4s ease forwards 1.1s';
  }
}

/* ── VIDEO REPLAY MODAL ── */
let _replayPoseOverlayActive=false;
let _replayFaceOverlayActive=false;
let _replayOverlayMode='off'; // 'off'|'pose'|'face'
let _replayRafId=null;

function openReplayModal(idx){
  // idx is either a number (hist index) or 'baseline'
  const isBaseline = idx === 'baseline';
  const h = isBaseline ? baseline : hist[idx];
  if(!h) return;

  const modal=document.getElementById('video-replay-modal');
  const noVideo=document.getElementById('replay-no-video');
  const videoEl=document.getElementById('replay-video');
  const overlayLabel=document.getElementById('replay-overlay-label');
  const overlayToggleWrap=document.getElementById('replay-overlay-toggle-wrap');
  const playBtn=document.getElementById('replay-play-btn');

  document.getElementById('replay-title').textContent=h.date+(h.time?' · '+h.time:'')+(isBaseline?' Baseline':' Check-In');

  // Scores
  if(isBaseline){
    document.getElementById('replay-face-val').textContent=h.fa != null ? h.fa : 'n/a';
    document.getElementById('replay-arms-val').textContent=h.ad != null ? h.ad + ' / 100' : 'n/a';
    document.getElementById('replay-speech-val').textContent=h.pr != null ? h.pr : 'n/a';
    document.getElementById('replay-total-val').textContent='—';
    document.getElementById('replay-total-val').style.color='var(--teal)';
    ['face','arms','speech'].forEach(key=>{
      const badge=document.getElementById('replay-'+key+'-badge');
      badge.className='replay-badge ok';badge.textContent='BASELINE';
    });
  } else {
    document.getElementById('replay-face-val').textContent=h.fRaw!=null?h.fRaw:h.f;
    document.getElementById('replay-arms-val').textContent=(h.aRaw!=null?h.aRaw+' / 100':h.a!=null?h.a:'n/a');
    document.getElementById('replay-speech-val').textContent=h.sRaw!=null?h.sRaw:h.s;
    document.getElementById('replay-total-val').textContent=h.t;
    document.getElementById('replay-total-val').style.color=h.status==='red'?'var(--red)':h.status==='yellow'?'var(--yellow)':'var(--green)';
    ['face','arms','speech'].forEach(key=>{
      const badge=document.getElementById('replay-'+key+'-badge');
      const scoreF=parseFloat(h[key==='face'?'f':key==='arms'?'a':'s']);
      if(scoreF>=0.6){badge.className='replay-badge alert';badge.textContent='ELEVATED';}
      else if(scoreF>=0.3){badge.className='replay-badge warn';badge.textContent='MILD';}
      else{badge.className='replay-badge ok';badge.textContent='NORMAL';}
    });
  }

  // Video — toggle panel always visible; toggles disabled when no video
  const blobUrl=_recordingBlobs.get(idx);
  const poseCb=document.getElementById('replay-pose-toggle-cb');
  const faceCb=document.getElementById('replay-face-toggle-cb');
  const poseLbl=document.getElementById('replay-pose-toggle-label');
  const faceLbl=document.getElementById('replay-face-toggle-label');
  const overlayNoVid=document.getElementById('replay-overlay-no-video-note');
  if(blobUrl){
    videoEl.src=blobUrl;
    videoEl.loop=false;
    videoEl.pause();
    noVideo.style.display='none';
    videoEl.style.display='block';
    if(playBtn)playBtn.style.display='flex';
    overlayLabel.style.display='block';
    if(poseCb){poseCb.disabled=false;}
    if(faceCb){faceCb.disabled=false;}
    if(poseLbl){poseLbl.style.opacity='1';poseLbl.style.cursor='pointer';}
    if(faceLbl){faceLbl.style.opacity='1';faceLbl.style.cursor='pointer';}
    if(overlayNoVid)overlayNoVid.style.display='none';
    _replayOverlayMode='off';
    _replayPoseOverlayActive=false;
    _replayFaceOverlayActive=false;
    updateOverlayBtnStyles();
    initVideoControls(videoEl);
  } else {
    videoEl.src='';
    videoEl.style.display='none';
    if(playBtn)playBtn.style.display='none';
    noVideo.style.display='flex';
    overlayLabel.style.display='none';
    if(poseCb){poseCb.checked=false;poseCb.disabled=true;}
    if(faceCb){faceCb.checked=false;faceCb.disabled=true;}
    if(poseLbl){poseLbl.style.opacity='0.3';poseLbl.style.cursor='not-allowed';}
    if(faceLbl){faceLbl.style.opacity='0.3';faceLbl.style.cursor='not-allowed';}
    if(overlayNoVid)overlayNoVid.style.display='block';
    stopReplayOverlayLoop();
  }

  modal.style.display='block';
  document.body.style.overflow='hidden';
}

function closeReplayModal(){
  const videoEl=document.getElementById('replay-video');
  videoEl.onplay=null;videoEl.onpause=null;videoEl.onended=null;videoEl.ontimeupdate=null;
  videoEl.pause();videoEl.src='';
  const playBtn=document.getElementById('replay-play-btn');
  if(playBtn)playBtn.style.display='none';
  document.getElementById('vp-controls').style.display='none';
  stopReplayOverlayLoop();
  document.getElementById('video-replay-modal').style.display='none';
  document.body.style.overflow='';
  _replayOverlayMode='off';
  _replayPoseOverlayActive=false;
  _replayFaceOverlayActive=false;
  _vpScrubbing=false;
}

/* ── VIDEO PLAYER CONTROLS ── */
let _vpScrubbing=false;

function fmtTime(s){
  if(!isFinite(s)||s<0)return'0:00';
  const m=Math.floor(s/60);
  const sec=Math.floor(s%60);
  return m+':'+(sec<10?'0':'')+sec;
}

function replayTogglePlay(){
  const v=document.getElementById('replay-video');
  if(!v.src)return;
  if(v.paused||v.ended)v.play();else v.pause();
}

function initVideoControls(videoEl){
  const controls=document.getElementById('vp-controls');
  const fill=document.getElementById('vp-scrub-fill');
  const thumb=document.getElementById('vp-scrub-thumb');
  const timeEl=document.getElementById('vp-time');
  const playIcon=document.getElementById('vp-play-icon');
  const scrubWrap=document.getElementById('vp-scrub-wrap');

  controls.style.display='flex';

  // Pause icon SVG paths
  const PLAY_PATH='<polygon points="6,4 20,12 6,20" fill="currentColor"/>';
  const PAUSE_PATH='<rect x="6" y="4" width="4" height="16" fill="currentColor"/><rect x="14" y="4" width="4" height="16" fill="currentColor"/>';

  function updateBar(){
    if(_vpScrubbing)return;
    const dur=isFinite(videoEl.duration)&&videoEl.duration>0?videoEl.duration:0;
    const cur=videoEl.currentTime||0;
    const pct=dur>0?(cur/dur*100):0;
    fill.style.width=pct+'%';
    thumb.style.left=pct+'%';
    timeEl.textContent=fmtTime(cur)+' / '+fmtTime(dur);
  }

  function updatePlayIcon(){
    playIcon.innerHTML=videoEl.paused?PLAY_PATH:PAUSE_PATH;
  }

  videoEl.ontimeupdate=updateBar;
  videoEl.ondurationchange=updateBar;
  videoEl.onloadedmetadata=()=>{
    // WebM from MediaRecorder lacks a duration header → duration is Infinity.
    // Seeking to a huge value forces the browser to scan to EOF and sets real duration.
    if(!isFinite(videoEl.duration)){
      videoEl.currentTime=1e100;
    } else {
      updateBar();
    }
  };
  videoEl.onseeked=()=>{
    // After the 1e100 seek resolves, currentTime will equal real duration.
    // Reset to beginning and update the bar now that duration is known.
    if(videoEl.currentTime>1000){
      videoEl.currentTime=0;
    }
    updateBar();
  };
  videoEl.onplay=()=>{
    document.getElementById('replay-play-btn').style.display='none';
    updatePlayIcon();
  };
  videoEl.onpause=()=>{
    document.getElementById('replay-play-btn').style.display='flex';
    updatePlayIcon();
  };
  videoEl.onended=()=>{
    document.getElementById('replay-play-btn').style.display='flex';
    updatePlayIcon();
  };

  // Scrubbing — click or drag on the track
  function scrubTo(e){
    const rect=scrubWrap.getBoundingClientRect();
    const x=Math.max(0,Math.min(e.clientX-rect.left,rect.width));
    const pct=x/rect.width;
    const dur=isFinite(videoEl.duration)&&videoEl.duration>0?videoEl.duration:0;
    if(!dur)return;
    videoEl.currentTime=pct*dur;
    fill.style.width=(pct*100)+'%';
    thumb.style.left=(pct*100)+'%';
    timeEl.textContent=fmtTime(pct*dur)+' / '+fmtTime(dur);
  }

  scrubWrap.onmousedown=(e)=>{
    _vpScrubbing=true;
    scrubTo(e);
    const onMove=(ev)=>{if(_vpScrubbing)scrubTo(ev);};
    const onUp=()=>{_vpScrubbing=false;document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);};
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  };

  // Touch support
  scrubWrap.ontouchstart=(e)=>{
    _vpScrubbing=true;
    scrubTo(e.touches[0]);
    const onMove=(ev)=>{if(_vpScrubbing)scrubTo(ev.touches[0]);};
    const onEnd=()=>{_vpScrubbing=false;document.removeEventListener('touchmove',onMove);document.removeEventListener('touchend',onEnd);};
    document.addEventListener('touchmove',onMove,{passive:true});
    document.addEventListener('touchend',onEnd);
  };

  updatePlayIcon();
  updateBar();
}

function updateOverlayBtnStyles(){
  const poseCb=document.getElementById('replay-pose-toggle-cb');
  const faceCb=document.getElementById('replay-face-toggle-cb');
  const poseTrack=document.getElementById('replay-pose-toggle-track');
  const poseThumb=document.getElementById('replay-pose-toggle-thumb');
  const faceTrack=document.getElementById('replay-face-toggle-track');
  const faceThumb=document.getElementById('replay-face-toggle-thumb');
  const label=document.getElementById('replay-overlay-label');

  const poseOn=_replayPoseOverlayActive;
  const faceOn=_replayFaceOverlayActive;

  if(poseCb)poseCb.checked=poseOn;
  if(faceCb)faceCb.checked=faceOn;

  if(poseTrack){
    poseTrack.style.background=poseOn?'rgba(168,85,247,0.35)':'rgba(255,255,255,0.08)';
    poseTrack.style.borderColor=poseOn?'rgba(168,85,247,0.6)':'rgba(255,255,255,0.12)';
  }
  if(poseThumb){
    poseThumb.style.left=poseOn?'19px':'3px';
    poseThumb.style.background=poseOn?'var(--violet)':'var(--muted)';
    if(poseOn)poseThumb.style.boxShadow='0 0 8px rgba(168,85,247,0.6)';
    else poseThumb.style.boxShadow='none';
  }
  if(faceTrack){
    faceTrack.style.background=faceOn?'rgba(0,229,200,0.35)':'rgba(255,255,255,0.08)';
    faceTrack.style.borderColor=faceOn?'rgba(0,229,200,0.6)':'rgba(255,255,255,0.12)';
  }
  if(faceThumb){
    faceThumb.style.left=faceOn?'19px':'3px';
    faceThumb.style.background=faceOn?'var(--teal)':'var(--muted)';
    if(faceOn)faceThumb.style.boxShadow='0 0 8px rgba(0,229,200,0.6)';
    else faceThumb.style.boxShadow='none';
  }

  if(poseOn&&faceOn){label.textContent='🦴😐 Both Overlays';label.style.display='block';}
  else if(poseOn){label.textContent='🦴 Pose Overlay';label.style.display='block';}
  else if(faceOn){label.textContent='😐 Face Overlay';label.style.display='block';}
  else{label.style.display='none';}
}

async function handleOverlayToggle(mode, checked){
  if(mode==='pose'){
    if(checked){
      // Turn on pose
      const btn=document.getElementById('replay-pose-toggle-label');
      await initPose();
      if(!poseReady||!poseLandmarker){
        document.getElementById('replay-pose-toggle-cb').checked=false;
        return;
      }
      _replayPoseOverlayActive=true;
      _replayOverlayMode=_replayFaceOverlayActive?'both':'pose';
      startReplayOverlayLoop();
    } else {
      _replayPoseOverlayActive=false;
      clearReplayCanvases();
      if(_replayFaceOverlayActive){_replayOverlayMode='face';}
      else{_replayOverlayMode='off';stopReplayOverlayLoop();}
    }
  } else if(mode==='face'){
    if(checked){
      await initFace();
      if(!faceReady||!faceLandmarker){
        document.getElementById('replay-face-toggle-cb').checked=false;
        return;
      }
      _replayFaceOverlayActive=true;
      _replayOverlayMode=_replayPoseOverlayActive?'both':'face';
      startReplayOverlayLoop();
    } else {
      _replayFaceOverlayActive=false;
      clearReplayCanvases();
      if(_replayPoseOverlayActive){_replayOverlayMode='pose';}
      else{_replayOverlayMode='off';stopReplayOverlayLoop();}
    }
  }
  updateOverlayBtnStyles();
}

// setReplayOverlay is now handled by handleOverlayToggle above

function clearReplayCanvases(){
  ['replay-pose-canvas','replay-face-canvas'].forEach(id=>{
    const c=document.getElementById(id);if(!c)return;
    const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);
  });
}

function startReplayOverlayLoop(){
  stopReplayOverlayLoop();
  const videoEl=document.getElementById('replay-video');
  const poseCanvas=document.getElementById('replay-pose-canvas');
  const faceCanvas=document.getElementById('replay-face-canvas');

  function sizeCanvas(canvas){
    const rect=canvas.parentElement.getBoundingClientRect();
    const dpr=window.devicePixelRatio||1;
    canvas.width=Math.round(rect.width*dpr);
    canvas.height=Math.round(rect.height*dpr);
    canvas.style.width=rect.width+'px';
    canvas.style.height=rect.height+'px';
  }
  sizeCanvas(poseCanvas);
  sizeCanvas(faceCanvas);

  let lastT=0;
  let lastVideoTime=-1;
  let lastPausedVideoTime=-1;
  async function loop(t){
    _replayRafId=requestAnimationFrame(loop);
    if(_replayOverlayMode==='off')return;
    if(videoEl.readyState<2)return;
    if(videoEl.ended)return;
    const isPaused=videoEl.paused;
    if(!isPaused&&videoEl.currentTime===lastVideoTime)return;
    if(t-lastT<66&&!isPaused)return;
    if(isPaused&&videoEl.currentTime===lastPausedVideoTime)return;
    if(isPaused)lastPausedVideoTime=videoEl.currentTime;

    // Support both overlays simultaneously
    if(_replayPoseOverlayActive&&poseReady&&poseLandmarker&&!poseBusy){
      poseBusy=true;
      try{const res=poseLandmarker.detectForVideo(videoEl,performance.now());drawPoseOverlay(poseCanvas,res.landmarks);}catch(e){}
      finally{poseBusy=false;}
    }
    if(_replayFaceOverlayActive&&faceReady&&faceLandmarker&&!faceBusy){
      faceBusy=true;
      try{const res=faceLandmarker.detectForVideo(videoEl,performance.now());drawFaceOverlay(faceCanvas,res.faceLandmarks);}catch(e){}
      finally{faceBusy=false;}
    }
    lastVideoTime=videoEl.currentTime;
    lastT=t;
  }
  requestAnimationFrame(loop);
}

function stopReplayOverlayLoop(){
  if(_replayRafId){cancelAnimationFrame(_replayRafId);_replayRafId=null;}
}

// Transparent overlay version of pose drawing — for replay canvas only.
// No background fill, no bbox zoom, no internal mirror (canvas CSS handles it).
function drawPoseOverlay(canvas, landmarks){
  const dpr=window.devicePixelRatio||1;
  const W=canvas.width/dpr, H=canvas.height/dpr;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!landmarks||!landmarks.length)return;
  const lms=landmarks[0];
  const px=nx=>nx*W;
  const py=ny=>ny*H;

  POSE_CONNECTIONS.forEach(([a,b])=>{
    const la=lms[a],lb=lms[b];
    if(!la||!lb)return;
    const vis=Math.min(la.visibility||0,lb.visibility||0);
    if(vis<0.25)return;
    ctx.strokeStyle=`rgba(168,85,247,${0.3+vis*0.6})`;
    ctx.lineWidth=2.5;
    ctx.beginPath();ctx.moveTo(px(la.x),py(la.y));ctx.lineTo(px(lb.x),py(lb.y));ctx.stroke();
  });

  const keyColors={11:'#00e5c8',12:'#00e5c8',13:'#a855f7',14:'#a855f7',15:'#3b82f6',16:'#3b82f6'};
  lms.forEach((lm,idx)=>{
    if(!lm||(lm.visibility||0)<0.25)return;
    const r=[11,12,15,16].includes(idx)?6:3.5;
    ctx.fillStyle=keyColors[idx]||'rgba(168,85,247,0.8)';
    ctx.beginPath();ctx.arc(px(lm.x),py(lm.y),r,0,Math.PI*2);ctx.fill();
    if([11,12,15,16].includes(idx)){
      ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=1.5;
      ctx.beginPath();ctx.arc(px(lm.x),py(lm.y),r,0,Math.PI*2);ctx.stroke();
    }
  });

  const lw=lms[15],rw=lms[16];
  if(lw&&rw&&(lw.visibility||0)>0.4&&(rw.visibility||0)>0.4){
    const driftPct=Math.abs(lw.y-rw.y)*100;
    ctx.strokeStyle=driftPct>8?'rgba(245,158,11,0.9)':'rgba(34,197,94,0.7)';
    ctx.lineWidth=1.5;ctx.setLineDash([4,3]);
    ctx.beginPath();ctx.moveTo(px(lw.x),py(lw.y));ctx.lineTo(px(rw.x),py(rw.y));ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle=driftPct>8?'rgba(245,158,11,0.9)':'rgba(34,197,94,0.8)';
    ctx.font=`${Math.round(W*0.022)}px Space Mono`;ctx.textAlign='left';
    ctx.fillText('drift '+driftPct.toFixed(1)+'%',8,H-8);
  }
}

// Face overlay for replay — transparent, no zoom/mirror (canvas CSS handles mirror)
function drawFaceOverlay(canvas, landmarks){
  const dpr=window.devicePixelRatio||1;
  const W=canvas.width/dpr, H=canvas.height/dpr;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!landmarks||!landmarks.length)return;
  const lms=landmarks[0];

  // ── Sanity check: validate vertical ordering of key landmarks ────────────
  // Reject detections where eyes aren't above nose, or nose isn't above mouth.
  // This prevents the overlay from rendering in wrong positions when MediaPipe
  // confuses features (e.g. nose detected as mouth → eyes above forehead).
  const eyeMidY=((lms[33]?.y||0)+(lms[263]?.y||0))/2;
  const noseY=lms[1]?.y||0;
  const mouthMidY=((lms[61]?.y||0)+(lms[291]?.y||0))/2;
  const tolerance=0.01;
  if(eyeMidY > noseY + tolerance || noseY > mouthMidY + tolerance){
    return; // bad detection — skip this frame
  }

  const px=nx=>nx*W;
  const py=ny=>ny*H;

  // Draw face mesh contours
  ctx.strokeStyle='rgba(0,229,200,0.5)';
  ctx.lineWidth=1.5;
  FACE_MESH_CONTOURS.forEach(path=>{
    if(!path.length)return;
    ctx.beginPath();
    path.forEach((idx,i)=>{
      const lm=lms[idx];if(!lm)return;
      i===0?ctx.moveTo(px(lm.x),py(lm.y)):ctx.lineTo(px(lm.x),py(lm.y));
    });
    ctx.stroke();
  });

  // Draw key landmark dots
  const keyPts=[1,33,61,133,159,263,291,362,386,13,14,0,17];
  keyPts.forEach(idx=>{
    const lm=lms[idx];if(!lm)return;
    ctx.fillStyle='rgba(0,229,200,0.85)';
    ctx.beginPath();ctx.arc(px(lm.x),py(lm.y),3,0,Math.PI*2);ctx.fill();
  });

  // Symmetry line (nose bridge)
  const nose=lms[6],chin=lms[152];
  if(nose&&chin){
    ctx.strokeStyle='rgba(0,229,200,0.3)';ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(px(nose.x),py(nose.y));ctx.lineTo(px(chin.x),py(chin.y));ctx.stroke();
    ctx.setLineDash([]);
  }

  // Asymmetry measurement — mouth corners
  const mL=lms[61],mR=lms[291];
  if(mL&&mR){
    const asymm=Math.abs(mL.y-mR.y)*100;
    ctx.fillStyle=asymm>3?'rgba(245,158,11,0.9)':'rgba(34,197,94,0.8)';
    ctx.font=`${Math.round(W*0.022)}px Space Mono`;ctx.textAlign='left';
    ctx.fillText('asymm '+asymm.toFixed(1),8,H-8);
  }
}


function generateSummary(sc,fa,ad,pr,fs,as,ss,total){
  const now=new Date();
  const dateStr=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const timeStr=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  const{score,countScore,qualityFactor,stabilityScore}=getConfidenceDrivers();
  const{label:confLabel,msg:confMsg}=bcLevel(score);

  const statusColor={green:'#22c55e',yellow:'#f59e0b',red:'#ef4444'}[sc]||'#22c55e';
  const statusLabel={green:'All Clear',yellow:'Mild Variation',red:'Warning Signs'}[sc]||'All Clear';

  // Delta strings
  function deltaStr(current,base,unit=''){
    if(base==null)return'N/A';
    const d=current-base;const pct=Math.abs(base)>0.001?Math.round(Math.abs(d)/Math.abs(base)*100):0;
    if(pct<4)return'No meaningful change';
    return(d>0?'↑ Increased ':'↓ Decreased ')+pct+'% from baseline';
  }

  // Recent trend dots
  const recentDots=hist.map(h=>`<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${{green:'#22c55e',yellow:'#f59e0b',red:'#ef4444'}[h.status]||'#6b7280'};margin-right:3px;margin-bottom:3px;"></span>`).join('');

  // Plain-language what changed
  const changes=[];
  if(baseline){
    if(fa !== null && baseline.fa != null){ const fd=fa-parseFloat(baseline.fa); if(Math.abs(fd)/Math.max(parseFloat(baseline.fa),0.001)>0.1)changes.push(`Facial asymmetry ${fd>0?'increased':'decreased'} compared to baseline.`); }
    if(ad !== null && baseline.ad != null){ const ad2=parseFloat(ad)-parseFloat(baseline.ad); if(Math.abs(ad2)/Math.max(parseFloat(baseline.ad),0.001)>0.1)changes.push(`Arm stability index ${ad2>0?'increased':'decreased'} compared to baseline.`); }
    if(pr !== null && baseline.pr != null){ const sd=pr-parseFloat(baseline.pr); if(Math.abs(sd)/Math.max(parseFloat(baseline.pr),0.001)>0.1)changes.push(`Speech pause ratio ${sd>0?'increased':'decreased'} compared to baseline.`); }
  }
  if(!changes.length)changes.push('All signals within normal baseline range.');

  const win=window.open('','_print','width=800,height=900');
  win.document.write(`<!DOCTYPE html><html><head><title>Baseline Check-In Summary</title>
<style>
body{font-family:'Georgia',serif;color:#1a1a2e;background:#fff;max-width:720px;margin:40px auto;padding:0 40px;line-height:1.6;}
h1{font-size:1.8rem;letter-spacing:-0.02em;margin:0 0 4px;}
.sub{color:#666;font-size:0.85rem;font-family:monospace;}
.disclaimer{background:#fff8e7;border:1px solid #f59e0b;border-radius:8px;padding:12px 16px;font-size:0.82rem;color:#92400e;margin:20px 0;font-family:monospace;}
.section{margin:24px 0;}
.section-title{font-size:0.7rem;letter-spacing:0.15em;text-transform:uppercase;color:#999;font-family:monospace;border-bottom:1px solid #eee;padding-bottom:6px;margin-bottom:14px;}
.row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #f0f0f0;font-size:0.95rem;}
.row .lbl{color:#555;}
.row .val{font-weight:600;color:#1a1a2e;}
.status-badge{display:inline-block;padding:4px 14px;border-radius:100px;color:#fff;font-family:monospace;font-size:0.82rem;background:${statusColor};}
.change-item{padding:6px 0;font-size:0.92rem;color:#333;}
.change-item::before{content:'→ ';}
.footer{margin-top:40px;padding-top:16px;border-top:1px solid #eee;font-size:0.75rem;color:#999;font-family:monospace;}
@media print{body{margin:20px;}}
</style></head><body>
<h1>Baseline Check-In Summary</h1>
<div class="sub">${dateStr} &nbsp;·&nbsp; ${timeStr} &nbsp;·&nbsp; Local-only generated &nbsp;·&nbsp; Not a diagnosis</div>
<div class="disclaimer">⚠️ This summary is not a medical diagnosis. It is a personal signal log for informational use only. If you have stroke symptoms, call emergency services immediately.</div>

<div class="section">
  <div class="section-title">Baseline Reference</div>
  ${baseline?`
  <div class="row"><span class="lbl">Recorded</span><span class="val">${baseline.date}</span></div>
  <div class="row"><span class="lbl">Confidence Level</span><span class="val">${confLabel}</span></div>
  <div class="row"><span class="lbl">Face Asymmetry</span><span class="val">${baseline.fa}</span></div>
  <div class="row"><span class="lbl">Arm Drift</span><span class="val">${baseline.ad != null ? baseline.ad : 'n/a'} / 100</span></div>
  <div class="row"><span class="lbl">Speech Pause Ratio</span><span class="val">${baseline.pr}</span></div>
  `:'<div class="row"><span class="lbl">No baseline recorded</span></div>'}
</div>

<div class="section">
  <div class="section-title">This Check-In</div>
  <div class="row"><span class="lbl">Overall Status</span><span class="val"><span class="status-badge">${statusLabel}</span></span></div>
  <div class="row"><span class="lbl">Risk Index</span><span class="val">${total.toFixed(1)}</span></div>
  <div class="row"><span class="lbl">Face Asymmetry Index</span><span class="val">${fa !== null ? fa : 'Not captured'}</span></div>
  <div class="row"><span class="lbl">Arm Stability Index</span><span class="val">${ad !== null ? ad + ' / 100' : 'Not captured'}</span></div>
  <div class="row"><span class="lbl">Speech Pause Ratio</span><span class="val">${pr !== null ? pr : 'Not captured'}</span></div>
</div>

<div class="section">
  <div class="section-title">Delta from Baseline</div>
  <div class="row"><span class="lbl">Face</span><span class="val">${fa !== null ? deltaStr(fa,baseline&&parseFloat(baseline.fa)) : 'Not captured'}</span></div>
  <div class="row"><span class="lbl">Arms</span><span class="val">${ad !== null ? deltaStr(parseFloat(ad),baseline&&parseFloat(baseline.ad)) : 'Not captured'}</span></div>
  <div class="row"><span class="lbl">Speech</span><span class="val">${pr !== null ? deltaStr(pr,baseline&&parseFloat(baseline.pr)) : 'Not captured'}</span></div>
</div>

<div class="section">
  <div class="section-title">Trend Snapshot (all ${hist.length} check-ins)</div>
  <div style="padding:8px 0;">${recentDots||'<span style="color:#999;font-size:0.85rem;">No history yet</span>'}</div>
  <div style="font-size:0.82rem;color:#888;font-family:monospace;margin-top:4px;">${hist.length} check-in${hist.length!==1?'s':''} total &nbsp;·&nbsp; ● Green = All Clear &nbsp; ● Yellow = Watch &nbsp; ● Red = Warning</div>
</div>

<div class="section">
  <div class="section-title">What Changed</div>
  ${changes.map(c=>`<div class="change-item">${c}</div>`).join('')}
</div>

<div class="section">
  <div class="section-title">Action Guidance</div>
  <div class="change-item">If you suspect stroke symptoms (facial drooping, arm weakness, speech difficulty), call emergency services immediately.</div>
  <div class="change-item">Bring this summary to a clinician if you are concerned about any pattern.</div>
  <div class="change-item">This tool does not diagnose. Use it as a personal awareness aid alongside medical care.</div>
</div>

<div class="footer">Generated by Baseline · Processed locally in-browser · No data uploaded or stored externally · ${dateStr}</div>
</body></html>`);
  win.document.close();
  setTimeout(()=>win.print(),400);

}

function generateHistSummary(){
  if(!hist.length){alert('No check-in history to export yet.');return;}
  const h=hist[0];
  generateSummary(h.status,h.fRaw||h.f,h.aRaw||h.a,h.sRaw||h.s,parseFloat(h.f),parseFloat(h.a),parseFloat(h.s),parseFloat(h.t));
}


function clearHist(){
  if(confirm('Clear all check-in history? Your baseline will be kept.')){
    hist=[];try{localStorage.removeItem('sc_hist');}catch(e){}
    // Revoke check-in blobs from memory and IDB (keep baseline)
    _recordingBlobs.forEach((url,key)=>{if(typeof key==='number'){URL.revokeObjectURL(url);idbDel(key);}});
    [..._recordingBlobs.keys()].filter(k=>typeof k==='number').forEach(k=>_recordingBlobs.delete(k));
    renderHistory();
  }
}

function clearBaseline(){
  if(confirm('Reset your baseline? You will need to re-record it before running future FAST checks.')){
    baseline=null;try{localStorage.removeItem('sc_baseline');}catch(e){}
    if(_recordingBlobs.has('baseline')){URL.revokeObjectURL(_recordingBlobs.get('baseline'));_recordingBlobs.delete('baseline');idbDel('baseline');}
    updateHomeScreen();renderHistory();
  }
}



// Init
updateHomeScreen();
renderHistory();
updateConfidenceUI();
loadPersistedVideos(); // restore videos from IndexedDB on page load
</script>

<!-- SECRET SPEECH LAB — navigate to #speech-lab -->
<div id="speech-lab-page" style="display:none;position:fixed;inset:0;z-index:2000;background:var(--bg);overflow-y:auto;">
<style>
#speech-lab-page .sl-wrap{max-width:560px;margin:0 auto;padding:5rem 2rem 4rem;display:flex;flex-direction:column;align-items:center;gap:2rem;}
#speech-lab-page .sl-eyebrow{font-family:'Space Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:var(--violet);text-transform:uppercase;}
#speech-lab-page .sl-title{font-family:'DM Serif Display',serif;font-size:2.6rem;letter-spacing:-0.02em;text-align:center;line-height:1.15;}
#speech-lab-page .sl-title em{font-style:italic;color:var(--teal);}
#speech-lab-page .sl-passage-box{width:100%;background:var(--surface);border:1px solid var(--cbord);border-radius:18px;padding:2rem 2.25rem;position:relative;overflow:hidden;}
#speech-lab-page .sl-passage-box::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--teal),transparent);}
#speech-lab-page .sl-passage-label{font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:0.85rem;}
#speech-lab-page .sl-passage-text{font-size:1.1rem;line-height:1.9;color:var(--text);}
#speech-lab-page .sl-word{transition:color 0.15s;}
#speech-lab-page .sl-word.spoken{color:var(--teal);font-weight:500;}
#speech-lab-page .sl-word.current{color:#fff;font-weight:500;}
#speech-lab-page .sl-metrics{width:100%;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;}
#speech-lab-page .sl-metric{background:var(--cb);border:1px solid var(--cbord);border-radius:14px;padding:1.25rem 1rem;text-align:center;}
#speech-lab-page .sl-metric-val{font-family:'DM Serif Display',serif;font-size:2rem;letter-spacing:-0.02em;line-height:1;}
#speech-lab-page .sl-metric-lbl{font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-top:0.35rem;}
#speech-lab-page .sl-timer-track{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:4;}
#speech-lab-page .sl-timer-fill{fill:none;stroke:var(--teal);stroke-width:4;stroke-linecap:round;stroke-dasharray:251.3;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear,stroke 0.4s;}
#speech-lab-page .sl-btn-row{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;}
#speech-lab-page .sl-start{background:var(--teal);color:var(--bg);border:none;padding:0.85rem 2.5rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:0.95rem;cursor:pointer;transition:all 0.3s;box-shadow:0 0 30px rgba(0,229,200,0.25);}
#speech-lab-page .sl-start:hover{box-shadow:0 0 50px rgba(0,229,200,0.45);transform:translateY(-2px);}
#speech-lab-page .sl-start:disabled{opacity:0.45;cursor:not-allowed;transform:none;box-shadow:none;}
#speech-lab-page .sl-reset{background:transparent;color:var(--muted);border:1px solid var(--cbord);padding:0.85rem 2rem;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:0.9rem;cursor:pointer;transition:all 0.3s;}
#speech-lab-page .sl-reset:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}
#speech-lab-page .sl-result-bar{width:100%;background:var(--cb);border:1px solid var(--cbord);border-radius:14px;padding:1.5rem 1.75rem;display:none;flex-direction:column;gap:0.75rem;}
#speech-lab-page .sl-result-bar.show{display:flex;}
#speech-lab-page .sl-result-row{display:flex;justify-content:space-between;align-items:center;}
#speech-lab-page .sl-result-lbl{color:var(--muted);font-size:0.9rem;}
#speech-lab-page .sl-result-val{font-family:'Space Mono',monospace;font-weight:600;font-size:0.9rem;}
#speech-lab-page .sl-result-val.good{color:var(--teal);}
#speech-lab-page .sl-result-val.warn{color:var(--yellow);}
#speech-lab-page .sl-result-val.bad{color:var(--red);}
#speech-lab-page .sl-back{position:fixed;top:1.5rem;left:1.5rem;background:transparent;border:1px solid var(--cbord);color:var(--muted);padding:0.45rem 1.1rem;border-radius:100px;font-family:'Space Mono',monospace;font-size:0.65rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.3s;z-index:10;}
#speech-lab-page .sl-back:hover{border-color:rgba(255,255,255,0.2);color:var(--text);}
#speech-lab-page .sl-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);display:inline-block;margin-right:0.4rem;transition:background 0.3s;}
#speech-lab-page .sl-dot.recording{background:var(--red);animation:blink 1s ease-in-out infinite;}
#speech-lab-page .sl-dot.done{background:var(--teal);}
#speech-lab-page .sl-transcript{width:100%;background:rgba(0,229,200,0.03);border:1px solid rgba(0,229,200,0.1);border-radius:12px;padding:1rem 1.25rem;font-family:'Space Mono',monospace;font-size:0.75rem;color:var(--muted);line-height:1.8;min-height:3.5rem;display:none;}
#speech-lab-page .sl-transcript.show{display:block;}
#speech-lab-page .sl-teal{color:var(--teal);}
#speech-lab-page .sl-buckets{width:100%;display:flex;gap:4px;align-items:flex-end;height:44px;}
#speech-lab-page .sl-bucket-bar{flex:1;background:rgba(168,85,247,0.45);border-radius:3px 3px 0 0;min-height:4px;transition:height 0.3s;}
#speech-lab-page .sl-bucket-bar.spike{background:rgba(239,68,68,0.75);}
</style>

<button class="sl-back" onclick="closeSpeechLab()">&#8592; Back</button>

<div class="sl-wrap">
  <div class="sl-eyebrow">&#x1F52C; Dev Tool &nbsp;&middot;&nbsp; Speech Lab</div>
  <h1 class="sl-title">Speech <em>isolation</em><br>test</h1>

  <div class="sl-passage-box">
    <div class="sl-passage-label">Read aloud at your natural pace</div>
    <div class="sl-passage-text" id="sl-passage-text"></div>
  </div>

  <div class="sl-metrics">
    <div class="sl-metric">
      <svg width="56" height="56" viewBox="0 0 84 84" style="transform:rotate(-90deg);display:block;margin:0 auto 0.3rem;">
        <circle class="sl-timer-track" cx="42" cy="42" r="40"/>
        <circle class="sl-timer-fill" id="sl-timer-fill" cx="42" cy="42" r="40"/>
      </svg>
      <div class="sl-metric-val" id="sl-timer-val" style="font-size:1.5rem;">20</div>
      <div class="sl-metric-lbl">Seconds</div>
    </div>
    <div class="sl-metric">
      <div class="sl-metric-val" id="sl-wpm-val">&#x2014;</div>
      <div class="sl-metric-lbl">Live WPM</div>
    </div>
    <div class="sl-metric">
      <div class="sl-metric-val" id="sl-words-val">0</div>
      <div class="sl-metric-lbl">Words</div>
    </div>
  </div>

  <div style="width:100%;">
    <div style="font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:0.5rem;">WPM rhythm (1s buckets)</div>
    <div class="sl-buckets" id="sl-buckets"><div style="font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--muted);align-self:center;">Start speaking to see rhythm&hellip;</div></div>
  </div>

  <div class="sl-btn-row">
    <button class="sl-start" id="sl-start-btn" onclick="slStart()">&#9654; &nbsp;Start</button>
    <button class="sl-reset" id="sl-reset-btn" onclick="slReset()" style="display:none;">&#8635; Reset</button>
  </div>
  <div style="font-family:'Space Mono',monospace;font-size:0.68rem;letter-spacing:0.1em;color:var(--muted);text-align:center;">
    <span class="sl-dot" id="sl-dot"></span><span id="sl-status-txt">Ready</span>
  </div>

  <div class="sl-transcript" id="sl-transcript"><span class="sl-teal">Heard: </span><span id="sl-transcript-inner">&hellip;</span></div>

  <div class="sl-result-bar" id="sl-result-bar">
    <div style="font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:0.25rem;">Results</div>
    <div class="sl-result-row"><span class="sl-result-lbl">Overall WPM</span><span class="sl-result-val" id="sl-res-wpm">&#x2014;</span></div>
    <div class="sl-result-row"><span class="sl-result-lbl">Pause Ratio</span><span class="sl-result-val" id="sl-res-pause">&#x2014;</span></div>
    <div class="sl-result-row"><span class="sl-result-lbl">Rhythm Spike</span><span class="sl-result-val" id="sl-res-spike">&#x2014;</span></div>
    <div class="sl-result-row"><span class="sl-result-lbl">Words Detected</span><span class="sl-result-val" id="sl-res-words">&#x2014;</span></div>
    <div class="sl-result-row"><span class="sl-result-lbl">Passage Coverage</span><span class="sl-result-val" id="sl-res-coverage">&#x2014;</span></div>
  </div>
</div>
</div>

<script>
const SL_DUR = 20;
let _slTimeLeft = SL_DUR;
let _slRunning = false;
let _slTimer = null;
let _slWpmInterval = null;
let _slSRRef = null;
let _slBuckets = [];

function openSpeechLab(){
  document.getElementById('speech-lab-page').style.display = 'block';
  document.body.style.overflow = 'hidden';
  slReset();
}

function closeSpeechLab(){
  if(_slRunning) slStop();
  document.getElementById('speech-lab-page').style.display = 'none';
  document.body.style.overflow = '';
  window.location.hash = '';
}

function slRenderPassage(){
  const el = document.getElementById('sl-passage-text');
  el.innerHTML = SPEECH_PASSAGE.trim().split(/\s+/).map((w,i) =>
    '<span class="sl-word" id="sl-w-'+i+'">'+w+' </span>'
  ).join('');
}

function slHighlightWords(spoken){
  const pw = SPEECH_PASSAGE.trim().split(/\s+/);
  const sc = spoken.map(w=>w.toLowerCase().replace(/[^a-z]/g,''));
  let mi=0;
  for(let i=0;i<pw.length;i++){
    const p=pw[i].toLowerCase().replace(/[^a-z]/g,'');
    const el=document.getElementById('sl-w-'+i);
    if(!el)continue;
    if(mi<sc.length&&sc[mi]===p){el.className='sl-word spoken';mi++;}
    else if(mi<sc.length){el.className='sl-word current';break;}
    else{el.className='sl-word';}
  }
}

function slUpdateRing(t){
  const fill=document.getElementById('sl-timer-fill');
  const circ=251.3;
  fill.style.strokeDashoffset=circ*(t/SL_DUR);
  fill.style.stroke=t>8?'var(--teal)':t>4?'var(--yellow)':'var(--red)';
}

function slRenderBuckets(){
  const el=document.getElementById('sl-buckets');
  if(!_slBuckets.length){
    el.innerHTML='<div style="font-family:Space Mono,monospace;font-size:0.65rem;color:var(--muted);align-self:center;">Start speaking to see rhythm\u2026</div>';
    return;
  }
  const max=Math.max(..._slBuckets,1);
  const sorted=[..._slBuckets].sort((a,b)=>a-b);
  const median=sorted[Math.floor(sorted.length/2)];
  el.innerHTML=_slBuckets.map(b=>{
    const h=Math.max(8,Math.round((b/max)*38));
    const isSpike=median>0&&Math.abs(b-median)/median>0.4;
    return '<div class="sl-bucket-bar'+(isSpike?' spike':'')+'" style="height:'+h+'px;" title="'+b+' wpm"></div>';
  }).join('');
}

async function slStart(){
  if(_slRunning)return;
  _slRunning=true;
  _slTimeLeft=SL_DUR;
  _slBuckets=[];
  _spokenWords=[];
  _speakStartTime=performance.now();
  _wpmBuckets=[];
  _bucketStartTime=performance.now();
  _bucketWordCount=0;
  _wpmSpike=false;

  slRenderPassage();
  slRenderBuckets();
  slUpdateRing(SL_DUR);

  const btn=document.getElementById('sl-start-btn');
  btn.disabled=true;
  btn.textContent='\uD83C\uDF99 Recording\u2026';
  document.getElementById('sl-reset-btn').style.display='inline-block';
  document.getElementById('sl-dot').className='sl-dot recording';
  document.getElementById('sl-status-txt').textContent='Listening\u2026';
  document.getElementById('sl-transcript').className='sl-transcript show';
  document.getElementById('sl-result-bar').className='sl-result-bar';

  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(SR){
    _slSRRef=new SR();
    _slSRRef.continuous=true;
    _slSRRef.interimResults=true;
    _slSRRef.lang='en-US';
    _slSRRef.onresult=(e)=>{
      let interim='';
      for(let i=e.resultIndex;i<e.results.length;i++){
        if(e.results[i].isFinal){
          const words=e.results[i][0].transcript.trim().split(/\s+/).filter(Boolean);
          _spokenWords.push(...words);
          _bucketWordCount+=words.length;
        } else { interim+=e.results[i][0].transcript; }
      }
      document.getElementById('sl-transcript-inner').textContent=[..._spokenWords,...(interim?[interim]:[])].join(' ')||'\u2026';
      document.getElementById('sl-words-val').textContent=_spokenWords.length;
      // Use both finalized words + interim words for smooth per-word highlighting
      const interimWords=interim.trim().split(/\s+/).filter(Boolean);
      slHighlightWords([..._spokenWords,...interimWords]);
      if(_spokenWords.length>=SPEECH_WORD_COUNT&&_slRunning)_slTimeLeft=0;
    };
    _slSRRef.onerror=()=>{};
    try{_slSRRef.start();}catch(e){}
  }

  if(_bucketTimer)clearInterval(_bucketTimer);
  _bucketTimer=setInterval(()=>{_flushBucket();_slBuckets=[..._wpmBuckets];slRenderBuckets();},1000);

  _slWpmInterval=setInterval(()=>{
    const el=(performance.now()-_speakStartTime)/1000/60;
    const wpm=el>0&&_spokenWords.length>0?Math.round(_spokenWords.length/el):0;
    document.getElementById('sl-wpm-val').textContent=wpm>0?wpm:'\u2014';
  },500);

  document.getElementById('sl-timer-val').textContent=_slTimeLeft;
  _slTimer=setInterval(()=>{
    _slTimeLeft--;
    document.getElementById('sl-timer-val').textContent=Math.max(0,_slTimeLeft);
    slUpdateRing(Math.max(0,_slTimeLeft));
    if(_slTimeLeft<=0){clearInterval(_slTimer);_slTimer=null;slFinish();}
  },1000);
}

function slStop(){
  if(_slTimer){clearInterval(_slTimer);_slTimer=null;}
  if(_slWpmInterval){clearInterval(_slWpmInterval);_slWpmInterval=null;}
  if(_bucketTimer){clearInterval(_bucketTimer);_bucketTimer=null;}
  if(_slSRRef){try{_slSRRef.stop();}catch(e){}_slSRRef=null;}
  _slRunning=false;
}

function slFinish(){
  slStop();
  _flushBucket();
  _slBuckets=[..._wpmBuckets];
  slRenderBuckets();

  const btn=document.getElementById('sl-start-btn');
  btn.textContent='\u25B6 \u00a0Run again';
  btn.disabled=false;
  btn.onclick=()=>{slReset();slStart();};
  document.getElementById('sl-dot').className='sl-dot done';
  document.getElementById('sl-status-txt').textContent='Done';

  const elMin=(performance.now()-_speakStartTime)/1000/60;
  const wpm=elMin>0&&_spokenWords.length>0?Math.round(_spokenWords.length/elMin):0;
  const elSec=elMin*60;
  const estSpeakSec=_spokenWords.length/((wpm||1)/60);
  const pauseRatio=elSec>0?Math.max(0,1-estSpeakSec/elSec):0;

  if(_wpmBuckets.length>=2){
    const s=[..._wpmBuckets].sort((a,b)=>a-b);
    const med=s[Math.floor(s.length/2)];
    _wpmSpike=_wpmBuckets.some(b=>med>0&&Math.abs(b-med)/med>0.4);
  }
  const coverage=Math.min(100,Math.round(_spokenWords.length/SPEECH_WORD_COUNT*100));

  const wpmEl=document.getElementById('sl-res-wpm');
  wpmEl.textContent=wpm?wpm+' wpm':'n/a';
  wpmEl.className='sl-result-val '+(wpm>=80&&wpm<=180?'good':wpm>0?'warn':'bad');

  const pEl=document.getElementById('sl-res-pause');
  pEl.textContent=(pauseRatio*100).toFixed(0)+'%';
  pEl.className='sl-result-val '+(pauseRatio<0.35?'good':pauseRatio<0.5?'warn':'bad');

  const sEl=document.getElementById('sl-res-spike');
  sEl.textContent=_wpmSpike?'\u26A0 Spike detected':'\u2713 Steady';
  sEl.className='sl-result-val '+(_wpmSpike?'warn':'good');

  document.getElementById('sl-res-words').textContent=_spokenWords.length+' / '+SPEECH_WORD_COUNT;
  const cEl=document.getElementById('sl-res-coverage');
  cEl.textContent=coverage+'%';
  cEl.className='sl-result-val '+(coverage>=80?'good':coverage>=50?'warn':'bad');

  document.getElementById('sl-result-bar').className='sl-result-bar show';
}

function slReset(){
  slStop();
  _slTimeLeft=SL_DUR;
  _slBuckets=[];
  _spokenWords=[];
  slRenderPassage();
  slUpdateRing(SL_DUR);
  slRenderBuckets();
  document.getElementById('sl-timer-val').textContent=SL_DUR;
  document.getElementById('sl-wpm-val').textContent='\u2014';
  document.getElementById('sl-words-val').textContent='0';
  document.getElementById('sl-transcript-inner').textContent='\u2026';
  document.getElementById('sl-transcript').className='sl-transcript';
  document.getElementById('sl-result-bar').className='sl-result-bar';
  const btn=document.getElementById('sl-start-btn');
  btn.disabled=false;btn.textContent='\u25B6 \u00a0Start';btn.onclick=slStart;
  document.getElementById('sl-reset-btn').style.display='none';
  document.getElementById('sl-dot').className='sl-dot';
  document.getElementById('sl-status-txt').textContent='Ready';
}


/* ═══════════════════════════════════════════════════════════════════════
   BASELINE DRIFT INTELLIGENCE
   ─ baselineMath   : weighted Welford online mean/variance, linear slope
   ─ driftScoring   : per-metric z-score + trend slope → drift_total
   ─ baselineStore  : read/write DriftProfile to localStorage
   ─ driftUI        : render drift card, timeline sparklines, history chart
   ─ devMode        : simulate 15 sessions + inject drift pattern for demo
═══════════════════════════════════════════════════════════════════════ */

// ── CONFIG (tunable constants) ────────────────────────────────────────
const DRIFT_CFG = {
  ALPHA: 0.7,          // weight of absolute z-score in drift_metric
  BETA:  0.3,          // weight of trend z-slope in drift_metric
  TREND_N: 7,          // sessions used for slope regression
  MIN_SESSIONS_SCORE: 3, // below this: build phase, no escalation
  CONF_THRESHOLD: 0.6, // below this overall conf → LOW_CONFIDENCE_RETAKE
  THRESH_WATCH: 0.55,  // drift_total above this → Watch
  THRESH_CONCERN: 1.1, // drift_total above this → Concerning
  EPS: 1e-6,           // variance floor (avoid divide-by-zero)
  K_BOOTSTRAP: 3,      // sessions before switching from MAD→Welford variance
};

// ── baselineMath ──────────────────────────────────────────────────────

/**
 * Welford online weighted mean/variance update.
 * state: { mean, M2, wSum, n }
 *   M2    = sum of squared weighted deviations
 *   wSum  = sum of weights
 *   n     = count of samples seen
 */
function welfordUpdate(state, x, w) {
  if (!state) state = { mean: 0, M2: 0, wSum: 0, n: 0 };
  const { mean, M2, wSum, n } = state;
  const wSumNew = wSum + w;
  const delta   = x - mean;
  const meanNew = mean + (w / wSumNew) * delta;
  const delta2  = x - meanNew;
  const M2New   = M2 + w * delta * delta2;
  return { mean: meanNew, M2: M2New, wSum: wSumNew, n: n + 1 };
}

function welfordVariance(state) {
  if (!state || state.wSum <= 0 || state.n < 2) return DRIFT_CFG.EPS;
  // Reliability-weighted sample variance
  const nEff = state.n; // effective count = n (each sample counted once)
  const v    = (state.M2 / state.wSum) * (nEff / Math.max(nEff - 1, 1));
  return Math.max(v, DRIFT_CFG.EPS);
}

/**
 * During bootstrap (n < K_BOOTSTRAP) use conservative MAD-based variance
 * to avoid outlier-driven false escalation.
 */
function bootstrapVariance(samples) {
  if (!samples || samples.length < 2) return DRIFT_CFG.EPS;
  const sorted = [...samples].sort((a, b) => a - b);
  const med    = sorted[Math.floor(sorted.length / 2)];
  const mad    = sorted.map(v => Math.abs(v - med)).sort((a, b) => a - b);
  const madV   = mad[Math.floor(mad.length / 2)] || DRIFT_CFG.EPS;
  // MAD → std estimate: std ≈ 1.4826 * MAD; use conservative ×2
  return Math.max((1.4826 * madV * 2) ** 2, DRIFT_CFG.EPS);
}

/**
 * OLS slope of (index, value) pairs — simple linear regression.
 * Returns slope per session index unit.
 */
function linearSlope(values) {
  const n = values.length;
  if (n < 2) return 0;
  let sx = 0, sy = 0, sxy = 0, sxx = 0;
  for (let i = 0; i < n; i++) {
    sx  += i; sy  += values[i];
    sxy += i * values[i]; sxx += i * i;
  }
  const denom = n * sxx - sx * sx;
  if (Math.abs(denom) < 1e-12) return 0;
  return (n * sxy - sx * sy) / denom;
}

// ── baselineStore ─────────────────────────────────────────────────────
const DRIFT_STORE_KEY = 'sc_drift_profile';

/**
 * DriftProfile shape:
 * {
 *   face:   WelfordState,   // state for face asymmetry metric
 *   arms:   WelfordState,
 *   speech: WelfordState,
 *   rawSamples: { face: [], arms: [], speech: [] },  // last 20 raw values
 *   sessionCount: number,
 *   lastUpdated: ISO string
 * }
 */
function loadDriftProfile() {
  try {
    const raw = localStorage.getItem(DRIFT_STORE_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e) { return null; }
}

function saveDriftProfile(profile) {
  try { localStorage.setItem(DRIFT_STORE_KEY, JSON.stringify(profile)); }
  catch(e) { console.warn('drift profile save failed:', e); }
}

function getBaselineProfile() {
  return loadDriftProfile();
}

/**
 * Update drift profile with a new session.
 * session: { fa, ad, pr, quality }  (raw metric values + recording quality)
 * quality: 0–1 (used as Welford weight)
 */
function updateDriftProfile(session) {
  let profile = loadDriftProfile() || {
    face:   null, arms: null, speech: null,
    rawSamples: { face: [], arms: [], speech: [] },
    sessionCount: 0,
    lastUpdated: null
  };

  const w = Math.max(0.1, session.quality || 0.5); // quality as weight

  const metrics = {
    face:   parseFloat(session.fa)  || 0,
    arms:   parseFloat(session.ad)  || 0,
    speech: parseFloat(session.pr)  || 0
  };

  for (const key of ['face', 'arms', 'speech']) {
    profile[key] = welfordUpdate(profile[key], metrics[key], w);
    profile.rawSamples[key].unshift(metrics[key]);
    if (profile.rawSamples[key].length > 20) profile.rawSamples[key].pop();
  }

  profile.sessionCount++;
  profile.lastUpdated = new Date().toISOString();
  saveDriftProfile(profile);
  return profile;
}

// ── driftScoring ──────────────────────────────────────────────────────

/**
 * Compute drift for a single metric.
 * Returns { z, slope, drift_metric, trendDir }
 */
function computeMetricDrift(value, welfordState, rawSamples, sessionQuality) {
  if (!welfordState || welfordState.n < 1) {
    return { z: 0, slope: 0, drift_metric: 0, trendDir: 'flat' };
  }

  const mean = welfordState.mean;
  const n    = welfordState.n;

  // Choose variance source: bootstrap early on to be conservative
  const variance = n < DRIFT_CFG.K_BOOTSTRAP
    ? bootstrapVariance(rawSamples)
    : welfordVariance(welfordState);

  const z = (value - mean) / Math.sqrt(variance + DRIFT_CFG.EPS);

  // Trend: slope over last TREND_N sessions (oldest→newest)
  const window = [...rawSamples].slice(0, DRIFT_CFG.TREND_N).reverse();
  const slope  = linearSlope(window);

  // Normalize slope: divide by std to make it unit-free
  const std      = Math.sqrt(variance + DRIFT_CFG.EPS);
  const zSlope   = std > 0 ? slope / std : 0;

  // Weighted drift metric (confidence of this session factors in)
  const confW = Math.max(0.2, sessionQuality || 0.5);
  const drift_metric = confW * (DRIFT_CFG.ALPHA * Math.abs(z) + DRIFT_CFG.BETA * Math.abs(zSlope));

  const trendDir = Math.abs(zSlope) < 0.05 ? 'flat' : zSlope > 0 ? 'up' : 'down';

  return { z, slope, zSlope, drift_metric, trendDir };
}

/**
 * Compute full drift report for a session.
 * Returns the complete drift object to display.
 */
function computeDrift(session, profile) {
  if (!profile || profile.sessionCount < 1) {
    return { status: 'BUILDING', total: 0, face: null, arms: null, speech: null };
  }

  const quality = Math.max(0.2, session.quality || 0.5);

  const faceD   = computeMetricDrift(parseFloat(session.fa)  || 0, profile.face,   profile.rawSamples.face,   quality);
  const armsD   = computeMetricDrift(parseFloat(session.ad)  || 0, profile.arms,   profile.rawSamples.arms,   quality);
  const speechD = computeMetricDrift(parseFloat(session.pr)  || 0, profile.speech, profile.rawSamples.speech, quality);

  // Aggregate: face 35%, arms 35%, speech 30%
  const drift_total = faceD.drift_metric * 0.35
                    + armsD.drift_metric * 0.35
                    + speechD.drift_metric * 0.30;

  // Decision logic
  let status = 'STABLE';
  if (profile.sessionCount < DRIFT_CFG.MIN_SESSIONS_SCORE) {
    status = 'BUILDING';
  } else if (drift_total >= DRIFT_CFG.THRESH_CONCERN) {
    status = 'CONCERNING';
  } else if (drift_total >= DRIFT_CFG.THRESH_WATCH) {
    // Trend escalation: Watch + rising trend on 2+ domains → Concerning
    const risingCount = [faceD, armsD, speechD].filter(d => d.trendDir === 'up' && d.zSlope > 0.15).length;
    status = risingCount >= 2 ? 'CONCERNING' : 'WATCH';
  }

  // Build human-readable explanation
  const topMetrics = [
    { label: 'face symmetry', d: faceD },
    { label: 'arm stability', d: armsD },
    { label: 'speech rhythm', d: speechD }
  ].filter(m => Math.abs(m.d.z) > 0.4)
   .sort((a, b) => Math.abs(b.d.z) - Math.abs(a.d.z))
   .slice(0, 2);

  let explanation = '';
  if (status === 'BUILDING') {
    explanation = `<strong>Calibrating:</strong> ${profile.sessionCount} of ${DRIFT_CFG.MIN_SESSIONS_SCORE} sessions collected. Continue checking in to establish your personal drift baseline.`;
  } else if (status === 'STABLE') {
    explanation = '<strong>All clear:</strong> Today\'s signals are consistent with your personal history. No meaningful deviation detected.';
  } else {
    const parts = topMetrics.map(m => {
      const dir = m.d.z > 0 ? 'higher' : 'lower';
      const trend = m.d.trendDir === 'up' ? ' with a rising trend' : m.d.trendDir === 'down' ? ' with a declining trend' : '';
      return `${m.label} is ${Math.abs(m.d.z).toFixed(1)}σ ${dir} than your baseline${trend}`;
    });
    explanation = `<strong>${status === 'CONCERNING' ? 'Notable deviation:' : 'Mild variation:'}</strong> ${parts.join('; ') || 'signals outside typical range'}. This is a personal comparison, not a medical diagnosis. Consider a retake or professional consultation if this pattern persists.`;
  }

  return {
    status, total: drift_total,
    face: faceD, arms: armsD, speech: speechD,
    explanation, sessionCount: profile.sessionCount
  };
}

// ── driftUI ───────────────────────────────────────────────────────────

function renderDriftCard(drift) {
  const card = document.getElementById('drift-card');
  if (!card) return;

  if (!drift || drift.status === 'BUILDING') {
    card.style.display = 'block';
    const n = drift ? drift.sessionCount : 0;
    document.getElementById('drift-explain').innerHTML =
      `<strong>Building baseline:</strong> ${n} of ${DRIFT_CFG.MIN_SESSIONS_SCORE} sessions collected. ` +
      `Drift intelligence activates after ${DRIFT_CFG.MIN_SESSIONS_SCORE} check-ins.`;
    document.getElementById('drift-status-pill').className = 'drift-status-pill stable';
    document.getElementById('drift-status-pill').textContent = 'Calibrating';
    ['face','arms','speech'].forEach(k => {
      const zEl = document.getElementById('drift-z-' + k);
      const tEl = document.getElementById('drift-trend-' + k);
      if (zEl) zEl.textContent = '—';
      if (tEl) tEl.innerHTML = '<span class="drift-trend-flat">—</span>';
    });
    renderDriftTimeline('drift-timeline-svg', [], 460, 60);
    return;
  }

  card.style.display = 'block';

  // Status pill
  const pill = document.getElementById('drift-status-pill');
  const statusMap = { STABLE: ['stable','Stable'], WATCH: ['watch','Watch'], CONCERNING: ['concerning','Concerning'] };
  const [cls, lbl] = statusMap[drift.status] || ['stable','Stable'];
  pill.className = 'drift-status-pill ' + cls;
  pill.textContent = lbl;

  // Per-domain z-scores and trend indicators
  const domainData = { face: drift.face, arms: drift.arms, speech: drift.speech };
  for (const [key, d] of Object.entries(domainData)) {
    const zEl = document.getElementById('drift-z-' + key);
    const tEl = document.getElementById('drift-trend-' + key);
    if (!d) { if(zEl) zEl.textContent = '—'; continue; }
    const z = d.z;
    const zStr = (z >= 0 ? '+' : '') + z.toFixed(2) + 'σ';
    if (zEl) {
      zEl.textContent = zStr;
      zEl.style.color = Math.abs(z) < 0.5 ? 'var(--green)' : Math.abs(z) < 1.2 ? 'var(--yellow)' : 'var(--red)';
    }
    if (tEl) {
      const slopeStr = Math.abs(d.zSlope) < 0.05 ? '→ flat' :
                       d.trendDir === 'up' ? '↑ rising' : '↓ falling';
      const cls2 = d.trendDir === 'up' ? 'drift-trend-up' : d.trendDir === 'down' ? 'drift-trend-down' : 'drift-trend-flat';
      tEl.innerHTML = `<span class="${cls2}">${slopeStr}</span>`;
    }
  }

  // Timeline sparkline
  const driftHistory = buildDriftHistory();
  renderDriftTimeline('drift-timeline-svg', driftHistory, 460, 60);

  // Explanation
  const explEl = document.getElementById('drift-explain');
  if (explEl) explEl.innerHTML = drift.explanation || '';
}

/**
 * Build array of { date, total, status } for drift history sparkline
 * by retrospectively scoring each session against the profile at that time.
 * Simplified: use stored drift scores if available, else compute from hist.
 */
function buildDriftHistory() {
  // Load stored drift scores (appended on each saveAndHistory)
  try {
    const raw = localStorage.getItem('sc_drift_scores');
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return [];
}

/**
 * Render a drift timeline sparkline into an SVG element.
 * points: [{ total: number, status: string }]  (oldest→newest)
 */
function renderDriftTimeline(svgId, points, W, H) {
  const svg = document.getElementById(svgId);
  if (!svg) return;
  svg.innerHTML = '';
  const ns = 'http://www.w3.org/2000/svg';

  if (!points || points.length < 2) {
    const t = document.createElementNS(ns, 'text');
    t.setAttribute('x', W / 2); t.setAttribute('y', H / 2 + 5);
    t.setAttribute('text-anchor', 'middle');
    t.setAttribute('font-family', 'Space Mono,monospace');
    t.setAttribute('font-size', '10');
    t.setAttribute('fill', 'rgba(107,114,128,0.6)');
    t.textContent = 'Not enough data yet';
    svg.appendChild(t);
    return;
  }

  const PAD = 8;
  const vals = points.map(p => p.total);
  const maxV = Math.max(...vals, DRIFT_CFG.THRESH_CONCERN * 1.1, 0.1);

  function toX(i) { return PAD + (i / (points.length - 1)) * (W - PAD * 2); }
  function toY(v) { return H - PAD - (v / maxV) * (H - PAD * 2); }

  // Watch threshold line
  const watchY = toY(DRIFT_CFG.THRESH_WATCH);
  const threshLine = document.createElementNS(ns, 'line');
  threshLine.setAttribute('x1', PAD); threshLine.setAttribute('x2', W - PAD);
  threshLine.setAttribute('y1', watchY); threshLine.setAttribute('y2', watchY);
  threshLine.setAttribute('stroke', 'rgba(245,158,11,0.25)');
  threshLine.setAttribute('stroke-width', '1');
  threshLine.setAttribute('stroke-dasharray', '4,4');
  svg.appendChild(threshLine);

  // Baseline mean line at y=0 (z=0 → total≈0)
  const baseY = toY(0);
  const baseLine = document.createElementNS(ns, 'line');
  baseLine.setAttribute('x1', PAD); baseLine.setAttribute('x2', W - PAD);
  baseLine.setAttribute('y1', baseY); baseLine.setAttribute('y2', baseY);
  baseLine.setAttribute('stroke', 'rgba(0,229,200,0.2)');
  baseLine.setAttribute('stroke-width', '1');
  svg.appendChild(baseLine);

  // Area fill
  const pts = points.map((p, i) => [toX(i), toY(p.total)]);
  if (pts.length >= 2) {
    let d = `M${pts[0][0]},${pts[0][1]}`;
    for (let i = 1; i < pts.length; i++) d += ` L${pts[i][0]},${pts[i][1]}`;
    const closeD = d + ` L${pts[pts.length-1][0]},${H-PAD} L${pts[0][0]},${H-PAD} Z`;
    const fill = document.createElementNS(ns, 'path');
    fill.setAttribute('d', closeD);
    fill.setAttribute('fill', 'url(#drift-area-grad)');
    fill.setAttribute('opacity', '0.4');
    const defs = document.createElementNS(ns, 'defs');
    const grad = document.createElementNS(ns, 'linearGradient');
    grad.setAttribute('id', 'drift-area-grad'); grad.setAttribute('x1','0'); grad.setAttribute('x2','0'); grad.setAttribute('y1','0'); grad.setAttribute('y2','1');
    const s1 = document.createElementNS(ns, 'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#3b82f6'); s1.setAttribute('stop-opacity','0.4');
    const s2 = document.createElementNS(ns, 'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#3b82f6'); s2.setAttribute('stop-opacity','0');
    grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.appendChild(defs);
    svg.appendChild(fill);
    // Line
    const line = document.createElementNS(ns, 'path');
    line.setAttribute('d', d);
    line.setAttribute('fill', 'none');
    line.setAttribute('stroke', '#3b82f6');
    line.setAttribute('stroke-width', '2');
    line.setAttribute('stroke-linecap', 'round');
    line.setAttribute('stroke-linejoin', 'round');
    svg.appendChild(line);
  }

  // Dots
  points.forEach((p, i) => {
    const isLast = i === points.length - 1;
    const col = p.status === 'CONCERNING' ? '#ef4444' : p.status === 'WATCH' ? '#f59e0b' : '#22c55e';
    const c = document.createElementNS(ns, 'circle');
    c.setAttribute('cx', toX(i)); c.setAttribute('cy', toY(p.total));
    c.setAttribute('r', isLast ? 5 : 3);
    c.setAttribute('fill', col);
    if (isLast) c.setAttribute('filter', `drop-shadow(0 0 4px ${col})`);
    svg.appendChild(c);
  });
}

// renderHistDriftTimeline removed

// ── Integration: hook into existing saveAndHistory ────────────────────

/** Called during endRec (after computing scores) to update drift profile and score. */
function integrateWithDrift(session) {
  const profile = updateDriftProfile(session);
  const drift   = computeDrift(session, profile);

  // Store drift score for sparkline history
  let driftScores = [];
  try { driftScores = JSON.parse(localStorage.getItem('sc_drift_scores') || '[]'); } catch(e) {}
  driftScores.unshift({ total: drift.total, status: drift.status, date: new Date().toISOString() });
  if (driftScores.length > 50) driftScores.pop();
  try { localStorage.setItem('sc_drift_scores', JSON.stringify(driftScores)); } catch(e) {}

  return { profile, drift };
}

// ── exportSummaryJSON ─────────────────────────────────────────────────
function exportDriftSummary() {
  const profile = loadDriftProfile();
  const driftScores = (() => { try { return JSON.parse(localStorage.getItem('sc_drift_scores') || '[]'); } catch(e) { return []; } })();
  const summary = {
    exportedAt: new Date().toISOString(),
    sessionCount: profile ? profile.sessionCount : 0,
    baselineMeans: profile ? {
      face:   profile.face   ? +profile.face.mean.toFixed(5)   : null,
      arms:   profile.arms   ? +profile.arms.mean.toFixed(5)   : null,
      speech: profile.speech ? +profile.speech.mean.toFixed(5) : null
    } : null,
    driftHistory: driftScores.map(d => ({
      date: d.date, total: +d.total.toFixed(3), status: d.status
    })),
    note: 'All data is stored locally. This export contains only metrics and timestamps — no video or personal identifiers.'
  };
  const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'baseline-drift-summary.json'; a.click();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

// ── DEV MODE: simulate 15 sessions then inject drift pattern ──────────
function runDriftSimulation() {
  // Clear existing drift data
  localStorage.removeItem(DRIFT_STORE_KEY);
  localStorage.removeItem('sc_drift_scores');

  const sessions = [];
  // 10 normal sessions: baseline-like values with realistic noise
  for (let i = 0; i < 10; i++) {
    sessions.push({
      fa:      +(0.035 + (Math.random() - 0.5) * 0.012).toFixed(4),
      ad:      +(3.2   + (Math.random() - 0.5) * 1.0  ).toFixed(2),
      pr:      +(0.18  + (Math.random() - 0.5) * 0.04 ).toFixed(3),
      quality: +(0.82  + (Math.random() - 0.5) * 0.1  ).toFixed(2)
    });
  }
  // 5 drift sessions: speech latency rising + mild facial asymmetry
  for (let i = 0; i < 5; i++) {
    const t = (i + 1) / 5; // 0.2 → 1.0 drift progression
    sessions.push({
      fa:      +(0.035 + t * 0.042 + (Math.random() - 0.5) * 0.008).toFixed(4),
      ad:      +(3.2   + (Math.random() - 0.5) * 1.0              ).toFixed(2),
      pr:      +(0.18  + t * 0.22  + (Math.random() - 0.5) * 0.03 ).toFixed(3),
      quality: +(0.80  + (Math.random() - 0.5) * 0.1              ).toFixed(2)
    });
  }

  // Feed sessions through profile update and score storage
  let profile = null;
  for (const s of sessions) {
    profile = updateDriftProfile(s);
    const drift = computeDrift(s, profile);
    let scores = [];
    try { scores = JSON.parse(localStorage.getItem('sc_drift_scores') || '[]'); } catch(e) {}
    scores.unshift({ total: drift.total, status: drift.status, date: new Date().toISOString() });
    localStorage.setItem('sc_drift_scores', JSON.stringify(scores));
  }

  alert('✅ Simulation complete — 15 sessions injected (10 normal + 5 drifting). Reload the history screen to see the drift timeline.');
}

// ── Wire into existing endRec flow ────────────────────────────────────
// Patch saveAndHistory to also call integrateWithDrift
const _origSaveAndHistory = saveAndHistory;
saveAndHistory = function() {
  // Run drift integration if we have a valid result
  if (_res && !_res.isBaseline) {
    const driftSession = {
      fa:      _res.fa,
      ad:      _res.ad,
      pr:      _res.pr,
      quality: _qualityScore
    };
    const { drift } = integrateWithDrift(driftSession);
    // Render drift card with computed drift
    renderDriftCard(drift);
  }
  _origSaveAndHistory();
  // After history renders, also update drift timeline
};

// Patch endRec to show drift card on results screen
const _origEndRec_drift = typeof endRec === 'function' ? endRec : null;
// Hook into the results render path instead — after endRec populates _res
// We do this by overriding the display path in showScreen
const _origShowScreen = showScreen;
showScreen = function(name) {
  _origShowScreen(name);
  if (name === 'results' || name === 'history') {
    const profile = loadDriftProfile();
    if (name === 'results' && _res && !_res.isBaseline && profile) {
      const drift = computeDrift({
        fa: _res.fa, ad: _res.ad, pr: _res.pr, quality: _qualityScore
      }, profile);
      renderDriftCard(drift);
    } else if (name === 'results') {
      // Show building state
      renderDriftCard({ status: 'BUILDING', sessionCount: profile ? profile.sessionCount : 0 });
    }
    if (name === 'history') {
        }
  }
};

// Expose public API
window.BaselineDrift = {
  addSession:       updateDriftProfile,
  getBaselineProfile,
  computeDrift,
  updateBaseline:   updateDriftProfile,
  getHistory:       buildDriftHistory,
  exportSummary:    exportDriftSummary,
  runSimulation:    runDriftSimulation,
  renderDriftCard,
};

// On load: bootstrap drift profile from existing sc_hist if profile is absent or stale
function bootstrapDriftFromHistory() {
  const existing = loadDriftProfile();
  const histRaw = (() => { try { return JSON.parse(localStorage.getItem('sc_hist') || '[]'); } catch(e) { return []; } })();
  const qualityArr = (() => { try { return JSON.parse(localStorage.getItem('sc_quality_scores') || '[]'); } catch(e) { return []; } })();

  // Only rebuild if we have history entries that aren't yet reflected in the profile.
  // We consider the profile stale if sessionCount < hist.length (new entries added before
  // the drift module existed, or after a profile reset).
  const needsRebuild = !existing || existing.sessionCount < histRaw.length;

  if (!needsRebuild || histRaw.length === 0) {
    if (existing) renderDriftCard({ status: 'BUILDING', sessionCount: existing.sessionCount });
    return;
  }

  // Clear stale profile and drift scores so we rebuild cleanly
  localStorage.removeItem(DRIFT_STORE_KEY);
  localStorage.removeItem('sc_drift_scores');

  // hist is stored newest-first; process oldest-first so Welford builds naturally
  const ordered = [...histRaw].reverse();

  ordered.forEach((h, i) => {
    // Match quality score: qualityArr is also newest-first, so index from end
    const qIdx = histRaw.length - 1 - i;
    const quality = qualityArr[qIdx] != null ? qualityArr[qIdx] : 0.72; // sensible default

    const session = {
      fa:      parseFloat(h.fRaw != null ? h.fRaw : h.f) || 0,
      ad:      parseFloat(h.aRaw != null ? h.aRaw : h.a) || 0,
      pr:      parseFloat(h.sRaw != null ? h.sRaw : h.s) || 0,
      quality
    };

    const profile = updateDriftProfile(session);
    const drift   = computeDrift(session, profile);

    // Append drift score to history (oldest-first so unshift reversal matches)
    let scores = [];
    try { scores = JSON.parse(localStorage.getItem('sc_drift_scores') || '[]'); } catch(e) {}
    // Use the entry's date if available for sparkline labels
    scores.push({ total: drift.total, status: drift.status, date: h.date || new Date().toISOString() });
    try { localStorage.setItem('sc_drift_scores', JSON.stringify(scores)); } catch(e) {}
  });

  // Reverse scores to newest-first (matches buildDriftHistory convention)
  let scores = [];
  try { scores = JSON.parse(localStorage.getItem('sc_drift_scores') || '[]'); } catch(e) {}
  scores.reverse();
  try { localStorage.setItem('sc_drift_scores', JSON.stringify(scores)); } catch(e) {}

  console.log(`[Drift] Bootstrapped from ${ordered.length} existing sessions.`);
}

window.bootstrapDriftFromHistory = bootstrapDriftFromHistory;
bootstrapDriftFromHistory();

window.addEventListener('hashchange',()=>{
  if(window.location.hash==='#speech-lab')openSpeechLab();
  else if(document.getElementById('speech-lab-page').style.display!=='none')closeSpeechLab();
});
if(window.location.hash==='#speech-lab')openSpeechLab();

/* ══════════════════════════════════════════════════════════
   SETTINGS
   ══════════════════════════════════════════════════════════ */

var _cfg = (function(){
  try{ return JSON.parse(localStorage.getItem('bl_cfg')||'{}'); }catch(e){ return {}; }
})();

function _saveCfg(){ try{ localStorage.setItem('bl_cfg', JSON.stringify(_cfg)); }catch(e){} }

// ── Open / Close ─────────────────────────────────────────────
function goSettings(){
  var overlay = document.getElementById('settings-overlay');
  overlay.style.display = 'block';
  overlay.style.animation = 'appIn 0.4s cubic-bezier(0.16,1,0.3,1) forwards';
  document.body.style.overflow = 'hidden';
  _loadSettingsUI();
}
function closeSettings(){
  var overlay = document.getElementById('settings-overlay');
  overlay.style.animation = 'appOut 0.35s ease forwards';
  setTimeout(function(){ overlay.style.display='none'; overlay.style.animation=''; document.body.style.overflow=''; }, 330);
}

// ── Color scheme ─────────────────────────────────────────────
var SCHEMES = {
  dark:     { '--bg':'#06080f', '--surface':'#0d1220', '--text':'#e8eaf0', '--muted':'#6b7280', '--cb':'rgba(255,255,255,0.03)', '--cbord':'rgba(255,255,255,0.07)' },
  midnight: { '--bg':'#07071a', '--surface':'#0e0e2c', '--text':'#dde0ff', '--muted':'#7070a8', '--cb':'rgba(120,120,255,0.04)', '--cbord':'rgba(120,120,255,0.09)' },
  light:    { '--bg':'#f0f4f8', '--surface':'#ffffff',  '--text':'#1a202c', '--muted':'#718096', '--cb':'rgba(0,0,0,0.03)',        '--cbord':'rgba(0,0,0,0.09)' },
  warm:     { '--bg':'#0f0c07', '--surface':'#1a1508', '--text':'#f0e8d8', '--muted':'#9a8a70', '--cb':'rgba(255,210,120,0.03)', '--cbord':'rgba(255,210,120,0.08)' }
};
function applyScheme(name){
  var s = SCHEMES[name]; if(!s) return;
  var r = document.documentElement;
  Object.keys(s).forEach(function(k){ r.style.setProperty(k, s[k]); });
  _cfg.scheme = name;
  ['dark','midnight','light','warm'].forEach(function(id){
    var el = document.getElementById('sc-'+id);
    if(el) el.classList.toggle('active', id === name);
  });
}

// ── Accent color ─────────────────────────────────────────────
var ACCENT_IDS = { '#00e5c8':'teal','#a855f7':'violet','#3b82f6':'blue','#22c55e':'green','#f59e0b':'amber','#ef4444':'red','#ec4899':'pink' };
function applyAccent(color){
  document.documentElement.style.setProperty('--teal', color);
  _cfg.accent = color;
  Object.keys(ACCENT_IDS).forEach(function(c){
    var el = document.getElementById('ac-'+ACCENT_IDS[c]);
    if(el) el.classList.toggle('active', c === color);
  });
  _saveCfg();
}

// ── Dark / Light mode toggle ──────────────────────────────────
function applyThemeToggle(isLight){
  if(isLight){
    applyScheme('light');
  } else {
    applyScheme('dark');
  }
  // Update toggle thumb + track appearance
  var track=document.getElementById('theme-toggle-track');
  var thumb=document.getElementById('theme-toggle-thumb');
  var darkLbl=document.getElementById('theme-dark-label');
  var lightLbl=document.getElementById('theme-light-label');
  if(track){track.style.background=isLight?'rgba(0,229,200,0.25)':'rgba(255,255,255,0.08)';track.style.borderColor=isLight?'rgba(0,229,200,0.5)':'rgba(255,255,255,0.15)';}
  if(thumb){thumb.style.background=isLight?'var(--teal)':'var(--muted)';thumb.style.transform=isLight?'translateX(22px)':'translateX(0)';}
  if(darkLbl){darkLbl.style.color=isLight?'var(--muted)':'var(--text)';}
  if(lightLbl){lightLbl.style.color=isLight?'var(--text)':'var(--muted)';}
  _cfg.lightMode=isLight;
  _saveCfg();
}

// ── Font size ─────────────────────────────────────────────────
var _fz = 100;
function adjustFontSize(d){
  _fz = _fz + (d > 0 ? 5 : -5);
  if(_fz < 80) _fz = 80;
  if(_fz > 140) _fz = 140;
  document.documentElement.style.fontSize = _fz + '%';
  var el = document.getElementById('font-size-display');
  if(el) el.textContent = _fz + '%';
  _cfg.fontSize = _fz;
}

// ── Accessibility ─────────────────────────────────────────────
function applyReduceMotion(on){
  var id='_rm_style', el=document.getElementById(id);
  if(on && !el){ var s=document.createElement('style'); s.id=id; s.textContent='*,*::before,*::after{animation-duration:0.001s!important;transition-duration:0.001s!important;}'; document.head.appendChild(s); }
  else if(!on && el){ el.remove(); }
  _cfg.reduceMotion = on; _saveCfg();
}
function applyHighContrast(on){
  var id='_hc_style', el=document.getElementById(id);
  if(on && !el){ var s=document.createElement('style'); s.id=id; s.textContent=':root{--cbord:rgba(255,255,255,0.28)!important;--muted:#b8c0cc!important;}'; document.head.appendChild(s); }
  else if(!on && el){ el.remove(); }
  _cfg.highContrast = on; _saveCfg();
}
function applyDyslexiaFont(on){
  if(on){
    if(!document.getElementById('_od_link')){ var lk=document.createElement('link'); lk.id='_od_link'; lk.rel='stylesheet'; lk.href='https://fonts.cdnfonts.com/css/opendyslexic'; document.head.appendChild(lk); }
    if(!document.getElementById('_od_style')){ var s=document.createElement('style'); s.id='_od_style'; s.textContent="body,p,li,span,div,button{font-family:'OpenDyslexic',sans-serif!important;}"; document.head.appendChild(s); }
  } else {
    ['_od_link','_od_style'].forEach(function(id){ var el=document.getElementById(id); if(el) el.remove(); });
  }
  _cfg.dyslexia = on; _saveCfg();
}
function applyLargeTouchTargets(on){
  var id='_lt_style', el=document.getElementById(id);
  if(on && !el){ var s=document.createElement('style'); s.id=id; s.textContent='button,a,input,label{min-height:44px!important;min-width:44px!important;}'; document.head.appendChild(s); }
  else if(!on && el){ el.remove(); }
  _cfg.largeTouchTargets = on; _saveCfg();
}

// ── Load settings into UI ─────────────────────────────────────
function _loadSettingsUI(){
  // Accent
  var accent = _cfg.accent || '#00e5c8';
  Object.keys(ACCENT_IDS).forEach(function(c){
    var el = document.getElementById('ac-'+ACCENT_IDS[c]);
    if(el) el.classList.toggle('active', c === accent);
  });
  // Font size display
  var fd = document.getElementById('font-size-display');
  if(fd) fd.textContent = _fz + '%';
  // Toggles
  function setTog(id, val, fn){ var el=document.getElementById(id); if(el){ el.checked=!!val; if(val) fn(true); } }
  setTog('tog-motion',   _cfg.reduceMotion,     applyReduceMotion);
  setTog('tog-contrast', _cfg.highContrast,      applyHighContrast);
  setTog('tog-dyslexia', _cfg.dyslexia,          applyDyslexiaFont);
  setTog('tog-touch',    _cfg.largeTouchTargets, applyLargeTouchTargets);
  // Theme toggle
  var togTheme=document.getElementById('tog-theme');
  if(togTheme){ togTheme.checked=!!_cfg.lightMode; applyThemeToggle(!!_cfg.lightMode); }
  // Notif
  var togNotif = document.getElementById('tog-notif');
  if(togNotif) togNotif.checked = !!_cfg.notifEnabled;
  var notifOpts = document.getElementById('notif-options');
  if(notifOpts) notifOpts.style.display = _cfg.notifEnabled ? 'block' : 'none';
  if(_cfg.notifCount){ var nc=document.getElementById('notif-count'); if(nc) nc.value=_cfg.notifCount; }
  if(_cfg.notifStart){ var ns=document.getElementById('notif-start'); if(ns) ns.value=_cfg.notifStart; }
  if(_cfg.notifEnd)  { var ne=document.getElementById('notif-end');   if(ne) ne.value=_cfg.notifEnd; }
  updateNotifPreview();
  _updatePermStatus();
}

// ── Apply saved settings on page load ─────────────────────────
(function _applySaved(){
  if(_cfg.accent) applyAccent(_cfg.accent);
  if(_cfg.fontSize){ _fz=_cfg.fontSize; document.documentElement.style.fontSize=_fz+'%'; }
  if(_cfg.reduceMotion) applyReduceMotion(true);
  if(_cfg.highContrast) applyHighContrast(true);
  if(_cfg.dyslexia)     applyDyslexiaFont(true);
  if(_cfg.largeTouchTargets) applyLargeTouchTargets(true);
})();

// ── Save & Reset ─────────────────────────────────────────────
function saveSettings(){
  updateNotifPreview();
  _saveCfg();
  if(_cfg.notifEnabled) _scheduleNotifs();
  else _cancelNotifs();
  var btn = document.getElementById('save-settings-btn');
  if(btn){ var orig=btn.textContent; btn.textContent='✓ Saved!'; setTimeout(function(){ btn.textContent=orig; }, 1600); }
}
function resetSettings(){
  _cfg = {};
  try{ localStorage.removeItem('bl_cfg'); }catch(e){}
  document.documentElement.style.setProperty('--teal','#00e5c8');
  _fz = 100;
  document.documentElement.style.fontSize = '100%';
  ['_rm_style','_hc_style','_od_style','_od_link','_lt_style'].forEach(function(id){ var el=document.getElementById(id); if(el) el.remove(); });
  _cancelNotifs();
  _loadSettingsUI();
}

/* ══════════════════════════════════════════════════════════
   DEVICE NOTIFICATIONS (Web Notifications API)
   ══════════════════════════════════════════════════════════ */

var _notifTimers = [];

function _updatePermStatus(){
  var el = document.getElementById('notif-perm-status');
  if(!el) return;
  if(!('Notification' in window)){
    el.textContent = 'Notifications not supported in this browser.';
    var tog = document.getElementById('tog-notif'); if(tog) tog.disabled = true;
    return;
  }
  var p = Notification.permission;
  if(p === 'granted'){
    el.textContent = 'Permission granted — notifications will fire from this browser.';
    el.style.color = 'var(--teal)';
  } else if(p === 'denied'){
    el.textContent = 'Blocked — allow notifications in your browser site settings, then reload.';
    el.style.color = '#ef4444';
    var tog = document.getElementById('tog-notif'); if(tog){ tog.checked=false; tog.disabled=true; }
  } else {
    el.textContent = 'Permission not yet granted — toggle to enable or use the test button.';
    el.style.color = '';
  }
}

// Single shared helper: request permission if needed, then run callback
function _withNotifPermission(cb){
  if(!('Notification' in window)){ alert('Notifications are not supported in this browser.'); return; }
  if(Notification.permission === 'granted'){ cb(); return; }
  if(Notification.permission === 'denied'){
    alert('Notifications are blocked. Go to your browser\'s site settings, allow notifications for this page, then reload.');
    return;
  }
  Notification.requestPermission().then(function(perm){
    _updatePermStatus();
    if(perm === 'granted'){ cb(); }
    else { alert('Notification permission was not granted.'); }
  });
}

function handleNotifToggle(on){
  var opts = document.getElementById('notif-options');
  if(!on){
    _cancelNotifs();
    _cfg.notifEnabled = false;
    if(opts) opts.style.display = 'none';
    return;
  }
  _withNotifPermission(function(){
    _cfg.notifEnabled = true;
    if(opts) opts.style.display = 'block';
    var tog = document.getElementById('tog-notif'); if(tog) tog.checked = true;
  });
}

function updateNotifPreview(){
  var countEl = document.getElementById('notif-count');
  var startEl = document.getElementById('notif-start');
  var endEl   = document.getElementById('notif-end');
  if(!countEl) return;
  var count = parseInt(countEl.value, 10) || 3;
  var start = startEl ? startEl.value : '08:00';
  var end   = endEl   ? endEl.value   : '21:00';
  var lbl = document.getElementById('notif-count-lbl');
  if(lbl) lbl.textContent = count;
  _cfg.notifCount = count;
  _cfg.notifStart = start;
  _cfg.notifEnd   = end;
  var sh = parseInt(start.split(':')[0],10), sm = parseInt(start.split(':')[1]||0,10);
  var eh = parseInt(end.split(':')[0],10),   em = parseInt(end.split(':')[1]||0,10);
  var windowMins = (eh*60+em) - (sh*60+sm);
  var prev = document.getElementById('notif-preview');
  if(prev && windowMins > 0 && count > 0){
    var avgMins = Math.round(windowMins / count);
    var ah = Math.floor(avgMins/60), am = avgMins % 60;
    var avgStr = ah > 0 ? (ah+'h'+(am > 0 ? ' '+am+'m' : '')) : (am+'m');
    prev.innerHTML = '⏰ &nbsp;'+count+' reminder'+(count>1?'s':'')+' &middot; '+start+' – '+end+' &middot; ~'+avgStr+' apart on average';
  }
}

function _fireNotif(title, body, tag){
  try{
    var n = new Notification(title, {
      body: body,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="32" fill="%2306080f"/><text y="44" x="16" font-size="36">🧠</text></svg>',
      tag: tag || 'baseline-notif',
      requireInteraction: false
    });
    n.onclick = function(){ window.focus(); n.close(); openApp(); };
  } catch(e){ console.warn('Notification error:', e); }
}

function sendDemoNotif(){
  _withNotifPermission(function(){
    _fireNotif('Baseline — Check-In Reminder', 'Time for your 30-second FAST check. How are you feeling right now?', 'baseline-demo');
  });
}

function _scheduleNotifs(){
  _cancelNotifs();
  if(Notification.permission !== 'granted') return;
  var count = parseInt(_cfg.notifCount||3, 10);
  var start = _cfg.notifStart || '08:00';
  var end   = _cfg.notifEnd   || '21:00';
  var now = new Date();
  var sh=parseInt(start.split(':')[0],10), sm=parseInt(start.split(':')[1]||0,10);
  var eh=parseInt(end.split(':')[0],10),   em=parseInt(end.split(':')[1]||0,10);
  var startMs = new Date(now.getFullYear(),now.getMonth(),now.getDate(),sh,sm,0).getTime();
  var endMs   = new Date(now.getFullYear(),now.getMonth(),now.getDate(),eh,em,0).getTime();
  var nowMs   = now.getTime();
  var windowStart = Math.max(nowMs, startMs);
  var remaining = endMs - windowStart;
  if(remaining <= 0) return;
  var msgs = [
    ['Baseline — Check-In Reminder','Time for your 30-second FAST check. How are you feeling?'],
    ['Quick check — 30 seconds','Run your FAST screening and keep your streak going.'],
    ['Baseline Reminder','Regular check-ins help you notice changes early. Ready?'],
    ['Check in with yourself','Your baseline is waiting. One 30-second screening now.']
  ];
  var times = [];
  for(var i=0;i<count;i++) times.push(windowStart + Math.random()*remaining);
  times.sort(function(a,b){return a-b;});
  times.forEach(function(fireMs,idx){
    var delay = fireMs - nowMs;
    if(delay < 0) return;
    var m = msgs[Math.floor(Math.random()*msgs.length)];
    _notifTimers.push(setTimeout(function(){ _fireNotif(m[0],m[1],'baseline-'+idx); }, delay));
  });
}

function _cancelNotifs(){
  _notifTimers.forEach(function(t){ clearTimeout(t); });
  _notifTimers = [];
}

(function _initNotifs(){
  if(_cfg.notifEnabled && Notification.permission === 'granted') _scheduleNotifs();
})();
</script>
</body>
</html>
